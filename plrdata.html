<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analytics ‚Äî Mekhis Creations</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#3b82f6;
  --bg:#0a0e27;--bg2:#0f1428;--bg3:#141b2e;
  --text:#e5e7eb;--text-dim:#9ca3af;
  --accent:#10b981;--accent-alt:#f59e0b;--danger:#ef4444;
  --border:#1f2937;--border-light:#374151;
}
body{
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}
body::before{
  content:'';
  position:fixed;
  inset:0;
  background:radial-gradient(circle at 20% 50%, rgba(37,99,235,0.1) 0%, transparent 50%),
              radial-gradient(circle at 80% 80%, rgba(16,185,129,0.05) 0%, transparent 50%);
  pointer-events:none;
  z-index:0;
}
#lockScreen{
  position:fixed;
  inset:0;
  background:var(--bg);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
}
#lockScreen.gone{display:none;}
.lock-wrap{
  background:linear-gradient(135deg, var(--bg2), var(--bg3));
  border:1px solid var(--border-light);
  border-radius:20px;
  padding:50px 45px;
  width:420px;
  max-width:92vw;
  text-align:center;
  box-shadow:0 0 60px rgba(37,99,235,0.15),inset 0 1px 0 rgba(255,255,255,0.05);
  position:relative;
  z-index:1;
}
.lock-icon{font-size:3.5em;margin-bottom:20px;display:block;filter:drop-shadow(0 0 15px rgba(37,99,235,0.3));}
.lock-title{font-size:2em;color:#fff;margin-bottom:8px;font-weight:800;}
.lock-sub{font-size:0.9em;color:var(--text-dim);margin-bottom:32px;}
.lock-input{
  width:100%;
  padding:13px 16px;
  background:rgba(37,99,235,0.08);
  border:1px solid var(--border-light);
  border-radius:12px;
  color:#fff;
  font-family:'JetBrains Mono',monospace;
  font-size:1em;
  letter-spacing:3px;
  text-align:center;
  margin-bottom:14px;
  transition:all .2s;
}
.lock-input:focus{
  outline:none;
  border-color:var(--primary);
  background:rgba(37,99,235,0.12);
  box-shadow:0 0 0 3px rgba(37,99,235,0.1);
}
.lock-btn{
  width:100%;
  padding:13px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg, var(--primary), var(--primary-dark));
  color:#fff;
  font-family:'Poppins',sans-serif;
  font-size:1em;
  font-weight:700;
  cursor:pointer;
  transition:all .3s;
  box-shadow:0 4px 20px rgba(37,99,235,0.25);
}
.lock-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 30px rgba(37,99,235,0.4);
}
.lock-err{color:var(--danger);font-size:0.88em;margin-top:10px;min-height:18px;}
#app{display:none;position:relative;z-index:1;}
#app.on{display:block;padding:40px 30px;}
.container{max-width:1600px;margin:0 auto;}
.header{margin-bottom:50px;}
.header-title{font-size:3em;font-weight:800;background:linear-gradient(135deg, var(--primary-light), var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;}
.header-sub{color:var(--text-dim);font-size:0.95em;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:40px;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:40px;}
.card{
  background:linear-gradient(135deg, rgba(15,20,40,0.8), rgba(20,27,46,0.5));
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  backdrop-filter:blur(10px);
  transition:all .3s;
  position:relative;
  overflow:hidden;
}
.card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:1px;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
}
.card:hover{
  border-color:var(--border-light);
  box-shadow:0 8px 32px rgba(37,99,235,0.1);
  transform:translateY(-2px);
}
.metric-card{display:flex;flex-direction:column;}
.metric-label{font-size:0.85em;color:var(--text-dim);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:1px;}
.metric-value{font-size:2.5em;font-weight:800;color:#fff;margin-bottom:4px;}
.metric-sub{font-size:0.85em;color:var(--accent);font-weight:600;}
.metric-sub.danger{color:var(--danger);}
.metric-sub.neutral{color:var(--text-dim);}
.chart-container{position:relative;height:300px;margin-bottom:20px;}
.chart-title{font-size:1.2em;font-weight:700;margin-bottom:20px;color:#fff;}
.controls{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
.btn{
  padding:10px 18px;
  background:rgba(37,99,235,0.15);
  border:1px solid var(--border-light);
  border-radius:8px;
  color:var(--text);
  font-family:'Poppins',sans-serif;
  font-size:0.9em;
  cursor:pointer;
  transition:all .2s;
  font-weight:600;
}
.btn:hover{
  background:rgba(37,99,235,0.25);
  border-color:var(--primary);
}
.btn.active{
  background:var(--primary);
  border-color:var(--primary);
  color:#fff;
}
.stat-row{
  display:grid;
  grid-template-columns:1fr 1fr 1fr 1fr;
  gap:15px;
  margin-bottom:30px;
}
.stat-mini{
  background:rgba(37,99,235,0.08);
  border:1px solid rgba(37,99,235,0.2);
  border-radius:10px;
  padding:14px;
}
.stat-mini-label{font-size:0.75em;color:var(--text-dim);margin-bottom:6px;font-weight:600;}
.stat-mini-value{font-size:1.6em;font-weight:800;color:#fff;}
.stat-mini-change{font-size:0.8em;color:var(--accent);margin-top:4px;font-weight:600;}
.stat-mini-change.down{color:var(--danger);}
.grid-section{margin-bottom:50px;}
.section-title{font-size:1.4em;font-weight:800;margin-bottom:25px;color:#fff;padding-bottom:12px;border-bottom:2px solid var(--border);}
.heatmap{
  display:grid;
  grid-template-columns:repeat(24,1fr);
  gap:4px;
}
.heatmap-cell{
  aspect-ratio:1;
  border-radius:4px;
  background:rgba(37,99,235,0.1);
  border:1px solid var(--border);
  cursor:pointer;
  transition:all .2s;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:0.65em;
  font-weight:700;
}
.heatmap-cell:hover{
  transform:scale(1.1);
  z-index:10;
}
.heatmap-cell.high{
  background:linear-gradient(135deg, rgba(37,99,235,0.8), rgba(16,185,129,0.3));
  border-color:var(--primary);
}
.table{
  width:100%;
  border-collapse:collapse;
  font-size:0.9em;
}
.table thead{
  background:rgba(37,99,235,0.08);
}
.table th{
  padding:14px;
  text-align:left;
  color:var(--primary-light);
  font-weight:700;
  border-bottom:1px solid var(--border);
}
.table td{
  padding:12px 14px;
  border-bottom:1px solid rgba(37,99,235,0.05);
}
.table tbody tr:hover{
  background:rgba(37,99,235,0.04);
}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:6px;
  font-size:0.8em;
  font-weight:700;
}
.badge-accent{
  background:rgba(16,185,129,0.2);
  color:var(--accent);
  border:1px solid rgba(16,185,129,0.4);
}
.badge-danger{
  background:rgba(239,68,68,0.2);
  color:var(--danger);
  border:1px solid rgba(239,68,68,0.4);
}
.badge-primary{
  background:rgba(37,99,235,0.2);
  color:var(--primary-light);
  border:1px solid rgba(37,99,235,0.4);
}
@media(max-width:1200px){
  .grid-4{grid-template-columns:repeat(2,1fr);}
  .stat-row{grid-template-columns:1fr 1fr;}
}
@media(max-width:768px){
  .grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}
  .header-title{font-size:2em;}
  #app{padding:20px;}
}
</style>
</head>
<body>

<div id="lockScreen">
  <div class="lock-wrap">
    <span class="lock-icon">üìä</span>
    <div class="lock-title">Analytics Dashboard</div>
    <div class="lock-sub">Mekhis Creations ¬∑ Advanced Metrics</div>
    <input type="password" id="pwInput" class="lock-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')unlock()" autocomplete="off">
    <button class="lock-btn" onclick="unlock()">Access Analytics</button>
    <div class="lock-err" id="lockErr"></div>
  </div>
</div>

<div id="app">
<div class="container">

<div class="header">
  <div class="header-title">Analytics</div>
  <div class="header-sub">Comprehensive player & revenue metrics ‚Äî Updated in real-time</div>
</div>

<div class="grid-4">
  <div class="card metric-card">
    <div class="metric-label">Total Players</div>
    <div class="metric-value" id="metricTotalPlayers">‚Äî</div>
    <div class="metric-sub" id="metricPlayersChange">Loading...</div>
  </div>
  <div class="card metric-card">
    <div class="metric-label">Daily Active Users</div>
    <div class="metric-value" id="metricDAU">‚Äî</div>
    <div class="metric-sub" id="metricDAUChange">Loading...</div>
  </div>
  <div class="card metric-card">
    <div class="metric-label">Tutorial Completion</div>
    <div class="metric-value" id="metricTutorialPct">‚Äî</div>
    <div class="metric-sub" id="metricTutorialPlayers">Loading...</div>
  </div>
  <div class="card metric-card">
    <div class="metric-label">Avg Session Length</div>
    <div class="metric-value" id="metricAvgSession">‚Äî</div>
    <div class="metric-sub" id="metricAvgChange">Loading...</div>
  </div>
</div>

<div class="grid-section">
  <div class="section-title">Player Growth & Retention</div>
  <div class="grid-2">
    <div class="card">
      <div class="chart-title">New Players (7 Days)</div>
      <div class="chart-container">
        <canvas id="newPlayersChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="chart-title">Daily Active Users Trend</div>
      <div class="chart-container">
        <canvas id="dauTrendChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="grid-section">
  <div class="section-title">Progression & Engagement</div>
  <div class="grid-2">
    <div class="card">
      <div class="chart-title">Tutorial Completion Funnel</div>
      <div class="chart-container" style="height:250px;">
        <canvas id="funnelChart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="chart-title">Session Duration Distribution</div>
      <div class="chart-container" style="height:250px;">
        <canvas id="sessionDurationChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="grid-section">
  <div class="section-title">Activity Heatmap</div>
  <div class="card">
    <div style="font-size:0.85em;color:var(--text-dim);margin-bottom:20px;">Peak activity times (UTC) ‚Äî Darker = More players active</div>
    <div class="heatmap" id="heatmap"></div>
    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:20px;font-size:0.8em;">
      <div><span style="display:inline-block;width:12px;height:12px;background:rgba(37,99,235,0.1);border-radius:2px;margin-right:6px;"></span>Low</div>
      <div><span style="display:inline-block;width:12px;height:12px;background:rgba(37,99,235,0.3);border-radius:2px;margin-right:6px;"></span></div>
      <div><span style="display:inline-block;width:12px;height:12px;background:rgba(37,99,235,0.5);border-radius:2px;margin-right:6px;"></span></div>
      <div><span style="display:inline-block;width:12px;height:12px;background:rgba(37,99,235,0.7);border-radius:2px;margin-right:6px;"></span></div>
      <div><span style="display:inline-block;width:12px;height:12px;background:rgba(37,99,235,0.9);border-radius:2px;margin-right:6px;"></span>High</div>
      <div></div>
    </div>
  </div>
</div>

<div class="grid-section">
  <div class="section-title">Detailed Metrics</div>
  <div class="stat-row">
    <div class="stat-mini">
      <div class="stat-mini-label">Avg Playtime (All)</div>
      <div class="stat-mini-value" id="statAvgPlaytime">‚Äî</div>
      <div class="stat-mini-change" id="statPlaytimeChange">Loading...</div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-label">Return Rate (7d)</div>
      <div class="stat-mini-value" id="statReturnRate">‚Äî</div>
      <div class="stat-mini-change" id="statReturnChange">Loading...</div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-label">Players/Day (Avg)</div>
      <div class="stat-mini-value" id="statPlayersPerDay">‚Äî</div>
      <div class="stat-mini-change" id="statPlayersChange">Loading...</div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-label">Median Session</div>
      <div class="stat-mini-value" id="statMedianSession">‚Äî</div>
      <div class="stat-mini-change" id="statMedianChange">Loading...</div>
    </div>
  </div>
</div>

<div class="grid-section">
  <div class="section-title">Top Players by Playtime</div>
  <div class="card" style="overflow-x:auto;">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Total Time</th>
          <th>Sessions</th>
          <th>Avg/Session</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="topPlayersTable">
        <tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-dim);">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="grid-section">
  <div class="section-title">Retention Cohorts</div>
  <div class="card" style="overflow-x:auto;">
    <div style="font-size:0.85em;color:var(--text-dim);margin-bottom:20px;">Players grouped by join date, showing % retention</div>
    <table class="table">
      <thead>
        <tr>
          <th>Cohort</th>
          <th>Join Date</th>
          <th>Players</th>
          <th>Day 1</th>
          <th>Day 3</th>
          <th>Day 7</th>
          <th>Day 14</th>
          <th>Day 30</th>
        </tr>
      </thead>
      <tbody id="cohortsTable">
        <tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-dim);">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

</div>
</div>

<script>
const _k=42,_e="Tl9JQQ==";
function _dec(e){return Array.from(atob(e)).map(c=>String.fromCharCode(c.charCodeAt(0)^_k)).join('');}
function unlock(){
  const v=document.getElementById('pwInput').value;
  if(v===_dec(_e)){
    document.getElementById('lockScreen').classList.add('gone');
    document.getElementById('app').classList.add('on');
    sessionStorage.setItem('analytics_v','1');
    init();
  } else {
    const i=document.getElementById('pwInput');
    i.classList.add('shake');
    document.getElementById('lockErr').textContent='Incorrect password.';
    setTimeout(()=>{i.classList.remove('shake');i.value='';},400);
  }
}
if(sessionStorage.getItem('analytics_v')==='1'){
  document.getElementById('lockScreen').classList.add('gone');
  document.getElementById('app').classList.add('on');
}

const FB='https://ban-cloud-d854d-default-rtdb.firebaseio.com';
let allPlayers=[];
let chartInstances={};

async function fetchAll(){
  try{
    const res=await fetch(`${FB}/playertracking.json`);
    if(!res.ok)throw new Error('Fetch failed');
    const data=await res.json();
    if(data && typeof data==='object')
      allPlayers=Object.entries(data).map(([uid,d])=>({uid,...d}));
    else allPlayers=[];
  }catch(e){
    console.error('Fetch error:',e);
    allPlayers=[];
  }
}

function fmt(s){
  if(!s&&s!==0)return'‚Äî';s=Math.floor(s);
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
  if(h>0)return`${h}h ${m}m`;if(m>0)return`${m}m`;return`${sec}s`;
}

function daysAgo(isoDate){
  if(!isoDate)return 999;
  return Math.floor((Date.now()-new Date(isoDate))/86400000);
}

function updateMetrics(){
  const total=allPlayers.length;
  const tutDone=allPlayers.filter(p=>p.tutorialCompleted).length;
  const tutPct=total?Math.round(tutDone/total*100):0;
  const totalSecs=allPlayers.reduce((a,p)=>a+(p.totalPlaySeconds||0),0);
  const avgSecs=total?Math.floor(totalSecs/total):0;
  
  document.getElementById('metricTotalPlayers').textContent=total.toLocaleString();
  document.getElementById('metricPlayersChange').textContent=`${allPlayers.filter(p=>daysAgo(p.firstJoined)===0).length} joined today`;
  
  const newToday=allPlayers.filter(p=>daysAgo(p.firstJoined)===0).length;
  const newYesterday=allPlayers.filter(p=>daysAgo(p.firstJoined)===1).length;
  const dau=allPlayers.filter(p=>daysAgo(p.lastSeen)===0).length;
  document.getElementById('metricDAU').textContent=dau.toLocaleString();
  const dauChange=(dau-newToday);
  document.getElementById('metricDAUChange').textContent=`${dauChange>=0?'+':''}${dauChange} from yesterday`;
  
  document.getElementById('metricTutorialPct').textContent=tutPct+'%';
  document.getElementById('metricTutorialPlayers').textContent=`${tutDone}/${total} players`;
  
  document.getElementById('metricAvgSession').textContent=fmt(avgSecs);
  const avgPlayCount=total?allPlayers.reduce((a,p)=>a+(p.playCount||0),0)/total:0;
  const avgSessionThis=avgPlayCount?avgSecs/avgPlayCount:avgSecs;
  document.getElementById('metricAvgChange').textContent=`${avgPlayCount.toFixed(1)} sessions/player`;
  
  document.getElementById('statAvgPlaytime').textContent=fmt(totalSecs/Math.max(1,total));
  document.getElementById('statPlaytimeChange').textContent=`${total} players`;
  
  const returnRate=total?Math.round(allPlayers.filter(p=>(p.playCount||0)>1)/total*100):0;
  document.getElementById('statReturnRate').textContent=returnRate+'%';
  document.getElementById('statReturnChange').textContent=`${allPlayers.filter(p=>(p.playCount||0)>1).length} repeat`;
  
  const dailyAvg=dau>0?dau:newToday;
  document.getElementById('statPlayersPerDay').textContent=dailyAvg.toLocaleString();
  document.getElementById('statPlayersChange').textContent=`7d avg`;
  
  const durations=allPlayers.filter(p=>p.totalPlaySeconds).map(p=>p.totalPlaySeconds).sort((a,b)=>a-b);
  const median=durations.length?durations[Math.floor(durations.length/2)]:0;
  document.getElementById('statMedianSession').textContent=fmt(median);
  document.getElementById('statMedianChange').textContent=`mid value`;
}

function renderNewPlayersChart(){
  const days=7;
  const dates=[],counts=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const dateStr=d.toISOString().slice(0,10);
    dates.push(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
    counts.push(allPlayers.filter(p=>p.firstJoined&&p.firstJoined.startsWith(dateStr)).length);
  }
  
  if(chartInstances.newPlayers)chartInstances.newPlayers.destroy();
  chartInstances.newPlayers=new Chart(document.getElementById('newPlayersChart'),{
    type:'bar',
    data:{
      labels:dates,
      datasets:[{
        label:'New Players',
        data:counts,
        backgroundColor:['rgba(37,99,235,0.7)'],
        borderColor:'rgba(37,99,235,1)',
        borderWidth:2,
        borderRadius:8,
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        y:{
          beginAtZero:true,
          grid:{color:'rgba(37,99,235,0.1)'},
          ticks:{color:'var(--text-dim)'}
        },
        x:{grid:{display:false},ticks:{color:'var(--text-dim)'}}
      }
    }
  });
}

function renderDAUChart(){
  const days=7;
  const dates=[],daus=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const dateStr=d.toISOString().slice(0,10);
    dates.push(d.toLocaleDateString('en-US',{month:'short',day:'numeric'}));
    daus.push(allPlayers.filter(p=>p.lastSeen&&p.lastSeen.startsWith(dateStr)).length);
  }
  
  if(chartInstances.dau)chartInstances.dau.destroy();
  chartInstances.dau=new Chart(document.getElementById('dauTrendChart'),{
    type:'line',
    data:{
      labels:dates,
      datasets:[{
        label:'Active Players',
        data:daus,
        borderColor:'rgba(16,185,129,1)',
        backgroundColor:'rgba(16,185,129,0.1)',
        borderWidth:3,
        tension:0.4,
        fill:true,
        pointRadius:5,
        pointBackgroundColor:'rgba(16,185,129,1)',
        pointBorderColor:'#fff',
        pointBorderWidth:2,
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true,grid:{color:'rgba(37,99,235,0.1)'},ticks:{color:'var(--text-dim)'}},
        x:{grid:{display:false},ticks:{color:'var(--text-dim)'}}
      }
    }
  });
}

function renderFunnelChart(){
  const total=allPlayers.length||1;
  const tutCompleted=allPlayers.filter(p=>p.tutorialCompleted).length;
  const manyPlayed=allPlayers.filter(p=>(p.playCount||0)>1).length;
  
  if(chartInstances.funnel)chartInstances.funnel.destroy();
  chartInstances.funnel=new Chart(document.getElementById('funnelChart'),{
    type:'bar',
    data:{
      labels:['Players','Tutorial\nComplete','Return\nPlayer'],
      datasets:[{
        label:'Count',
        data:[total,tutCompleted,manyPlayed],
        backgroundColor:['rgba(37,99,235,0.7)','rgba(16,185,129,0.7)','rgba(245,158,11,0.7)'],
        borderRadius:8,
      }]
    },
    options:{
      indexAxis:'y',
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{beginAtZero:true,grid:{color:'rgba(37,99,235,0.1)'},ticks:{color:'var(--text-dim)'}},
        y:{grid:{display:false},ticks:{color:'var(--text-dim)'}}
      }
    }
  });
}

function renderSessionDurationChart(){
  const durations=allPlayers.filter(p=>p.totalPlaySeconds).map(p=>p.totalPlaySeconds);
  const bins=[0,300,600,1800,3600,7200,14400,28800];
  const labels=['<5m','5-10m','10-30m','30m-1h','1-2h','2-8h','8h+'];
  const counts=new Array(labels.length).fill(0);
  
  durations.forEach(d=>{
    for(let i=bins.length-1;i>=0;i--){
      if(d>=bins[i]){counts[i]++;break;}
    }
  });
  
  if(chartInstances.duration)chartInstances.duration.destroy();
  chartInstances.duration=new Chart(document.getElementById('sessionDurationChart'),{
    type:'doughnut',
    data:{
      labels,
      datasets:[{
        data:counts,
        backgroundColor:[
          'rgba(37,99,235,0.8)',
          'rgba(16,185,129,0.8)',
          'rgba(245,158,11,0.8)',
          'rgba(239,68,68,0.8)',
          'rgba(168,85,247,0.8)',
          'rgba(59,130,246,0.8)',
          'rgba(34,197,94,0.8)',
        ],
        borderColor:'#0f1428',
        borderWidth:2,
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'right',labels:{color:'var(--text)'}}}
    }
  });
}

function renderHeatmap(){
  const heatmap=document.getElementById('heatmap');
  heatmap.innerHTML='';
  
  const activity=new Array(24).fill(0);
  allPlayers.forEach(p=>{
    if(p.lastSeen){
      const d=new Date(p.lastSeen);
      const h=d.getUTCHours();
      activity[h]++;
    }
  });
  
  const max=Math.max(...activity);
  for(let h=0;h<24;h++){
    const cell=document.createElement('div');
    cell.className='heatmap-cell';
    const intensity=max?activity[h]/max:0;
    if(intensity>0.6)cell.classList.add('high');
    cell.style.background=intensity>0?
      `linear-gradient(135deg, rgba(37,99,235,${0.2+intensity*0.7}), rgba(16,185,129,${intensity*0.2}))`
      :'rgba(37,99,235,0.1)';
    cell.textContent=h;
    heatmap.appendChild(cell);
  }
}

function renderTopPlayersTable(){
  const sorted=[...allPlayers].sort((a,b)=>(b.totalPlaySeconds||0)-(a.totalPlaySeconds||0)).slice(0,10);
  const tbody=document.getElementById('topPlayersTable');
  tbody.innerHTML=sorted.map((p,i)=>{
    const isOnline=daysAgo(p.lastSeen)===0;
    const avgTime=p.playCount?(p.totalPlaySeconds||0)/p.playCount:0;
    return`<tr>
      <td><strong>#${i+1}</strong></td>
      <td><strong>${p.displayName||p.username||'Unknown'}</strong></td>
      <td>${fmt(p.totalPlaySeconds)}</td>
      <td><span class="badge badge-primary">${p.playCount||0}</span></td>
      <td>${fmt(avgTime)}</td>
      <td>${isOnline?'<span class="badge badge-accent">‚óè Online</span>':'<span class="badge badge-danger">Offline</span>'}</td>
    </tr>`;
  }).join('');
}

function renderCohortsTable(){
  const cohorts={};
  allPlayers.forEach(p=>{
    if(!p.firstJoined)return;
    const date=p.firstJoined.slice(0,10);
    if(!cohorts[date])cohorts[date]={count:0,days:{}};
    cohorts[date].count++;
    
    for(let d=1;d<=30;d+=d<7?1:d<14?3:7){
      const joinDate=new Date(p.firstJoined);
      const checkDate=new Date(joinDate);checkDate.setDate(checkDate.getDate()+d);
      if(p.lastSeen){
        const lastDate=new Date(p.lastSeen);
        if(lastDate>=checkDate){
          cohorts[date].days[d]=(cohorts[date].days[d]||0)+1;
        }
      }
    }
  });
  
  const tbody=document.getElementById('cohortsTable');
  tbody.innerHTML=Object.entries(cohorts).sort((a,b)=>b[0].localeCompare(a[0])).slice(0,8).map(([date,data])=>{
    const pct=(d)=>{
      const count=data.days[d]||0;
      return data.count?Math.round(count/data.count*100):0;
    };
    return`<tr>
      <td><strong>${date.slice(5)}</strong></td>
      <td>${new Date(date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</td>
      <td><strong>${data.count}</strong></td>
      <td>${pct(1)}%</td>
      <td>${pct(3)}%</td>
      <td>${pct(7)}%</td>
      <td>${pct(14)}%</td>
      <td>${pct(30)}%</td>
    </tr>`;
  }).join('');
}

function updateDashboard(){
  updateMetrics();
  renderNewPlayersChart();
  renderDAUChart();
  renderFunnelChart();
  renderSessionDurationChart();
  renderHeatmap();
  renderTopPlayersTable();
  renderCohortsTable();
}

function init(){
  fetchAll().then(updateDashboard);
  setInterval(()=>fetchAll().then(updateDashboard),15000);
}
if(sessionStorage.getItem('analytics_v')==='1')init();
</script>
</body>
</html>
