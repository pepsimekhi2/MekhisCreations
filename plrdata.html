<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard ‚Äî Mekhis Creations</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --blue:#3b82f6;--blue-d:#2563eb;--blue-dd:#1d4ed8;
  --bg:#07070f;--bg2:#0d0d1a;--bg3:#111120;
  --panel:rgba(59,130,246,0.07);--panel2:rgba(59,130,246,0.12);
  --border:rgba(59,130,246,0.15);--border2:rgba(59,130,246,0.25);
  --text:#e8e8f0;--dim:rgba(232,232,240,0.55);--dimmer:rgba(232,232,240,0.3);
  --green:#22c55e;--yellow:#f59e0b;--red:#ef4444;--purple:#a855f7;
  --font:'Fredoka One',sans-serif;
  --sidebar:240px;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* ‚îÄ‚îÄ‚îÄ NOISE TEXTURE OVERLAY ‚îÄ‚îÄ‚îÄ */
body::before{
  content:'';position:fixed;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events:none;z-index:0;opacity:0.4;
}

/* ‚îÄ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ‚îÄ */
#lockScreen{
  position:fixed;inset:0;background:var(--bg);z-index:9999;
  display:flex;align-items:center;justify-content:center;
}
#lockScreen.gone{display:none;}
.lock-wrap{
  background:var(--bg2);border:1px solid var(--border2);border-radius:24px;
  padding:55px 50px;width:420px;max-width:92vw;text-align:center;
  box-shadow:0 0 80px rgba(59,130,246,0.08),0 20px 60px rgba(0,0,0,0.6);
}
.lock-icon{font-size:3em;margin-bottom:16px;display:block;filter:drop-shadow(0 0 20px rgba(59,130,246,0.4));}
.lock-title{font-size:2.1em;color:#fff;margin-bottom:5px;}
.lock-sub{font-size:0.9em;color:var(--dim);margin-bottom:35px;}
.lock-input{
  width:100%;padding:16px;background:rgba(59,130,246,0.08);
  border:1px solid var(--border2);border-radius:14px;
  color:#fff;font-family:var(--font);font-size:1.1em;
  letter-spacing:5px;text-align:center;margin-bottom:14px;
  transition:border-color .2s,box-shadow .2s;
}
.lock-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(59,130,246,0.15);}
.lock-input.shake{animation:shake .35s ease;}
@keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-10px);}75%{transform:translateX(10px)};}
.lock-btn{
  width:100%;padding:16px;border:none;border-radius:14px;
  background:linear-gradient(135deg,var(--blue),var(--blue-d));
  color:#fff;font-family:var(--font);font-size:1.1em;cursor:pointer;
  transition:all .25s;box-shadow:0 4px 20px rgba(59,130,246,0.3);
}
.lock-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(59,130,246,0.45);}
.lock-err{color:var(--red);font-size:0.88em;margin-top:10px;min-height:18px;}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
#app{display:none;}
#app.on{display:flex;min-height:100vh;}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{
  width:var(--sidebar);flex-shrink:0;
  background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;
  z-index:100;
}
.sidebar-logo{
  padding:28px 22px 20px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo h2{font-size:1.3em;color:#fff;}
.sidebar-logo p{font-size:0.78em;color:var(--dim);margin-top:2px;}
.sidebar-nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:4px;}
.nav-label{font-size:0.7em;color:var(--dimmer);letter-spacing:2px;text-transform:uppercase;padding:10px 10px 6px;}
.nav-item{
  display:flex;align-items:center;gap:12px;padding:11px 14px;
  border-radius:12px;cursor:pointer;transition:all .2s;
  color:var(--dim);font-size:0.95em;border:1px solid transparent;
  position:relative;
}
.nav-item:hover{background:var(--panel);color:var(--text);}
.nav-item.active{background:rgba(59,130,246,0.15);color:var(--blue);border-color:var(--border2);}
.nav-item .icon{font-size:1.1em;width:20px;text-align:center;}
.nav-badge{
  margin-left:auto;background:var(--green);color:#000;
  font-size:0.7em;padding:2px 7px;border-radius:20px;font-weight:bold;
}
.nav-badge.blue{background:var(--blue);}
.sidebar-bottom{padding:16px 12px;border-top:1px solid var(--border);}
.live-indicator{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);
  border-radius:12px;
}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:livepulse 2s ease-in-out infinite;flex-shrink:0;}
@keyframes livepulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.4;transform:scale(.8);}}
.live-text{font-size:0.82em;color:var(--green);}
.live-time{font-size:0.72em;color:var(--dim);margin-top:1px;}

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{
  padding:20px 32px;background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:50;backdrop-filter:blur(12px);
}
.topbar-title{font-size:1.5em;color:#fff;}
.topbar-right{display:flex;align-items:center;gap:14px;}
.search-wrap{position:relative;}
.topbar-search{
  padding:10px 16px 10px 38px;background:var(--panel);border:1px solid var(--border);
  border-radius:12px;color:#fff;font-family:var(--font);font-size:0.9em;width:240px;
  transition:all .2s;
}
.topbar-search:focus{outline:none;border-color:var(--blue);width:280px;}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--dim);font-size:0.9em;pointer-events:none;}
.sort-sel{
  padding:10px 14px;background:var(--panel);border:1px solid var(--border);
  border-radius:12px;color:#fff;font-family:var(--font);font-size:0.88em;cursor:pointer;
}
.sort-sel option{background:#1a1a2e;}
.refresh-btn{
  padding:10px 18px;background:linear-gradient(135deg,var(--blue),var(--blue-d));
  border:none;border-radius:12px;color:#fff;font-family:var(--font);font-size:0.9em;
  cursor:pointer;transition:all .2s;box-shadow:0 3px 12px rgba(59,130,246,0.25);
}
.refresh-btn:hover{transform:translateY(-1px);box-shadow:0 5px 18px rgba(59,130,246,0.4);}
.refresh-btn:disabled{opacity:.5;pointer-events:none;}

/* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
.page{display:none;padding:32px;animation:fadeUp .3s ease;}
.page.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
.stat-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:18px;
  padding:24px;position:relative;overflow:hidden;transition:border-color .2s,transform .2s;
}
.stat-card:hover{border-color:var(--border2);transform:translateY(-2px);}
.stat-card::after{
  content:'';position:absolute;top:0;right:0;width:80px;height:80px;
  border-radius:50%;filter:blur(30px);opacity:0.15;pointer-events:none;
}
.stat-card.blue::after{background:var(--blue);}
.stat-card.green::after{background:var(--green);}
.stat-card.yellow::after{background:var(--yellow);}
.stat-card.purple::after{background:var(--purple);}
.stat-icon{font-size:1.6em;margin-bottom:12px;}
.stat-value{font-size:2.4em;color:#fff;line-height:1;margin-bottom:6px;transition:color .4s;}
.stat-value.flash{color:var(--yellow);}
.stat-label{font-size:0.82em;color:var(--dim);}
.stat-sub{font-size:0.75em;color:var(--dimmer);margin-top:4px;}

/* ‚îÄ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ‚îÄ */
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.section-title{font-size:1.2em;color:#fff;}
.section-meta{font-size:0.82em;color:var(--dim);}

/* ‚îÄ‚îÄ‚îÄ PLAYER TABLE ‚îÄ‚îÄ‚îÄ */
.table-card{background:var(--bg2);border:1px solid var(--border);border-radius:18px;overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead tr{background:rgba(59,130,246,0.08);}
th{
  padding:14px 18px;text-align:left;color:var(--blue);
  font-size:0.8em;letter-spacing:.5px;border-bottom:1px solid var(--border);
  cursor:pointer;user-select:none;white-space:nowrap;
}
th:hover{color:#fff;}
tbody tr{border-bottom:1px solid rgba(59,130,246,0.06);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:rgba(59,130,246,0.07);}
tbody tr:last-child{border-bottom:none;}
td{padding:13px 18px;font-size:0.88em;vertical-align:middle;}
.player-cell{display:flex;align-items:center;gap:12px;}
.avatar{width:36px;height:36px;border-radius:50%;border:2px solid var(--border2);object-fit:cover;background:var(--bg3);flex-shrink:0;}
.pname{color:#fff;font-size:0.97em;}
.pusername{color:var(--dim);font-size:0.78em;margin-top:1px;}
.mono{font-size:0.83em;color:var(--blue);}
.dim-text{font-size:0.82em;color:var(--dim);}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.74em;}
.badge-g{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.25);}
.badge-r{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.25);}
.badge-y{background:rgba(245,158,11,.12);color:var(--yellow);border:1px solid rgba(245,158,11,.25);}
.badge-b{background:rgba(59,130,246,.12);color:var(--blue);border:1px solid rgba(59,130,246,.25);}
.state-box{padding:60px;text-align:center;color:var(--dim);font-size:0.9em;}
.spinner{width:32px;height:32px;border:2px solid rgba(59,130,246,.2);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 14px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ‚îÄ‚îÄ‚îÄ SERVERS PAGE ‚îÄ‚îÄ‚îÄ */
.server-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;}
.server-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:18px;
  padding:22px;transition:all .2s;
}
.server-card:hover{border-color:var(--border2);transform:translateY(-2px);}
.server-card.active-server{border-color:rgba(34,197,94,.3);}
.server-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.server-id{font-size:0.78em;color:var(--dim);font-family:monospace;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.server-count{font-size:1.8em;color:#fff;}
.server-count-label{font-size:0.78em;color:var(--dim);}
.server-players{display:flex;flex-direction:column;gap:8px;margin-top:14px;}
.server-player{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;background:var(--panel);border-radius:10px;border:1px solid var(--border);
}
.server-player .avatar{width:30px;height:30px;}
.server-player-name{color:#fff;font-size:0.88em;}
.server-player-user{color:var(--dim);font-size:0.75em;}
.server-ping{font-size:0.73em;color:var(--dimmer);margin-top:12px;text-align:right;}
.server-empty{color:var(--dimmer);font-size:0.85em;text-align:center;padding:20px;}
.no-servers{text-align:center;padding:80px 20px;color:var(--dim);}
.no-servers .big{font-size:3em;margin-bottom:12px;}

/* ‚îÄ‚îÄ‚îÄ RECENT ACTIVITY ‚îÄ‚îÄ‚îÄ */
.activity-feed{display:flex;flex-direction:column;gap:0;}
.activity-item{
  display:flex;align-items:center;gap:14px;
  padding:13px 18px;border-bottom:1px solid rgba(59,130,246,.06);
  transition:background .15s;
}
.activity-item:hover{background:rgba(59,130,246,.05);}
.activity-item:last-child{border-bottom:none;}
.activity-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.activity-dot.join{background:var(--green);}
.activity-dot.leave{background:var(--red);}
.activity-dot.tut{background:var(--yellow);}
.activity-text{flex:1;font-size:0.88em;color:var(--text);}
.activity-time{font-size:0.78em;color:var(--dimmer);white-space:nowrap;}

/* ‚îÄ‚îÄ‚îÄ OVERVIEW BOTTOM GRID ‚îÄ‚îÄ‚îÄ */
.ov-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:18px;overflow:hidden;}
.card-hdr{padding:18px 20px;border-bottom:1px solid var(--border);font-size:1em;color:#fff;}

/* ‚îÄ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;justify-content:flex-end;backdrop-filter:blur(4px);}
.overlay.on{display:flex;}
.detail-panel{
  width:500px;max-width:95vw;height:100%;background:var(--bg2);
  border-left:1px solid var(--border2);overflow-y:auto;
  animation:slideIn .25s ease;display:flex;flex-direction:column;
}
@keyframes slideIn{from{transform:translateX(100%);}to{transform:translateX(0);}}
.dp-head{
  padding:28px 28px 22px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:16px;position:relative;
}
.dp-close{
  position:absolute;top:20px;right:20px;background:var(--panel2);
  border:1px solid var(--border);border-radius:8px;color:var(--dim);
  width:30px;height:30px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1em;transition:all .2s;
}
.dp-close:hover{color:#fff;border-color:var(--border2);}
.dp-avatar{width:68px;height:68px;border-radius:50%;border:3px solid var(--blue);object-fit:cover;}
.dp-name{font-size:1.6em;color:#fff;}
.dp-user{font-size:0.85em;color:var(--dim);margin-top:2px;}
.dp-uid{font-size:0.72em;color:var(--dimmer);margin-top:3px;}
.dp-body{padding:24px 28px;flex:1;}
.dp-section{margin-bottom:24px;}
.dp-section-label{font-size:0.72em;color:var(--blue);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;}
.dp-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.dp-stat{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;}
.dp-stat-label{font-size:0.72em;color:var(--dim);margin-bottom:5px;}
.dp-stat-value{font-size:1.05em;color:#fff;}
.dp-stat-value.accent{color:var(--blue);}
.dp-stat-value.g{color:var(--green);}
.dp-stat-value.y{color:var(--yellow);}
.sessions-scroll{max-height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:7px;}
.session-row{
  background:var(--panel);border:1px solid var(--border);border-radius:10px;
  padding:11px 14px;display:grid;grid-template-columns:30px 1fr auto;gap:10px;align-items:center;
}
.session-n{background:rgba(59,130,246,.2);color:var(--blue);border-radius:6px;text-align:center;font-size:0.75em;padding:3px;}
.session-info{font-size:0.8em;color:var(--dim);}
.session-info strong{color:var(--text);display:block;margin-bottom:2px;}
.session-dur{font-size:0.85em;color:#fff;text-align:right;white-space:nowrap;}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(59,130,246,.25);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:rgba(59,130,246,.5);}

@media(max-width:900px){
  .sidebar{transform:translateX(-100%);}
  .main{margin-left:0;}
  .stat-grid{grid-template-columns:1fr 1fr;}
  .ov-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOCK SCREEN ‚ïê‚ïê -->
<div id="lockScreen">
  <div class="lock-wrap">
    <span class="lock-icon">üõ°Ô∏è</span>
    <div class="lock-title">Admin Dashboard</div>
    <div class="lock-sub">Mekhis Creations ¬∑ Restricted Access</div>
    <input type="password" id="pwInput" class="lock-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter')unlock()" autocomplete="off">
    <button class="lock-btn" onclick="unlock()">Enter Dashboard</button>
    <div class="lock-err" id="lockErr"></div>
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h2>Mekhis Creations</h2>
      <p>Admin Dashboard</p>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-label">Navigation</div>
      <div class="nav-item active" onclick="goPage('overview',this)">
        <span class="icon">üìä</span> Overview
      </div>
      <div class="nav-item" onclick="goPage('players',this)">
        <span class="icon">üë•</span> Players
        <span class="nav-badge blue" id="navPlayerCount">0</span>
      </div>
      <div class="nav-item" onclick="goPage('servers',this)">
        <span class="icon">üñ•Ô∏è</span> Live Servers
        <span class="nav-badge" id="navServerCount">0</span>
      </div>
    </nav>
    <div class="sidebar-bottom">
      <div class="live-indicator">
        <div class="live-dot"></div>
        <div>
          <div class="live-text">Live Tracking</div>
          <div class="live-time" id="sidebarTime">Connecting...</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-title" id="topbarTitle">Overview</div>
      <div class="topbar-right">
        <div class="search-wrap" id="searchWrap" style="display:none;">
          <span class="search-icon">üîç</span>
          <input type="text" class="topbar-search" id="searchBox" placeholder="Search players..." oninput="renderTable()">
        </div>
        <select class="sort-sel" id="sortSel" style="display:none;" onchange="renderTable()">
          <option value="lastJoined">Last Joined</option>
          <option value="firstJoined">First Joined</option>
          <option value="playCount">Play Count</option>
          <option value="totalPlaySeconds">Total Playtime</option>
          <option value="tutorialSeconds">Tutorial Time</option>
        </select>
        <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">‚Üª Refresh</button>
      </div>
    </div>

    <!-- OVERVIEW PAGE -->
    <div class="page active" id="page-overview">
      <div class="stat-grid">
        <div class="stat-card blue">
          <div class="stat-icon">üë•</div>
          <div class="stat-value" id="ovPlayers">‚Äî</div>
          <div class="stat-label">Total Players</div>
          <div class="stat-sub" id="ovNewToday">‚Äî new today</div>
        </div>
        <div class="stat-card green">
          <div class="stat-icon">üñ•Ô∏è</div>
          <div class="stat-value" id="ovOnline">‚Äî</div>
          <div class="stat-label">Players Online Now</div>
          <div class="stat-sub" id="ovServers">across ‚Äî servers</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-icon">üéì</div>
          <div class="stat-value" id="ovTutorial">‚Äî</div>
          <div class="stat-label">Tutorial Completed</div>
          <div class="stat-sub" id="ovTutPct">‚Äî% completion rate</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-value" id="ovAvg">‚Äî</div>
          <div class="stat-label">Avg Session Length</div>
          <div class="stat-sub" id="ovTotalTime">‚Äî total hours played</div>
        </div>
      </div>

      <div class="ov-grid">
        <div class="card">
          <div class="card-hdr">üïê Recent Activity</div>
          <div class="activity-feed" id="activityFeed">
            <div class="state-box"><div class="spinner"></div>Loading...</div>
          </div>
        </div>
        <div class="card">
          <div class="card-hdr">üèÜ Most Played</div>
          <div id="topPlayersList">
            <div class="state-box"><div class="spinner"></div>Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PLAYERS PAGE -->
    <div class="page" id="page-players">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th onclick="setSortCol('displayName')">Player</th>
              <th onclick="setSortCol('playCount')">Sessions ‚Üï</th>
              <th onclick="setSortCol('totalPlaySeconds')">Total Playtime ‚Üï</th>
              <th onclick="setSortCol('tutorialSeconds')">Tutorial ‚Üï</th>
              <th onclick="setSortCol('firstJoined')">First Joined ‚Üï</th>
              <th onclick="setSortCol('lastJoined')">Last Seen ‚Üï</th>
            </tr>
          </thead>
          <tbody id="playerBody">
            <tr><td colspan="6"><div class="state-box"><div class="spinner"></div>Loading players...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SERVERS PAGE -->
    <div class="page" id="page-servers">
      <div class="section-hdr">
        <div class="section-title">Live Game Servers</div>
        <div class="section-meta" id="serverMeta">Checking...</div>
      </div>
      <div class="server-grid" id="serverGrid">
        <div class="state-box"><div class="spinner"></div>Loading servers...</div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<!-- DETAIL PANEL -->
<div class="overlay" id="overlay" onclick="closeDetail(event)">
  <div class="detail-panel" id="detailPanel">
    <div class="dp-head">
      <button class="dp-close" onclick="closeDetailPanel()">‚úï</button>
      <img class="dp-avatar" id="dpAvatar" src="" alt="">
      <div>
        <div class="dp-name" id="dpName"></div>
        <div class="dp-user" id="dpUser"></div>
        <div class="dp-uid" id="dpUID"></div>
      </div>
    </div>
    <div class="dp-body" id="dpBody"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ PASSWORD ‚îÄ‚îÄ
const _k=42,_e="Tl9JQQ==";
function _dec(e){return Array.from(atob(e)).map(c=>String.fromCharCode(c.charCodeAt(0)^_k)).join('');}
function unlock(){
  const v=document.getElementById('pwInput').value;
  if(v===_dec(_e)){
    document.getElementById('lockScreen').classList.add('gone');
    document.getElementById('app').classList.add('on');
    sessionStorage.setItem('plrdata_v','1');
    init();
  } else {
    const i=document.getElementById('pwInput');
    i.classList.add('shake');
    document.getElementById('lockErr').textContent='Incorrect password.';
    setTimeout(()=>{i.classList.remove('shake');i.value='';},400);
  }
}
if(sessionStorage.getItem('plrdata_v')==='1'){
  document.getElementById('lockScreen').classList.add('gone');
  document.getElementById('app').classList.add('on');
}

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const FB='https://ban-cloud-d854d-default-rtdb.firebaseio.com';
const POLL_MS=15000;
let allPlayers=[],allServers={};
let sortCol='lastJoined',sortDir=-1;
let pollTimer=null;
const avatarCache={};

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
let currentPage='overview';
function goPage(id,el){
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.getElementById('topbarTitle').textContent=el.textContent.trim();
  currentPage=id;
  const showSearch=id==='players';
  document.getElementById('searchWrap').style.display=showSearch?'':'none';
  document.getElementById('sortSel').style.display=showSearch?'':'none';
}

// ‚îÄ‚îÄ DATA FETCH ‚îÄ‚îÄ
async function fetchAll(){
  const [plrRes,srvRes]=await Promise.all([
    fetch(`${FB}/playertracking.json`).then(r=>r.json()).catch(()=>null),
    fetch(`${FB}/servers.json`).then(r=>r.json()).catch(()=>null),
  ]);
  if(plrRes && typeof plrRes==='object')
    allPlayers=Object.entries(plrRes).map(([uid,d])=>({uid,...d}));
  allServers=srvRes && typeof srvRes==='object' ? srvRes : {};
}

async function loadData(){
  await fetchAll();
  updateOverview();
  renderTable();
  renderServers();
  updateNav();
  updateSidebarTime();
}

function manualRefresh(){
  const btn=document.getElementById('refreshBtn');
  btn.disabled=true;btn.textContent='...';
  clearTimeout(pollTimer);
  loadData().finally(()=>{
    btn.disabled=false;btn.textContent='‚Üª Refresh';
    schedulePoll();
  });
}

function schedulePoll(){
  clearTimeout(pollTimer);
  pollTimer=setTimeout(()=>loadData().then(schedulePoll),POLL_MS);
}

function updateSidebarTime(){
  const now=new Date();
  document.getElementById('sidebarTime').textContent=
    `Updated ${now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;
}

// ‚îÄ‚îÄ FORMAT HELPERS ‚îÄ‚îÄ
function fmtS(s){
  if(!s&&s!==0)return'‚Äî';s=Math.floor(s);
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
  if(h>0)return`${h}h ${m}m`;if(m>0)return`${m}m ${sec}s`;return`${sec}s`;
}
function fmtDate(iso){if(!iso)return'‚Äî';return new Date(iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});}
function fmtDateTime(iso){if(!iso)return'‚Äî';return new Date(iso).toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}
function ago(iso){
  if(!iso)return'‚Äî';
  const d=Math.floor((Date.now()-new Date(iso))/1000);
  if(d<60)return'Just now';if(d<3600)return`${Math.floor(d/60)}m ago`;
  if(d<86400)return`${Math.floor(d/3600)}h ago`;return`${Math.floor(d/86400)}d ago`;
}
function setVal(id,v){
  const el=document.getElementById(id);if(!el)return;
  const old=el.textContent;el.textContent=v;
  if(old!==v&&old!=='‚Äî'&&old!=='0'){el.classList.add('flash');setTimeout(()=>el.classList.remove('flash'),1200);}
}

// ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ
function updateOverview(){
  const total=allPlayers.length;

  // Online players from active servers
  const activeServers=Object.values(allServers).filter(s=>s.active && isRecentPing(s.lastPing));
  const onlineSet=new Set();
  activeServers.forEach(s=>(s.players||[]).forEach(p=>onlineSet.add(p.userId)));
  const online=onlineSet.size;

  const tutDone=allPlayers.filter(p=>p.tutorialCompleted).length;
  const tutPct=total?Math.round(tutDone/total*100):0;
  const totalSecs=allPlayers.reduce((a,p)=>a+(p.totalPlaySeconds||0),0);
  const avgSecs=total?Math.floor(totalSecs/total):0;

  // New today
  const todayStr=new Date().toISOString().slice(0,10);
  const newToday=allPlayers.filter(p=>p.firstJoined&&p.firstJoined.startsWith(todayStr)).length;

  setVal('ovPlayers',total.toLocaleString());
  setVal('ovOnline',online.toLocaleString());
  setVal('ovTutorial',tutDone.toLocaleString());
  setVal('ovAvg',fmtS(avgSecs));
  document.getElementById('ovNewToday').textContent=`${newToday} new today`;
  document.getElementById('ovServers').textContent=`across ${activeServers.length} server${activeServers.length!==1?'s':''}`;
  document.getElementById('ovTutPct').textContent=`${tutPct}% completion rate`;
  document.getElementById('ovTotalTime').textContent=`${Math.floor(totalSecs/3600).toLocaleString()} total hours played`;

  renderActivity();
  renderTopPlayers();
}

function isRecentPing(ping){
  if(!ping)return false;
  return (Date.now()-new Date(ping).getTime())<90000; // within 90s (server pings every 20s)
}

// ‚îÄ‚îÄ ACTIVITY FEED ‚îÄ‚îÄ
function renderActivity(){
  const feed=document.getElementById('activityFeed');
  // Build activity from recent joins/leaves across all players
  const events=[];
  allPlayers.forEach(p=>{
    if(p.lastJoined) events.push({type:'join',time:p.lastJoined,name:p.displayName||p.username,uid:p.uid});
    if(p.tutorialCompleted&&p.tutorialDate) events.push({type:'tut',time:p.tutorialDate,name:p.displayName||p.username,uid:p.uid});
  });
  events.sort((a,b)=>new Date(b.time)-new Date(a.time));
  const recent=events.slice(0,10);
  if(!recent.length){feed.innerHTML='<div class="state-box">No activity yet.</div>';return;}
  feed.innerHTML=recent.map(e=>`
    <div class="activity-item">
      <div class="activity-dot ${e.type}"></div>
      <div class="activity-text">
        ${e.type==='join'?`<strong>${e.name}</strong> joined the game`:''}
        ${e.type==='tut'?`<strong>${e.name}</strong> completed the tutorial`:''}
      </div>
      <div class="activity-time">${ago(e.time)}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ TOP PLAYERS ‚îÄ‚îÄ
function renderTopPlayers(){
  const sorted=[...allPlayers].sort((a,b)=>(b.totalPlaySeconds||0)-(a.totalPlaySeconds||0)).slice(0,8);
  const list=document.getElementById('topPlayersList');
  list.innerHTML=sorted.map((p,i)=>`
    <div class="activity-item" style="cursor:pointer" onclick="openDetail('${p.uid}')">
      <div style="width:20px;text-align:center;font-size:0.8em;color:var(--dim);">${i+1}</div>
      <img class="avatar" data-uid="${p.uid}" src="" alt="${p.displayName}" style="width:30px;height:30px;">
      <div style="flex:1">
        <div style="font-size:0.88em;color:#fff">${p.displayName||'‚Äî'}</div>
        <div style="font-size:0.76em;color:var(--dim)">@${p.username||'‚Äî'}</div>
      </div>
      <div class="mono">${fmtS(p.totalPlaySeconds)}</div>
    </div>`).join('');
  resolveAvatars(list.querySelectorAll('.avatar[data-uid]'));
}

// ‚îÄ‚îÄ NAV BADGES ‚îÄ‚îÄ
function updateNav(){
  const activeServers=Object.values(allServers).filter(s=>s.active&&isRecentPing(s.lastPing));
  const onlineSet=new Set();
  activeServers.forEach(s=>(s.players||[]).forEach(p=>onlineSet.add(p.userId)));
  document.getElementById('navPlayerCount').textContent=allPlayers.length;
  document.getElementById('navServerCount').textContent=activeServers.length;
}

// ‚îÄ‚îÄ PLAYER TABLE ‚îÄ‚îÄ
function setSortCol(col){
  if(sortCol===col)sortDir*=-1;else{sortCol=col;sortDir=-1;}
  document.getElementById('sortSel').value=col;
  renderTable();
}
function renderTable(){
  const q=(document.getElementById('searchBox').value||'').toLowerCase();
  sortCol=document.getElementById('sortSel').value||sortCol;
  let list=[...allPlayers].filter(p=>
    !q||[p.username,p.displayName,p.uid].some(v=>(v||'').toLowerCase().includes(q))
  );
  list.sort((a,b)=>{
    let av=a[sortCol],bv=b[sortCol];
    if(sortCol==='lastJoined'||sortCol==='firstJoined'){av=av?new Date(av).getTime():0;bv=bv?new Date(bv).getTime():0;}
    else{av=av||0;bv=bv||0;}
    return(av<bv?-1:av>bv?1:0)*sortDir;
  });
  if(!list.length){
    document.getElementById('playerBody').innerHTML=`<tr><td colspan="6"><div class="state-box">No players found.</div></td></tr>`;
    return;
  }

  // Build set of online userIds
  const onlineSet=new Set();
  Object.values(allServers).filter(s=>s.active&&isRecentPing(s.lastPing))
    .forEach(s=>(s.players||[]).forEach(p=>onlineSet.add(p.userId)));

  document.getElementById('playerBody').innerHTML=list.map(p=>{
    const isOnline=onlineSet.has(p.uid);
    const tutCell=p.tutorialCompleted
      ?`<span class="badge badge-g">‚úì ${fmtS(p.tutorialSeconds)}</span>`
      :`<span class="badge badge-r">‚úó No</span>`;
    return`<tr onclick="openDetail('${p.uid}')">
      <td><div class="player-cell">
        <img class="avatar" data-uid="${p.uid}" src="" alt="${p.displayName}">
        <div>
          <div class="pname">${p.displayName||'‚Äî'} ${isOnline?'<span class="badge badge-g" style="font-size:0.68em;padding:1px 6px">‚óè Online</span>':''}</div>
          <div class="pusername">@${p.username||'‚Äî'}</div>
        </div>
      </div></td>
      <td><span class="mono">${p.playCount||0}</span></td>
      <td><span class="mono">${fmtS(p.totalPlaySeconds)}</span></td>
      <td>${tutCell}</td>
      <td><span class="dim-text">${fmtDate(p.firstJoined)}</span></td>
      <td><span class="dim-text">${ago(p.lastJoined)}</span></td>
    </tr>`;
  }).join('');
  resolveAvatars(document.querySelectorAll('#playerBody .avatar[data-uid]'));
}

// ‚îÄ‚îÄ SERVERS ‚îÄ‚îÄ
function renderServers(){
  const grid=document.getElementById('serverGrid');
  const servers=Object.entries(allServers).filter(([,s])=>s.active&&isRecentPing(s.lastPing));

  document.getElementById('serverMeta').textContent=
    `${servers.length} active server${servers.length!==1?'s':''} ¬∑ auto-refreshes every 15s`;

  if(!servers.length){
    grid.innerHTML=`<div class="no-servers" style="grid-column:1/-1"><div class="big">üñ•Ô∏è</div><div>No active servers right now</div><div style="font-size:0.82em;color:var(--dimmer);margin-top:8px">Servers appear here when players are in-game</div></div>`;
    return;
  }

  grid.innerHTML=servers.map(([sid,s])=>{
    const playerCards=(s.players||[]).map(p=>`
      <div class="server-player">
        <img class="avatar" data-uid="${p.userId}" src="" alt="${p.displayName}">
        <div>
          <div class="server-player-name">${p.displayName||p.username||'Unknown'}</div>
          <div class="server-player-user">@${p.username||'‚Äî'}</div>
        </div>
        <div class="live-dot" style="margin-left:auto;flex-shrink:0;"></div>
      </div>`).join('');
    const shortId=sid.length>20?sid.slice(0,8)+'‚Ä¶'+sid.slice(-6):sid;
    const isStudio=sid.startsWith('studio-');
    return`<div class="server-card active-server">
      <div class="server-hdr">
        <div>
          <div style="font-size:0.75em;color:var(--dim);margin-bottom:3px">${isStudio?'üîß Studio Test':'üéÆ Live Server'}</div>
          <div class="server-id" title="${sid}">${shortId}</div>
        </div>
        <div style="text-align:right">
          <div class="server-count">${(s.players||[]).length}</div>
          <div class="server-count-label">players</div>
        </div>
      </div>
      ${playerCards?`<div class="server-players">${playerCards}</div>`:`<div class="server-empty">No player data</div>`}
      <div class="server-ping">Last ping: ${ago(s.lastPing)}</div>
    </div>`;
  }).join('');
  resolveAvatars(grid.querySelectorAll('.avatar[data-uid]'));
}

// ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ
function openDetail(uid){
  const p=allPlayers.find(x=>x.uid===uid);
  if(!p)return;
  document.getElementById('dpName').textContent=p.displayName||'‚Äî';
  document.getElementById('dpUser').textContent='@'+(p.username||'‚Äî');
  document.getElementById('dpUID').textContent='UID: '+uid;
  document.getElementById('dpAvatar').dataset.uid=uid;
  document.getElementById('dpAvatar').src='';
  resolveAvatars([document.getElementById('dpAvatar')]);

  const sessions=p.sessions?Object.entries(p.sessions):[];
  const onlineSet=new Set();
  Object.values(allServers).filter(s=>s.active&&isRecentPing(s.lastPing))
    .forEach(s=>(s.players||[]).forEach(pl=>onlineSet.add(pl.userId)));
  const isOnline=onlineSet.has(uid);

  document.getElementById('dpBody').innerHTML=`
    <div class="dp-section">
      <div class="dp-section-label">Status</div>
      <div class="dp-grid">
        <div class="dp-stat"><div class="dp-stat-label">Online Now</div>
          <div class="dp-stat-value ${isOnline?'g':''}">${isOnline?'‚óè Online':'Offline'}</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Play Count</div>
          <div class="dp-stat-value accent">${p.playCount||0} sessions</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Total Playtime</div>
          <div class="dp-stat-value accent">${fmtS(p.totalPlaySeconds)}</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Avg Session</div>
          <div class="dp-stat-value">${p.playCount?fmtS(Math.floor((p.totalPlaySeconds||0)/p.playCount)):'‚Äî'}</div></div>
      </div>
    </div>
    <div class="dp-section">
      <div class="dp-section-label">Dates</div>
      <div class="dp-grid">
        <div class="dp-stat"><div class="dp-stat-label">First Joined</div>
          <div class="dp-stat-value">${fmtDate(p.firstJoined)}</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Last Joined</div>
          <div class="dp-stat-value">${fmtDate(p.lastJoined)}</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Last Seen</div>
          <div class="dp-stat-value">${ago(p.lastSeen)}</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Tutorial</div>
          <div class="dp-stat-value ${p.tutorialCompleted?'g':''}">
            ${p.tutorialCompleted?'‚úì Completed':'‚úó Not done'}</div></div>
        ${p.tutorialCompleted?`
        <div class="dp-stat"><div class="dp-stat-label">Tutorial Date</div>
          <div class="dp-stat-value">${fmtDate(p.tutorialDate)}</div></div>
        <div class="dp-stat"><div class="dp-stat-label">Time to Complete</div>
          <div class="dp-stat-value y">${fmtS(p.tutorialSeconds)}</div></div>`:''}
      </div>
    </div>
    <div class="dp-section">
      <div class="dp-section-label">Session History (${sessions.length})</div>
      <div class="sessions-scroll">
        ${sessions.length?sessions.map(([idx,s])=>`
          <div class="session-row">
            <div class="session-n">#${idx}</div>
            <div class="session-info">
              <strong>${fmtDateTime(s.joinedAt)}</strong>
              ${s.leftAt?`‚Üí ${fmtDateTime(s.leftAt)}`:'<span style="color:var(--green)">‚óè Active now</span>'}
            </div>
            <div class="session-dur">${s.durationSeconds!=null?fmtS(s.durationSeconds):'‚Äî'}</div>
          </div>`).join('')
        :'<div class="state-box" style="padding:20px">No sessions recorded.</div>'}
      </div>
    </div>`;
  document.getElementById('overlay').classList.add('on');
}
function closeDetail(e){if(e.target===document.getElementById('overlay'))closeDetailPanel();}
function closeDetailPanel(){document.getElementById('overlay').classList.remove('on');}

// ‚îÄ‚îÄ AVATAR RESOLVER ‚îÄ‚îÄ
async function resolveAvatars(imgs){
  for(const img of imgs){
    const uid=img.dataset.uid;
    if(!uid)continue;
    if(avatarCache[uid]){img.src=avatarCache[uid];continue;}
    try{
      const r=await fetch(`/api/userdata.js?userId=${uid}`);
      if(!r.ok)continue;
      const d=await r.json();
      const url=d.headshot||d.avatar||'';
      avatarCache[uid]=url;
      img.src=url;
    }catch(e){}
  }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function init(){
  loadData().then(schedulePoll);
}
if(sessionStorage.getItem('plrdata_v')==='1') init();
</script>
</body>
</html>
