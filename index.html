<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekhis Creations</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root{--primary:#4285F4;--secondary:#34A853;--accent:#EA4335;--text:#202124;--bg:#F8F9FA;--card-bg:#fff;--btn-text:#fff;--input-bg:#fff;--notification-success:#34A853;--notification-error:#EA4335;--notification-info:#4285F4;--theme-dark-text:#F8F9FA;--theme-dark-bg:#202124;--theme-dark-card:#303134;--crimson:#DC143C;--neon-primary:#00F0FF;--neon-secondary:#FF00F0;--neon-accent:#F0FF00;--gold:#FFD700;--silver:#C0C0C0;--bronze:#CD7F32;--galaxy-primary:#9D00FF;--galaxy-secondary:#00D1FF;--galaxy-accent:#FF00F5}
        body{font-family:'Fredoka One',cursive;color:var(--text);margin:0;min-height:100vh;display:flex;transition:all 0.3s;background:var(--bg)}
        .container{max-width:800px;width:100%;padding:20px;margin-left:220px}
        .sidebar{width:200px;position:fixed;left:10px;top:10px;bottom:10px;background:var(--card-bg);border-radius:15px;padding:15px;box-shadow:0 5px 15px rgba(0,0,0,0.1);overflow-y:auto}
        .sidebar-profile{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;cursor:pointer}
        .sidebar-profile img{width:80px;height:80px;border-radius:50%;border:3px solid var(--primary);object-fit:cover}
        .sidebar-profile span{margin-top:10px;font-size:16px;color:var(--primary)}
        .sidebar-nav{display:flex;flex-direction:column;gap:10px}
        .sidebar-nav button{background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:10px;cursor:pointer;font-family:'Fredoka One',cursive;text-align:left}
        .recommended-profiles{margin-top:20px}
        .recommended-title{font-size:14px;color:var(--primary);margin-bottom:10px}
        .recommended-user{display:flex;align-items:center;padding:8px;border-radius:10px;margin-bottom:8px;cursor:pointer}
        .recommended-user:hover{background:rgba(0,0,0,0.05)}
        .recommended-user img{width:40px;height:40px;border-radius:50%;margin-right:10px;border:2px solid var(--primary)}
        .progress-bar{height:10px;background:rgba(0,0,0,0.1);border-radius:5px;margin:20px 0;overflow:hidden}
        .progress{height:100%;background:var(--secondary);width:0%;transition:width 0.5s}
        h1,h2{color:var(--primary);text-shadow:2px 2px 0 rgba(0,0,0,0.1)}
        button{font-family:'Fredoka One',cursive;background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:12px 24px;margin:5px;cursor:pointer;font-size:16px;transition:all 0.2s;box-shadow:0 4px 0 rgba(0,0,0,0.1);min-width:120px}
        button:hover{transform:translateY(-2px);box-shadow:0 6px 0 rgba(0,0,0,0.1)}
        button:active{transform:translateY(1px);box-shadow:0 2px 0 rgba(0,0,0,0.1)}
        #no-btn{background:var(--accent)}#yes-btn,#verify-btn{background:var(--secondary)}
        .back-btn{background:transparent;color:var(--accent);box-shadow:none;text-decoration:underline;padding:8px;min-width:auto}
        input,textarea{font-family:'Fredoka One',cursive;padding:12px;border:3px solid var(--primary);border-radius:15px;width:80%;font-size:16px;margin:15px 0;background:var(--input-bg)}
        textarea{min-height:100px;resize:vertical}
        #user-info{background:var(--card-bg);border-radius:20px;padding:20px;margin:20px 0;box-shadow:0 5px 15px rgba(0,0,0,0.05)}
        #headshot{width:150px;height:150px;border-radius:50%;object-fit:cover;border:5px solid var(--primary)}
        #username{font-size:24px;margin:10px 0;color:var(--primary)}#description{background:var(--bg);padding:15px;border-radius:10px;margin:10px 0}
        .code-container{display:flex;justify-content:center;gap:10px;margin:20px 0}
        #verification-code{font-size:32px;letter-spacing:5px;color:var(--secondary);background:var(--card-bg);padding:15px 20px;border-radius:10px;display:flex;align-items:center}
        .copy-btn{background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:5px 10px;font-size:12px;cursor:pointer;margin-left:10px}
        #verification-status{min-height:24px;color:var(--accent);margin-top:10px}
        .bounce{animation:bounce 0.5s infinite alternate}
        #home-content{display:none;text-align:center}
        #title-bar{font-size:28px;margin-bottom:10px}
        #divider{height:3px;background:var(--primary);border-radius:3px;width:80%;margin:0 auto 20px}
        #profile-container{background:var(--card-bg);border-radius:20px;padding:20px;margin:20px auto;max-width:400px;box-shadow:0 5px 15px rgba(0,0,0,0.05)}
        #profile-headshot{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--primary);margin-bottom:15px}
        #profile-username{font-size:22px;color:var(--primary);margin-bottom:15px}
        #profile-description{background:var(--bg);padding:15px;border-radius:10px;margin:15px 0;min-height:60px}
        #profile-stats{display:flex;justify-content:space-around;margin:15px 0}
        .stat-value{font-size:20px;font-weight:bold;color:var(--primary);cursor:pointer;transition:all 0.2s}
        .stat-value:hover{transform:scale(1.05);text-decoration:underline}
        .stat-label{font-size:14px;color:var(--text)}
        #edit-btn{background:var(--primary);margin-right:10px}#save-btn{background:var(--secondary);display:none}
        #follow-btn,#message-btn{background:var(--accent);display:none}
        #back-to-profile{background:var(--primary);display:none;margin:10px auto}
        .version{position:fixed;bottom:10px;left:10px;font-size:12px;opacity:0.7}
        .theme-btn{position:fixed;bottom:10px;right:10px;font-size:12px;padding:8px 12px;border-radius:50px}
        .theme-menu{position:fixed;bottom:40px;right:10px;background:var(--card-bg);border-radius:15px;padding:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:100;width:200px;display:none}
        .theme-menu.active{display:block}
        .theme-section{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(0,0,0,0.1)}
        .theme-section-title{font-weight:bold;margin-bottom:5px;font-size:14px}
        .theme-option{padding:5px 10px;cursor:pointer;border-radius:50px;margin:2px 0;font-size:12px;text-align:center}
        .theme-option:hover{background:rgba(0,0,0,0.1)}.theme-option.selected{background:var(--primary);color:var(--btn-text)}
        #player-search{margin-top:20px;margin-bottom:20px}#search-input{width:60%;margin-right:10px}
        #search-results{display:none;margin-top:10px;background:var(--card-bg);border-radius:15px;padding:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .search-result{display:flex;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .search-result:hover{background:rgba(0,0,0,0.05)}
        .search-result:last-child{border-bottom:none}
        .search-result img{width:40px;height:40px;border-radius:50%;margin-right:10px;border:2px solid var(--primary)}
        .search-result button{margin-left:auto;padding:5px 10px;font-size:12px;min-width:auto;border-radius:50px}
        .notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:50px;color:white;font-weight:bold;box-shadow:0 3px 10px rgba(0,0,0,0.2);z-index:1000;animation:slideIn 0.3s,fadeOut 0.5s 2.5s forwards}
        .notification.success{background-color:var(--notification-success)}.notification.error{background-color:var(--notification-error)}.notification.info{background-color:var(--notification-info)}
        .followers-list,.following-list,.messages-list,.notifications-list{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card-bg);border-radius:20px;padding:20px;width:80%;max-width:400px;max-height:80vh;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1000}
        .close-list{position:absolute;top:10px;right:10px;background:var(--accent);color:white;border:none;width:25px;height:25px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
        .close-list:hover{transform:scale(1.1);background:#d32f2f}
        .list-title{margin-bottom:15px;color:var(--primary)}
        .list-item{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .list-item:hover{background:rgba(0,0,0,0.05)}
        .list-item:last-child{border-bottom:none}
        .list-item img{width:40px;height:40px;border-radius:50%;margin-right:10px}
        .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999}
        .post-container{background:var(--card-bg);border-radius:15px;padding:15px;margin:15px auto;max-width:500px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .post-header{display:flex;align-items:center;margin-bottom:10px}
        .post-user{font-weight:bold;color:var(--primary);cursor:pointer}
        .post-time{font-size:12px;color:gray;margin-left:10px}
        .post-content{margin-bottom:15px}
        .post-actions{display:flex;justify-content:space-around}
        .post-action{display:flex;align-items:center;cursor:pointer;padding:5px 10px;border-radius:50px}
        .post-action:hover{background:rgba(0,0,0,0.05)}
        .post-action span{margin-left:5px}
        .post-action.liked{color:var(--accent)}
        .post-action.reposted{color:var(--secondary)}
        .create-post{background:var(--card-bg);border-radius:15px;padding:15px;margin:15px auto;max-width:500px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .create-post textarea{width:100%;margin:0 0 10px 0}
        .create-post button{width:100%;margin:0}
        .message-input{display:flex;margin-top:10px}
        .message-input input{flex:1;margin-right:10px}
        .message-input button{margin:0;padding:10px 15px}
        .message{background:var(--bg);padding:10px;border-radius:10px;margin:5px 0;max-width:80%}
        .message.sent{align-self:flex-end;background:var(--primary);color:white}
        .message.received{align-self:flex-start}
        .messages-container{display:flex;flex-direction:column;max-height:300px;overflow-y:auto;margin-bottom:10px}
        body.galaxy-theme{--primary:#9D00FF;--secondary:#00D1FF;--accent:#FF00F5;--notification-success:#00FF88;--notification-error:#FF006E;--notification-info:#7700FF}
        body.galaxy-theme.dark-mode{--text:#FFFFFF;--bg:#0A0A1A;--card-bg:#1A1A2A;background:radial-gradient(circle at center,#0A0A1A,#000000)}
        @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-5px)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{opacity:0;transform:translate(-50%,-30px)}to{opacity:1;transform:translate(-50%,0)}}
        @keyframes fadeOut{from{opacity:1}to{opacity:0}}
        @keyframes galaxyPulse{0%,100%{box-shadow:0 0 10px 5px var(--galaxy-primary)}50%{box-shadow:0 0 20px 10px var(--galaxy-secondary)}}
        .galaxy-pulse{animation:galaxyPulse 3s infinite}
    </style>
</head>
<body class="default-theme">
    <div class="version">Mekhis Creations v2.0</div>
    <button class="theme-btn" id="theme-btn">Themes</button>
    <div class="theme-menu" id="theme-menu">
        <div class="theme-section">
            <div class="theme-section-title">Color Themes</div>
            <div class="theme-option selected" data-theme="default">Default</div>
            <div class="theme-option" data-theme="crimson">Crimson</div>
            <div class="theme-option" data-theme="neon">Neon</div>
            <div class="theme-option" data-theme="gold">Gold</div>
            <div class="theme-option" data-theme="silver">Silver</div>
            <div class="theme-option" data-theme="bronze">Bronze</div>
            <div class="theme-option" data-theme="galaxy">Galaxy</div>
        </div>
        <div class="theme-section">
            <div class="theme-section-title">Appearance</div>
            <div class="theme-option" data-mode="light">Light Mode</div>
            <div class="theme-option" data-mode="dark">Dark Mode</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-profile" id="sidebar-profile">
            <img id="sidebar-headshot" src="" alt="Profile">
            <span id="sidebar-username">Loading...</span>
        </div>
        <div class="sidebar-nav">
            <button id="home-btn">🏠 Home</button>
            <button id="messages-btn">💬 Messages</button>
            <button id="notifications-btn">🔔 Notifications</button>
        </div>
        <div class="recommended-profiles">
            <div class="recommended-title">Recommended Profiles</div>
            <div id="recommended-users"></div>
        </div>
    </div>

    <div class="container">
        <div id="main-app" class="step">
            <h1>Welcome to Mekhis Creations</h1>
            <div class="bounce">🎉</div>
            <p>You're all set! Enjoy the platform.</p>
            <button id="go-home-btn" style="margin-top:20px">Go to Home</button>
        </div>
        
        <div id="onboarding">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            
            <div id="step1" class="step active">
                <h1>Welcome to Mekhis Creations!</h1>
                <div class="bounce">👋</div>
                <p>Let's get you set up!</p>
                <p>First, enter your Roblox User ID below:</p>
                <input type="text" id="roblox-id" placeholder="123456789">
                <button id="confirm-id">Let's Go!</button>
            </div>
            
            <div id="step2" class="step">
                <h2>Is this you?</h2>
                <div id="user-info">
                    <img id="headshot" src="" alt="Roblox avatar">
                    <div id="username"></div>
                    <div id="description"></div>
                </div>
                <button id="yes-btn">Yes, that's me!</button>
                <button id="no-btn">No, try again</button>
            </div>
            
            <div id="step3" class="step">
                <h2>Almost there!</h2>
                <p>Let's verify this is really you:</p>
                <ol style="text-align:left;display:inline-block">
                    <li>Copy this code</li>
                    <li>Paste it in your Roblox profile description</li>
                    <li>Click verify when done</li>
                </ol>
                <div class="code-container">
                    <div id="verification-code">
                        <span id="code-text"></span>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
                <div style="margin-top:15px">
                    <button id="verify-btn">Verify</button>
                    <button class="back-btn" id="back-btn">Back</button>
                </div>
                <div id="verification-status"></div>
            </div>
        </div>
        
        <div id="home-content">
            <div id="title-bar">Mekhis Creations</div>
            <div id="divider"></div>
            
            <div id="create-post" class="create-post" style="display:none">
                <textarea id="post-content" placeholder="What's on your mind?"></textarea>
                <button id="post-btn">Post</button>
            </div>
            
            <div id="player-search">
                <input type="text" id="search-input" placeholder="Search players by username">
                <button id="search-btn">Search</button>
                <div id="search-results"></div>
            </div>
            
            <button id="back-to-profile">Back to My Profile</button>
            
            <div id="profile-container">
                <img id="profile-headshot" src="" alt="Profile picture">
                <div id="profile-username"></div>
                <div id="profile-description">Loading description...</div>
                <div id="profile-stats">
                    <div>
                        <div class="stat-value" id="followers-count">0</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div>
                        <div class="stat-value" id="following-count">0</div>
                        <div class="stat-label">Following</div>
                    </div>
                </div>
                <div id="profile-actions">
                    <button id="edit-btn">Edit</button>
                    <button id="save-btn">Save</button>
                    <button id="follow-btn">Follow</button>
                    <button id="message-btn">Message</button>
                </div>
            </div>
            
            <div id="posts-container"></div>
            <div id="divider"></div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="followers-list" id="followers-list">
        <button class="close-list" id="close-followers">×</button>
        <h3 class="list-title">Followers</h3>
        <div id="followers-container"></div>
    </div>
    <div class="following-list" id="following-list">
        <button class="close-list" id="close-following">×</button>
        <h3 class="list-title">Following</h3>
        <div id="following-container"></div>
    </div>
    <div class="messages-list" id="messages-list">
        <button class="close-list" id="close-messages">×</button>
        <h3 class="list-title">Messages</h3>
        <div id="conversations-container"></div>
    </div>
    <div class="messages-list" id="chat-window" style="display:none">
        <button class="close-list" id="close-chat">×</button>
        <h3 class="list-title" id="chat-title">Chat</h3>
        <div class="messages-container" id="messages-container"></div>
        <div class="message-input">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="send-btn">Send</button>
        </div>
    </div>
    <div class="notifications-list" id="notifications-list">
        <button class="close-list" id="close-notifications">×</button>
        <h3 class="list-title">Notifications</h3>
        <div id="notifications-container"></div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = { databaseURL: "https://cloud-fbd6b-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Helper functions
        const formatNumber = num => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const formatTime = timestamp => new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        async function getRobloxUserData(userId) {
            try {
                const corsProxy = 'https://corsproxy.io/?';
                const [userResponse, headshotResponse] = await Promise.all([
                    fetch(`${corsProxy}https://users.roblox.com/v1/users/${userId}`),
                    fetch(`${corsProxy}https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png`)
                ]);
                
                if (userResponse.ok && headshotResponse.ok) {
                    const [userData, headshotData] = await Promise.all([userResponse.json(), headshotResponse.json()]);
                    return {
                        username: userData.name || `User${userId}`,
                        description: userData.description || 'No description available',
                        headshot: headshotData.data[0]?.imageUrl
                    };
                }
            } catch (error) {
                console.log('API request failed, using fallback');
            }
            
            return {
                username: `User${userId}`,
                description: 'Verified Mekhis Creations user',
                headshot: `https://tr.rbxcdn.com/${userId}/150/150/AvatarHeadshot/Png`
            };
        }

        // Theme management
        function applyTheme(theme, mode) {
            document.body.classList.remove('default-theme', 'crimson-theme', 'neon-theme', 'gold-theme', 'silver-theme', 'bronze-theme', 'galaxy-theme', 'dark-mode');
            document.body.classList.add(`${theme}-theme`);
            if (mode === 'dark') document.body.classList.add('dark-mode');
            localStorage.setItem('selectedTheme', theme);
            localStorage.setItem('selectedMode', mode);
            updateThemeMenuSelection(theme, mode);
        }

        function updateThemeMenuSelection(theme, mode) {
            document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
                option.classList.toggle('selected', option.dataset.theme === theme);
            });
            document.querySelectorAll('.theme-option[data-mode]').forEach(option => {
                option.classList.toggle('selected', option.dataset.mode === mode);
            });
        }

        // Initialize theme
        applyTheme(localStorage.getItem('selectedTheme') || 'default', localStorage.getItem('selectedMode') || 'light');

        // Theme button events
        document.getElementById('theme-btn').addEventListener('click', () => {
            document.getElementById('theme-menu').classList.toggle('active');
        });

        document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(option.dataset.theme, localStorage.getItem('selectedMode') || 'light');
            });
        });

        document.querySelectorAll('.theme-option[data-mode]').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(localStorage.getItem('selectedTheme') || 'default', option.dataset.mode);
            });
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.theme-btn') && !e.target.closest('.theme-menu')) {
                document.getElementById('theme-menu').classList.remove('active');
            }
        });

        // Notification Center
        let notifications = [];
        let unreadNotifications = 0;

        function showNotificationsList() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('notifications-list').style.display = 'block';
            renderNotifications();
        }

        function renderNotifications() {
            const notificationsContainer = document.getElementById('notifications-container');
            notificationsContainer.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsContainer.innerHTML = '<p>No notifications yet</p>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = 'list-item';
                notificationElement.innerHTML = `
                    <div style="flex:1">
                        <div>${notification.message}</div>
                        <div style="font-size:12px;color:gray">${new Date(notification.timestamp).toLocaleString()}</div>
                    </div>
                `;
                notificationsContainer.appendChild(notificationElement);
            });
        }

        function addNotification(message, type = 'info', timestamp = Date.now()) {
            const notification = {
                id: Date.now(),
                message,
                type,
                timestamp,
                read: false
            };
            notifications.unshift(notification);
            unreadNotifications++;
            renderNotifications();
            showNotification(message, type);
        }

        // Listen for new followers, likes, messages
        function setupNotificationListener(userId) {
            database.ref(`users/${userId}/followers`).on('child_added', (snapshot) => {
                const followerId = snapshot.key;
                database.ref(`users/${followerId}`).once('value').then(userSnapshot => {
                    if (userSnapshot.exists()) {
                        const user = userSnapshot.val();
                        addNotification(`${user.username} started following you!`, 'success');
                    }
                });
            });

            database.ref(`users/${userId}/notifications`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                addNotification(notification.message, notification.type || 'info', notification.timestamp);
                snapshot.ref.remove();
            });
        }

        // Player search functionality
        document.getElementById('search-btn').addEventListener('click', () => {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) return showNotification('Please enter a username to search', 'error');
            
            database.ref('users').once('value').then(snapshot => {
                const results = [];
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
                        results.push(user);
                    }
                });
                
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = '';
                
                if (results.length > 0) {
                    results.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'search-result';
                        userElement.innerHTML = `
                            <img src="${user.headshot}" width="50" height="50" style="border-radius:50%;margin-right:10px;">
                            <span>${user.username}</span>
                            <button class="view-profile" data-id="${user.userId}">View</button>
                        `;
                        resultsContainer.appendChild(userElement);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<p>No players found matching your search</p>';
                    resultsContainer.style.display = 'block';
                }
            }).catch(error => {
                showNotification('Search failed', 'error');
                console.error('Search error:', error);
            });
        });

        // View profile from search results
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-profile') || e.target.closest('.list-item')) {
                const userId = e.target.classList.contains('view-profile') ? e.target.dataset.id : 
                              e.target.closest('.list-item').querySelector('button')?.dataset.id;
                if (userId) {
                    window.history.pushState({}, '', `/@${encodeURIComponent(userId)}`);
                    loadUserData(userId);
                    document.getElementById('search-results').style.display = 'none';
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('followers-list').style.display = 'none';
                    document.getElementById('following-list').style.display = 'none';
                }
            }
            
            // Click on recommended user
            if (e.target.closest('.recommended-user')) {
                const userId = e.target.closest('.recommended-user').querySelector('img').dataset.id;
                if (userId) {
                    window.history.pushState({}, '', `/@${encodeURIComponent(userId)}`);
                    loadUserData(userId);
                }
            }
        });

        // Follow/unfollow functionality
        function toggleFollow(userId, isFollowing) {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return showNotification('You need to be logged in to follow', 'error');
            
            if (currentUserId === userId) {
                return showNotification("You can't follow yourself!", 'error');
            }
            
            const updates = {};
            updates[`users/${currentUserId}/following/${userId}`] = isFollowing ? null : true;
            updates[`users/${userId}/followers/${currentUserId}`] = isFollowing ? null : true;
            
            database.ref().update(updates)
                .then(() => {
                    showNotification(isFollowing ? 'Unfollowed successfully' : 'Followed successfully', 'success');
                    updateFollowButton(userId, !isFollowing);
                    updateStatsCounters(userId);
                })
                .catch(error => {
                    showNotification(`Error ${isFollowing ? 'unfollowing' : 'following'}`, 'error');
                    console.error('Follow error:', error);
                });
        }

        function updateFollowButton(userId, isFollowing) {
            const followBtn = document.getElementById('follow-btn');
            if (followBtn) {
                followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
                followBtn.style.backgroundColor = isFollowing ? 'var(--accent)' : 'var(--secondary)';
            }
        }

        function updateStatsCounters(userId) {
            database.ref(`users/${userId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
                    const followingCount = userData.following ? Object.keys(userData.following).length : 0;
                    
                    document.getElementById('followers-count').textContent = formatNumber(followersCount);
                    document.getElementById('following-count').textContent = formatNumber(followingCount);
                }
            });
        }

        // Show followers/following lists
        function showFollowersList(userId) {
            database.ref(`users/${userId}/followers`).once('value').then(snapshot => {
                const followersContainer = document.getElementById('followers-container');
                followersContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const followerIds = Object.keys(snapshot.val());
                    if (followerIds.length > 0) {
                        followerIds.forEach(followerId => {
                            database.ref(`users/${followerId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const followerElement = document.createElement('div');
                                    followerElement.className = 'list-item';
                                    followerElement.innerHTML = `
                                        <img src="${user.headshot}" alt="${user.username}">
                                        <span>${user.username}</span>
                                        <button class="view-profile" data-id="${user.userId}">View</button>
                                    `;
                                    followersContainer.appendChild(followerElement);
                                }
                            });
                        });
                    } else {
                        followersContainer.innerHTML = '<p>No followers yet</p>';
                    }
                } else {
                    followersContainer.innerHTML = '<p>No followers yet</p>';
                }
                
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('followers-list').style.display = 'block';
            });
        }

        function showFollowingList(userId) {
            database.ref(`users/${userId}/following`).once('value').then(snapshot => {
                const followingContainer = document.getElementById('following-container');
                followingContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const followingIds = Object.keys(snapshot.val());
                    if (followingIds.length > 0) {
                        followingIds.forEach(followingId => {
                            database.ref(`users/${followingId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const followingElement = document.createElement('div');
                                    followingElement.className = 'list-item';
                                    followingElement.innerHTML = `
                                        <img src="${user.headshot}" alt="${user.username}">
                                        <span>${user.username}</span>
                                        <button class="view-profile" data-id="${user.userId}">View</button>
                                    `;
                                    followingContainer.appendChild(followingElement);
                                }
                            });
                        });
                    } else {
                        followingContainer.innerHTML = '<p>Not following anyone yet</p>';
                    }
                } else {
                    followingContainer.innerHTML = '<p>Not following anyone yet</p>';
                }
                
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('following-list').style.display = 'block';
            });
        }

        // Close list modals
        document.getElementById('close-followers').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('followers-list').style.display = 'none';
        });

        document.getElementById('close-following').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('following-list').style.display = 'none';
        });

        document.getElementById('close-notifications').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('notifications-list').style.display = 'none';
        });

        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('followers-list').style.display = 'none';
            document.getElementById('following-list').style.display = 'none';
            document.getElementById('messages-list').style.display = 'none';
            document.getElementById('chat-window').style.display = 'none';
            document.getElementById('notifications-list').style.display = 'none';
        });

        // Back to profile button
        document.getElementById('back-to-profile').addEventListener('click', () => {
            const userId = localStorage.getItem('robloxUserId');
            if (userId) {
                window.history.pushState({}, '', '/');
                loadUserData(userId);
            }
        });

        // Messaging functionality
        let currentChatId = null;

        function showMessagesList() {
            const userId = localStorage.getItem('robloxUserId');
            if (!userId) return showNotification('You need to be logged in to view messages', 'error');
            
            database.ref(`users/${userId}/conversations`).once('value').then(snapshot => {
                const conversationsContainer = document.getElementById('conversations-container');
                conversationsContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const conversations = snapshot.val();
                    Object.keys(conversations).forEach(otherUserId => {
                        database.ref(`users/${otherUserId}`).once('value').then(userSnapshot => {
                            if (userSnapshot.exists()) {
                                const user = userSnapshot.val();
                                const conversationElement = document.createElement('div');
                                conversationElement.className = 'list-item';
                                conversationElement.innerHTML = `
                                    <img src="${user.headshot}" alt="${user.username}">
                                    <span>${user.username}</span>
                                    <button class="view-chat" data-id="${user.userId}">Chat</button>
                                `;
                                conversationsContainer.appendChild(conversationElement);
                            }
                        });
                    });
                } else {
                    conversationsContainer.innerHTML = '<p>No conversations yet</p>';
                }
                
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('messages-list').style.display = 'block';
                document.getElementById('chat-window').style.display = 'none';
            });
        }

        function showChatWindow(userId) {
            currentChatId = userId;
            database.ref(`users/${userId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const user = snapshot.val();
                    document.getElementById('chat-title').textContent = `Chat with ${user.username}`;
                    loadMessages(userId);
                    document.getElementById('messages-list').style.display = 'none';
                    document.getElementById('chat-window').style.display = 'block';
                }
            });
        }

        function loadMessages(userId) {
            const currentUserId = localStorage.getItem('robloxUserId');
            const chatId = [currentUserId, userId].sort().join('_');
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            database.ref(`chats/${chatId}/messages`).orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
                messagesContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach(childSnapshot => {
                        messages.push(childSnapshot.val());
                    });
                    
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    messages.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.senderId === currentUserId ? 'sent' : 'received'}`;
                        messageElement.innerHTML = `
                            <div>${message.text}</div>
                            <div style="font-size:10px;text-align:right">${formatTime(message.timestamp)}</div>
                        `;
                        messagesContainer.appendChild(messageElement);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId || !currentChatId) return;
            
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            const chatId = [currentUserId, currentChatId].sort().join('_');
            const message = {
                senderId: currentUserId,
                text: messageText,
                timestamp: Date.now()
            };
            
            database.ref(`chats/${chatId}/messages`).push(message)
                .then(() => {
                    messageInput.value = '';
                    // Update conversation for both users
                    const updates = {};
                    updates[`users/${currentUserId}/conversations/${currentChatId}`] = true;
                    updates[`users/${currentChatId}/conversations/${currentUserId}`] = true;
                    database.ref().update(updates);
                    
                    // Send notification
                    const notification = {
                        message: `New message from ${localStorage.getItem('robloxUsername')}`,
                        timestamp: Date.now()
                    };
                    database.ref(`users/${currentChatId}/notifications`).push(notification);
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showNotification('Error sending message', 'error');
                });
        }

        document.getElementById('close-messages').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('messages-list').style.display = 'none';
        });

        document.getElementById('close-chat').addEventListener('click', () => {
            document.getElementById('chat-window').style.display = 'none';
            document.getElementById('messages-list').style.display = 'block';
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-chat')) {
                const userId = e.target.dataset.id;
                showChatWindow(userId);
            }
        });

        // Posts functionality
        function loadPosts(userId = null) {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = '<p>Loading posts...</p>';
            
            let postsRef = database.ref('posts').orderByChild('timestamp').limitToLast(20);
            if (userId) {
                postsRef = database.ref('posts').orderByChild('userId').equalTo(userId).limitToLast(20);
            }
            
            postsRef.once('value').then(snapshot => {
                postsContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const posts = [];
                    snapshot.forEach(childSnapshot => {
                        posts.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (posts.length === 0) {
                        postsContainer.innerHTML = '<p>No posts yet</p>';
                        return;
                    }
                    
                    posts.forEach(post => {
                        database.ref(`users/${post.userId}`).once('value').then(userSnapshot => {
                            if (userSnapshot.exists()) {
                                const user = userSnapshot.val();
                                const currentUserId = localStorage.getItem('robloxUserId');
                                const isLiked = currentUserId && post.likes && post.likes[currentUserId];
                                const isReposted = currentUserId && post.reposts && post.reposts[currentUserId];
                                
                                const postElement = document.createElement('div');
                                postElement.className = 'post-container';
                                postElement.innerHTML = `
                                    <div class="post-header">
                                        <img src="${user.headshot}" width="40" height="40" style="border-radius:50%;margin-right:10px;cursor:pointer" class="view-profile" data-id="${user.userId}">
                                        <div>
                                            <div class="post-user view-profile" data-id="${user.userId}">${user.username}</div>
                                            <div class="post-time">${new Date(post.timestamp).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div class="post-content">${post.content}</div>
                                    <div class="post-actions">
                                        <div class="post-action like-post ${isLiked ? 'liked' : ''}" data-id="${post.id}">
                                            ❤️ <span>${post.likes ? Object.keys(post.likes).length : 0}</span>
                                        </div>
                                        <div class="post-action repost-post ${isReposted ? 'reposted' : ''}" data-id="${post.id}">
                                            🔄 <span>${post.reposts ? Object.keys(post.reposts).length : 0}</span>
                                        </div>
                                        <div class="post-action">
                                            👁️ <span>${post.views || 0}</span>
                                        </div>
                                    </div>
                                `;
                                postsContainer.appendChild(postElement);
                                
                                // Track view
                                database.ref(`posts/${post.id}/views`).transaction(views => (views || 0) + 1);
                            }
                        });
                    });
                } else {
                    postsContainer.innerHTML = '<p>No posts yet</p>';
                }
            });
        }

        document.getElementById('post-btn').addEventListener('click', () => {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return showNotification('You need to be logged in to post', 'error');
            
            const postContent = document.getElementById('post-content').value.trim();
            if (!postContent) return showNotification('Post cannot be empty', 'error');
            
            const post = {
                userId: currentUserId,
                content: postContent,
                timestamp: Date.now(),
                likes: {},
                reposts: {},
                views: 0
            };
            
            database.ref('posts').push(post)
                .then(() => {
                    document.getElementById('post-content').value = '';
                    showNotification('Posted successfully!', 'success');
                    loadPosts();
                })
                .catch(error => {
                    console.error('Error posting:', error);
                    showNotification('Error creating post', 'error');
                });
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('like-post') || e.target.closest('.like-post')) {
                const postId = e.target.classList.contains('like-post') ? e.target.dataset.id : e.target.closest('.like-post').dataset.id;
                const currentUserId = localStorage.getItem('robloxUserId');
                if (!currentUserId) return showNotification('You need to be logged in to like posts', 'error');
                
                database.ref(`posts/${postId}/likes/${currentUserId}`).transaction(like => {
                    if (like === null) {
                        return true;
                    } else {
                        return null;
                    }
                });
            }
            
            if (e.target.classList.contains('repost-post') || e.target.closest('.repost-post')) {
                const postId = e.target.classList.contains('repost-post') ? e.target.dataset.id : e.target.closest('.repost-post').dataset.id;
                const currentUserId = localStorage.getItem('robloxUserId');
                if (!currentUserId) return showNotification('You need to be logged in to repost', 'error');
                
                database.ref(`posts/${postId}/reposts/${currentUserId}`).transaction(repost => {
                    if (repost === null) {
                        // Create a new repost
                        database.ref(`posts/${postId}`).once('value').then(snapshot => {
                            if (snapshot.exists()) {
                                const originalPost = snapshot.val();
                                const repost = {
                                    userId: currentUserId,
                                    content: originalPost.content,
                                    timestamp: Date.now(),
                                    originalPostId: postId,
                                    likes: {},
                                    reposts: {},
                                    views: 0
                                };
                                
                                database.ref('posts').push(repost)
                                    .then(() => {
                                        showNotification('Reposted successfully!', 'success');
                                    });
                            }
                        });
                        return true;
                    } else {
                        // Remove the repost
                        return null;
                    }
                });
            }
        });

        // Recommended profiles
        function loadRecommendedProfiles() {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return;
            
            database.ref('users').limitToLast(5).once('value').then(snapshot => {
                const recommendedContainer = document.getElementById('recommended-users');
                recommendedContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        if (user.userId !== currentUserId) {
                            const userElement = document.createElement('div');
                            userElement.className = 'recommended-user';
                            userElement.innerHTML = `
                                <img src="${user.headshot}" alt="${user.username}" data-id="${user.userId}">
                                <span>${user.username}</span>
                            `;
                            recommendedContainer.appendChild(userElement);
                        }
                    });
                }
            });
        }

        // Onboarding flow functions
        function updateProgress(step) {
            const progressBar = document.getElementById('progress');
            if (progressBar) progressBar.style.width = step * 33.33 + '%';
        }

        function showStep(stepId, progressStep) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
                updateProgress(progressStep);
            }
        }

        function generateVerificationCode() {
            const codeTextElement = document.getElementById('code-text');
            if (codeTextElement) {
                const code = Math.floor(10000 + 90000 * Math.random());
                codeTextElement.textContent = code;
                localStorage.setItem('verificationCode', code.toString());
                return code;
            }
            return null;
        }

        function showHomeContent() {
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('home-content').style.display = 'block';
            document.getElementById('create-post').style.display = 'block';
            
            const userId = localStorage.getItem('robloxUserId');
            if (userId) {
                loadUserData(userId);
                loadPosts();
                loadRecommendedProfiles();
                setupNotificationListener(userId);
            }
            
            const path = window.location.pathname;
            if (path.startsWith('/@')) {
                const username = decodeURIComponent(path.substring(2));
                searchUserByUsername(username);
            }
        }

        async function searchUserByUsername(username) {
            try {
                const snapshot = await database.ref('users').once('value');
                let foundUser = null;
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.username.toLowerCase() === username.toLowerCase()) {
                        foundUser = user;
                    }
                });
                
                if (foundUser) {
                    loadUserData(foundUser.userId, false);
                } else {
                    showNotification('User not found', 'error');
                    window.history.pushState({}, '', '/');
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            } catch (error) {
                console.error('Search error:', error);
                showNotification('Error searching for user', 'error');
            }
        }

        function loadUserData(userId, isCurrentUser = null) {
            if (isCurrentUser === null) {
                isCurrentUser = userId === localStorage.getItem('robloxUserId');
            }
            
            database.ref('users/' + userId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    updateProfileUI(userData, isCurrentUser);
                    
                    if (!isCurrentUser && localStorage.getItem('robloxUserId')) {
                        const currentUserId = localStorage.getItem('robloxUserId');
                        database.ref(`users/${currentUserId}/following/${userId}`).once('value').then(followSnapshot => {
                            updateFollowButton(userId, followSnapshot.exists());
                        });
                    }
                } else if (isCurrentUser) {
                    createNewUser(userId);
                } else {
                    showNotification('Profile not found', 'error');
                    window.history.pushState({}, '', '/');
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            }).catch(error => {
                console.error("Database error:", error);
                showNotification('Error loading profile', 'error');
            });
        }

        function createNewUser(userId) {
            const userData = {
                userId: userId,
                username: localStorage.getItem('robloxUsername') || `User${userId.slice(0, 4)}`,
                headshot: localStorage.getItem('robloxHeadshot') || `https://www.roblox.com/headshot-thumbnail/image?userId=${userId}&width=150&height=150&format=png`,
                description: "",
                followers: {},
                following: {},
                createdAt: Date.now()
            };
            
            database.ref('users/' + userId).set(userData)
                .then(() => {
                    updateProfileUI(userData, true);
                    setupNotificationListener(userId);
                })
                .catch(error => {
                    console.error("Create user error:", error);
                    showNotification('Error creating profile', 'error');
                });
        }

        function updateProfileUI(userData, isCurrentUser) {
            document.getElementById('profile-headshot').src = userData.headshot;
            document.getElementById('profile-username').textContent = userData.username;
            document.getElementById('profile-description').textContent = userData.description || 'No description yet';
            
            const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
            const followingCount = userData.following ? Object.keys(userData.following).length : 0;
            document.getElementById('followers-count').textContent = formatNumber(followersCount);
            document.getElementById('following-count').textContent = formatNumber(followingCount);
            
            document.getElementById('followers-count').onclick = () => showFollowersList(userData.userId);
            document.getElementById('following-count').onclick = () => showFollowingList(userData.userId);
            
            document.getElementById('edit-btn').style.display = isCurrentUser ? 'inline-block' : 'none';
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('follow-btn').style.display = isCurrentUser ? 'none' : 'inline-block';
            document.getElementById('message-btn').style.display = isCurrentUser ? 'none' : 'inline-block';
            document.getElementById('back-to-profile').style.display = isCurrentUser ? 'none' : 'block';
            document.getElementById('profile-description').contentEditable = false;
            
            if (!isCurrentUser) {
                document.getElementById('follow-btn').onclick = () => {
                    const currentUserId = localStorage.getItem('robloxUserId');
                    if (!currentUserId) return showNotification('You need to be logged in to follow', 'error');
                    
                    database.ref(`users/${currentUserId}/following/${userData.userId}`).once('value').then(snapshot => {
                        toggleFollow(userData.userId, snapshot.exists());
                    });
                };
                
                document.getElementById('message-btn').onclick = () => {
                    showChatWindow(userData.userId);
                    document.getElementById('overlay').style.display = 'block';
                };
            }
            
            if (isCurrentUser) {
                document.getElementById('sidebar-headshot').src = userData.headshot;
                document.getElementById('sidebar-username').textContent = userData.username;
                loadPosts(userData.userId);
            } else {
                loadPosts(userData.userId);
            }
            
            if (isCurrentUser && !window.location.pathname.startsWith('/@')) {
                window.history.pushState({}, '', `/@${encodeURIComponent(userData.username)}`);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Confirm ID button
            document.getElementById('confirm-id')?.addEventListener('click', async () => {
                const userId = document.getElementById('roblox-id').value.trim();
                if (!userId) return showNotification('Please enter a Roblox ID', 'error');
                
                try {
                    const userData = await getRobloxUserData(userId);
                    
                    document.getElementById('username').textContent = userData.username;
                    document.getElementById('description').textContent = userData.description || '(No description)';
                    document.getElementById('headshot').src = userData.headshot;
                    
                    localStorage.setItem('tempUserId', userId);
                    localStorage.setItem('tempUsername', userData.username);
                    localStorage.setItem('tempHeadshot', userData.headshot);
                    
                    showStep('step2', 2);
                } catch(error) {
                    showNotification("Couldn't find that user. Please check the ID", 'error');
                }
            });

            // Other buttons
            document.getElementById('yes-btn')?.addEventListener('click', () => {
                generateVerificationCode();
                showStep('step3', 3);
            });

            document.getElementById('no-btn')?.addEventListener('click', () => {
                showStep('step1', 1);
            });

            document.getElementById('back-btn')?.addEventListener('click', () => {
                showStep('step2', 2);
            });

            document.getElementById('verify-btn')?.addEventListener('click', async () => {
                const userId = localStorage.getItem('tempUserId');
                localStorage.setItem('newUser', 'false');
                localStorage.setItem('robloxUserId', userId);
                localStorage.setItem('robloxUsername', localStorage.getItem('tempUsername'));
                localStorage.setItem('robloxHeadshot', localStorage.getItem('tempHeadshot'));
                
                ['tempUserId', 'tempUsername', 'tempHeadshot', 'verificationCode'].forEach(item => {
                    localStorage.removeItem(item);
                });
                
                document.getElementById('verification-status').textContent = 'Verification successful!';
                setTimeout(showHomeContent, 1500);
            });

            document.getElementById('go-home-btn')?.addEventListener('click', showHomeContent);

            // Edit profile
            document.getElementById('edit-btn')?.addEventListener('click', () => {
                const desc = document.getElementById('profile-description');
                desc.contentEditable = true;
                desc.focus();
                document.getElementById('edit-btn').style.display = 'none';
                document.getElementById('save-btn').style.display = 'inline-block';
            });

            document.getElementById('save-btn')?.addEventListener('click', () => {
                const desc = document.getElementById('profile-description');
                const userId = localStorage.getItem('robloxUserId');
                const text = desc.textContent;
                desc.contentEditable = false;
                document.getElementById('edit-btn').style.display = 'inline-block';
                document.getElementById('save-btn').style.display = 'none';
                
                database.ref('users/' + userId).update({ description: text })
                    .then(() => showNotification('Description saved successfully!', 'success'))
                    .catch(error => {
                        console.error("Save error:", error);
                        showNotification('Error saving description', 'error');
                    });
            });

            // Copy verification code
            document.querySelector('.copy-btn')?.addEventListener('click', () => {
                const code = document.getElementById('code-text').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    document.querySelector('.copy-btn').textContent = 'Copied!';
                    setTimeout(() => {
                        document.querySelector('.copy-btn').textContent = 'Copy';
                    }, 2000);
                });
            });

            // Sidebar navigation
            document.getElementById('home-btn').addEventListener('click', () => {
                window.history.pushState({}, '', '/');
                loadPosts(); // Load global feed
                document.getElementById('back-to-profile').style.display = 'block';
            });

            document.getElementById('messages-btn').addEventListener('click', showMessagesList);
            document.getElementById('notifications-btn').addEventListener('click', showNotificationsList);

            // Handle back/forward navigation
            window.addEventListener('popstate', () => {
                const path = window.location.pathname;
                if (path.startsWith('/@')) {
                    const username = decodeURIComponent(path.substring(2));
                    searchUserByUsername(username);
                } else {
                    loadPosts(); // Load global feed
                    document.getElementById('back-to-profile').style.display = 'block';
                }
            });

            // Initialize app state
            if (localStorage.getItem('newUser') === 'false') {
                showHomeContent();
            } else {
                localStorage.setItem('newUser', 'true');
                generateVerificationCode();
            }
        });
    </script>
</body>
</html>
