<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekhis Creations</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root{--primary:#4285F4;--secondary:#34A853;--accent:#EA4335;--text:#202124;--bg:#F8F9FA;--card-bg:#fff;--btn-text:#fff;--input-bg:#fff;--notification-success:#34A853;--notification-error:#EA4335;--notification-info:#4285F4;--theme-dark-text:#F8F9FA;--theme-dark-bg:#202124;--theme-dark-card:#303134;--crimson:#DC143C;--neon-primary:#00F0FF;--neon-secondary:#FF00F0;--neon-accent:#F0FF00;--gold:#FFD700;--silver:#C0C0C0;--bronze:#CD7F32;--galaxy-primary:#9D00FF;--galaxy-secondary:#00D1FF;--galaxy-accent:#FF00F5}
        body{font-family:'Fredoka One',cursive;color:var(--text);margin:0;min-height:100vh;display:flex;transition:all 0.3s;background:var(--bg)}
        
        /* Sidebar styles */
        .sidebar{width:220px;position:fixed;left:0;top:0;bottom:0;background:var(--card-bg);border-right:1px solid rgba(0,0,0,0.1);padding:15px;overflow-y:auto;z-index:100}
        .sidebar-profile{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;cursor:pointer}
        .sidebar-profile img{width:80px;height:80px;border-radius:50%;border:3px solid var(--primary);object-fit:cover}
        .sidebar-profile span{margin-top:10px;font-size:16px;color:var(--primary)}
        .sidebar-nav{display:flex;flex-direction:column;gap:10px}
        .sidebar-nav button{background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:10px;cursor:pointer;font-family:'Fredoka One',cursive;text-align:left}
        .recommended-profiles{margin-top:20px}
        .recommended-title{font-size:14px;color:var(--primary);margin-bottom:10px}
        .recommended-user{display:flex;align-items:center;padding:8px;border-radius:10px;margin-bottom:8px;cursor:pointer}
        .recommended-user:hover{background:rgba(0,0,0,0.05)}
        .recommended-user img{width:40px;height:40px;border-radius:50%;margin-right:10px;border:2px solid var(--primary)}
        
        /* Main content styles */
        .main-content{margin-left:220px;flex:1;padding:20px;max-width:800px;margin:0 auto;width:100%}
        .page{display:none}
        .page.active{display:block}
        
        /* Common elements */
        .progress-bar{height:10px;background:rgba(0,0,0,0.1);border-radius:5px;margin:20px 0;overflow:hidden}
        .progress{height:100%;background:var(--secondary);width:0%;transition:width 0.5s}
        h1,h2{color:var(--primary);text-shadow:2px 2px 0 rgba(0,0,0,0.1)}
        button{font-family:'Fredoka One',cursive;background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:12px 24px;margin:5px;cursor:pointer;font-size:16px;transition:all 0.2s;box-shadow:0 4px 0 rgba(0,0,0,0.1);min-width:120px}
        button:hover{transform:translateY(-2px);box-shadow:0 6px 0 rgba(0,0,0,0.1)}
        button:active{transform:translateY(1px);box-shadow:0 2px 0 rgba(0,0,0,0.1)}
        #no-btn{background:var(--accent)}#yes-btn,#verify-btn{background:var(--secondary)}
        .back-btn{background:transparent;color:var(--accent);box-shadow:none;text-decoration:underline;padding:8px;min-width:auto}
        input,textarea{font-family:'Fredoka One',cursive;padding:12px;border:3px solid var(--primary);border-radius:15px;width:100%;font-size:16px;margin:15px 0;background:var(--input-bg)}
        textarea{min-height:100px;resize:vertical}
        
        /* Profile card */
        .profile-card{background:var(--card-bg);border-radius:20px;padding:20px;margin:20px auto;max-width:500px;box-shadow:0 5px 15px rgba(0,0,0,0.05);text-align:center}
        .profile-card img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--primary);margin-bottom:15px}
        .profile-card h2{font-size:22px;color:var(--primary);margin-bottom:15px}
        .profile-description{background:var(--bg);padding:15px;border-radius:10px;margin:15px 0;min-height:60px}
        .profile-stats{display:flex;justify-content:space-around;margin:15px 0}
        .stat-value{font-size:20px;font-weight:bold;color:var(--primary);cursor:pointer;transition:all 0.2s}
        .stat-value:hover{transform:scale(1.05);text-decoration:underline}
        .stat-label{font-size:14px;color:var(--text)}
        .profile-actions{display:flex;justify-content:center;gap:10px;margin-top:15px}
        
        /* Posts */
        .post-container{background:var(--card-bg);border-radius:15px;padding:15px;margin:15px auto;max-width:500px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .post-header{display:flex;align-items:center;margin-bottom:10px}
        .post-user{font-weight:bold;color:var(--primary);cursor:pointer}
        .post-time{font-size:12px;color:gray;margin-left:10px}
        .post-content{margin-bottom:15px}
        .post-actions{display:flex;justify-content:space-around}
        .post-action{display:flex;align-items:center;cursor:pointer;padding:5px 10px;border-radius:50px}
        .post-action:hover{background:rgba(0,0,0,0.05)}
        .post-action span{margin-left:5px}
        .post-action.liked{color:var(--accent)}
        .post-action.reposted{color:var(--secondary)}
        .repost-info{font-size:12px;color:var(--primary);margin-bottom:5px;display:flex;align-items:center}
        .repost-info i{margin-right:5px}
        .create-post{background:var(--card-bg);border-radius:15px;padding:15px;margin:15px auto;max-width:500px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        
        /* Search */
        .search-container{margin:20px auto;max-width:500px}
        .search-tabs{display:flex;justify-content:center;margin-bottom:15px}
        .search-tab{background:var(--primary);color:white;border:none;border-radius:50px;padding:8px 16px;margin:0 5px;cursor:pointer}
        .search-tab.active{background:var(--secondary)}
        .search-result{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .search-result:hover{background:rgba(0,0,0,0.05)}
        .search-result:last-child{border-bottom:none}
        .search-result img{width:40px;height:40px;border-radius:50%;margin-right:10px;border:2px solid var(--primary)}
        .search-result button{margin-left:auto;padding:5px 10px;font-size:12px;min-width:auto;border-radius:50px}
        
        /* Messages */
        .messages-container{max-height:calc(100vh - 200px);overflow-y:auto;margin-bottom:15px}
        .message{background:var(--bg);padding:10px;border-radius:10px;margin:5px 0;max-width:80%}
        .message.sent{align-self:flex-end;background:var(--primary);color:white}
        .message.received{align-self:flex-start}
        .message-input{display:flex;margin-top:15px}
        .message-input input{flex:1;margin-right:10px}
        
        /* Lists (followers, following, notifications) */
        .list-container{max-width:500px;margin:0 auto}
        .list-item{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .list-item:hover{background:rgba(0,0,0,0.05)}
        .list-item:last-child{border-bottom:none}
        .list-item img{width:40px;height:40px;border-radius:50%;margin-right:10px}
        
        /* Notification */
        .notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:50px;color:white;font-weight:bold;box-shadow:0 3px 10px rgba(0,0,0,0.2);z-index:1000;animation:slideIn 0.3s,fadeOut 0.5s 2.5s forwards}
        .notification.success{background-color:var(--notification-success)}.notification.error{background-color:var(--notification-error)}.notification.info{background-color:var(--notification-info)}
        
        /* Theme controls */
        .version{position:fixed;bottom:10px;left:10px;font-size:12px;opacity:0.7}
        .theme-btn{position:fixed;bottom:10px;right:10px;font-size:12px;padding:8px 12px;border-radius:50px}
        .theme-menu{position:fixed;bottom:40px;right:10px;background:var(--card-bg);border-radius:15px;padding:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:100;width:200px;display:none}
        .theme-menu.active{display:block}
        .theme-section{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(0,0,0,0.1)}
        .theme-section-title{font-weight:bold;margin-bottom:5px;font-size:14px}
        .theme-option{padding:5px 10px;cursor:pointer;border-radius:50px;margin:2px 0;font-size:12px;text-align:center}
        .theme-option:hover{background:rgba(0,0,0,0.1)}.theme-option.selected{background:var(--primary);color:var(--btn-text)}
        
        /* Special themes */
        body.galaxy-theme{--primary:#9D00FF;--secondary:#00D1FF;--accent:#FF00F5;--notification-success:#00FF88;--notification-error:#FF006E;--notification-info:#7700FF}
        body.galaxy-theme.dark-mode{--text:#FFFFFF;--bg:#0A0A1A;--card-bg:#1A1A2A;background:radial-gradient(circle at center,#0A0A1A,#000000)}
        
        /* Animations */
        @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-5px)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{opacity:0;transform:translate(-50%,-30px)}to{opacity:1;transform:translate(-50%,0)}}
        @keyframes fadeOut{from{opacity:1}to{opacity:0}}
        @keyframes galaxyPulse{0%,100%{box-shadow:0 0 10px 5px var(--galaxy-primary)}50%{box-shadow:0 0 20px 10px var(--galaxy-secondary)}}
        .galaxy-pulse{animation:galaxyPulse 3s infinite}
    </style>
</head>
<body class="default-theme">
    <div class="version">Mekhis Creations v2.1</div>
    <button class="theme-btn" id="theme-btn">Themes</button>
    <div class="theme-menu" id="theme-menu">
        <div class="theme-section">
            <div class="theme-section-title">Color Themes</div>
            <div class="theme-option selected" data-theme="default">Default</div>
            <div class="theme-option" data-theme="crimson">Crimson</div>
            <div class="theme-option" data-theme="neon">Neon</div>
            <div class="theme-option" data-theme="gold">Gold</div>
            <div class="theme-option" data-theme="silver">Silver</div>
            <div class="theme-option" data-theme="bronze">Bronze</div>
            <div class="theme-option" data-theme="galaxy">Galaxy</div>
        </div>
        <div class="theme-section">
            <div class="theme-section-title">Appearance</div>
            <div class="theme-option" data-mode="light">Light Mode</div>
            <div class="theme-option" data-mode="dark">Dark Mode</div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-profile" id="sidebar-profile">
            <img id="sidebar-headshot" src="" alt="Profile">
            <span id="sidebar-username">Loading...</span>
        </div>
        <div class="sidebar-nav">
            <button id="home-btn">🏠 Home</button>
            <button id="messages-btn">💬 Messages</button>
            <button id="notifications-btn">🔔 Notifications</button>
            <button id="search-btn-nav">🔍 Search</button>
        </div>
        <div class="recommended-profiles">
            <div class="recommended-title">Recommended Profiles</div>
            <div id="recommended-users"></div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Onboarding Pages -->
        <div id="onboarding">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            
            <div id="step1" class="page active">
                <h1>Welcome to Mekhis Creations!</h1>
                <div class="bounce">👋</div>
                <p>Let's get you set up!</p>
                <p>First, enter your Roblox User ID below:</p>
                <input type="text" id="roblox-id" placeholder="123456789">
                <button id="confirm-id">Let's Go!</button>
            </div>
            
            <div id="step2" class="page">
                <h2>Is this you?</h2>
                <div class="profile-card">
                    <img id="headshot" src="" alt="Roblox avatar">
                    <h2 id="username"></h2>
                    <div class="profile-description" id="description"></div>
                </div>
                <div style="text-align:center">
                    <button id="yes-btn">Yes, that's me!</button>
                    <button id="no-btn">No, try again</button>
                </div>
            </div>
            
            <div id="step3" class="page">
                <h2>Almost there!</h2>
                <p>Let's verify this is really you:</p>
                <ol style="text-align:left;display:inline-block">
                    <li>Copy this code</li>
                    <li>Paste it in your Roblox profile description</li>
                    <li>Click verify when done</li>
                </ol>
                <div style="display:flex;justify-content:center;gap:10px;margin:20px 0">
                    <div id="verification-code" style="font-size:32px;letter-spacing:5px;color:var(--secondary);background:var(--card-bg);padding:15px 20px;border-radius:10px;display:flex;align-items:center">
                        <span id="code-text"></span>
                        <button class="copy-btn" style="background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:5px 10px;font-size:12px;cursor:pointer;margin-left:10px">Copy</button>
                    </div>
                </div>
                <div style="text-align:center;margin-top:15px">
                    <button id="verify-btn">Verify</button>
                    <button class="back-btn" id="back-btn">Back</button>
                </div>
                <div id="verification-status" style="text-align:center;min-height:24px;color:var(--accent);margin-top:10px"></div>
            </div>
        </div>
        
        <!-- Main App Pages -->
        <div id="home-page" class="page">
            <div class="create-post">
                <textarea id="post-content" placeholder="What's on your mind?"></textarea>
                <button id="post-btn">Post</button>
            </div>
            
            <div id="posts-container"></div>
        </div>
        
        <div id="profile-page" class="page">
            <button class="back-btn" id="back-to-home">← Back to Home</button>
            <div class="profile-card">
                <img id="profile-headshot" src="" alt="Profile picture">
                <h2 id="profile-username"></h2>
                <div class="profile-description" id="profile-description">Loading description...</div>
                <div class="profile-stats">
                    <div>
                        <div class="stat-value" id="followers-count">0</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div>
                        <div class="stat-value" id="following-count">0</div>
                        <div class="stat-label">Following</div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="edit-btn">Edit</button>
                    <button id="save-btn">Save</button>
                    <button id="follow-btn">Follow</button>
                    <button id="message-btn">Message</button>
                </div>
            </div>
            
            <div id="profile-posts-container"></div>
        </div>
        
        <div id="messages-page" class="page">
            <button class="back-btn" id="back-to-home-from-messages">← Back to Home</button>
            <h2>Your Conversations</h2>
            <div id="conversations-container" class="list-container"></div>
            
            <div id="chat-container" style="display:none">
                <button class="back-btn" id="back-to-conversations">← Back to Conversations</button>
                <h2 id="chat-title">Chat</h2>
                <div class="messages-container" id="messages-container"></div>
                <div class="message-input">
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <button id="send-btn">Send</button>
                </div>
            </div>
        </div>
        
        <div id="notifications-page" class="page">
            <button class="back-btn" id="back-to-home-from-notifications">← Back to Home</button>
            <h2>Notifications</h2>
            <div id="notifications-container" class="list-container"></div>
        </div>
        
        <div id="search-page" class="page">
            <button class="back-btn" id="back-to-home-from-search">← Back to Home</button>
            <div class="search-container">
                <div style="display:flex;margin-bottom:20px">
                    <input type="text" id="search-input" placeholder="Search players by username" style="flex:1;margin-right:10px">
                    <button id="search-btn">Search</button>
                </div>
                
                <div class="search-tabs">
                    <button class="search-tab active" id="users-tab">Users</button>
                    <button class="search-tab" id="posts-tab">Posts</button>
                </div>
                
                <div id="search-users-container"></div>
                <div id="search-posts-container" style="display:none"></div>
            </div>
        </div>
        
        <div id="followers-page" class="page">
            <button class="back-btn" id="back-to-profile-from-followers">← Back to Profile</button>
            <h2>Followers</h2>
            <div id="followers-container" class="list-container"></div>
        </div>
        
        <div id="following-page" class="page">
            <button class="back-btn" id="back-to-profile-from-following">← Back to Profile</button>
            <h2>Following</h2>
            <div id="following-container" class="list-container"></div>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification" style="display:none"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = { databaseURL: "https://cloud-fbd6b-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Helper functions
        const formatNumber = num => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const formatTime = timestamp => new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        async function getRobloxUserData(userId) {
            try {
                const corsProxy = 'https://corsproxy.io/?';
                const [userResponse, headshotResponse] = await Promise.all([
                    fetch(`${corsProxy}https://users.roblox.com/v1/users/${userId}`),
                    fetch(`${corsProxy}https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png`)
                ]);
                
                if (userResponse.ok && headshotResponse.ok) {
                    const [userData, headshotData] = await Promise.all([userResponse.json(), headshotResponse.json()]);
                    return {
                        username: userData.name || `User${userId}`,
                        description: userData.description || 'No description available',
                        headshot: headshotData.data[0]?.imageUrl
                    };
                }
            } catch (error) {
                console.log('API request failed, using fallback');
            }
            
            return {
                username: `User${userId}`,
                description: 'Verified Mekhis Creations user',
                headshot: `https://tr.rbxcdn.com/${userId}/150/150/AvatarHeadshot/Png`
            };
        }

        // Theme management
        function applyTheme(theme, mode) {
            document.body.classList.remove('default-theme', 'crimson-theme', 'neon-theme', 'gold-theme', 'silver-theme', 'bronze-theme', 'galaxy-theme', 'dark-mode');
            document.body.classList.add(`${theme}-theme`);
            if (mode === 'dark') document.body.classList.add('dark-mode');
            localStorage.setItem('selectedTheme', theme);
            localStorage.setItem('selectedMode', mode);
            updateThemeMenuSelection(theme, mode);
        }

        function updateThemeMenuSelection(theme, mode) {
            document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
                option.classList.toggle('selected', option.dataset.theme === theme);
            });
            document.querySelectorAll('.theme-option[data-mode]').forEach(option => {
                option.classList.toggle('selected', option.dataset.mode === mode);
            });
        }

        // Initialize theme
        applyTheme(localStorage.getItem('selectedTheme') || 'default', localStorage.getItem('selectedMode') || 'light');

        // Theme button events
        document.getElementById('theme-btn').addEventListener('click', () => {
            document.getElementById('theme-menu').classList.toggle('active');
        });

        document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(option.dataset.theme, localStorage.getItem('selectedMode') || 'light');
            });
        });

        document.querySelectorAll('.theme-option[data-mode]').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(localStorage.getItem('selectedTheme') || 'default', option.dataset.mode);
            });
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.theme-btn') && !e.target.closest('.theme-menu')) {
                document.getElementById('theme-menu').classList.remove('active');
            }
        });

        // Notification Center
        let notifications = [];
        let unreadNotifications = 0;

        function renderNotifications() {
            const notificationsContainer = document.getElementById('notifications-container');
            notificationsContainer.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsContainer.innerHTML = '<p>No notifications yet</p>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = 'list-item';
                notificationElement.innerHTML = `
                    <div style="flex:1">
                        <div>${notification.message}</div>
                        <div style="font-size:12px;color:gray">${new Date(notification.timestamp).toLocaleString()}</div>
                    </div>
                `;
                notificationsContainer.appendChild(notificationElement);
            });
        }

        function addNotification(message, type = 'info', timestamp = Date.now()) {
            const notification = {
                id: Date.now(),
                message,
                type,
                timestamp,
                read: false
            };
            notifications.unshift(notification);
            unreadNotifications++;
            renderNotifications();
            showNotification(message, type);
        }

        // Listen for new followers, likes, messages
        function setupNotificationListener(userId) {
            database.ref(`users/${userId}/followers`).on('child_added', (snapshot) => {
                const followerId = snapshot.key;
                database.ref(`users/${followerId}`).once('value').then(userSnapshot => {
                    if (userSnapshot.exists()) {
                        const user = userSnapshot.val();
                        addNotification(`${user.username} started following you!`, 'success');
                    }
                });
            });

            database.ref(`users/${userId}/notifications`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                addNotification(notification.message, notification.type || 'info', notification.timestamp);
                snapshot.ref.remove();
            });
        }

        // Search functionality
        function performSearch(searchTerm) {
            if (!searchTerm) return showNotification('Please enter a search term', 'error');
            
            // Switch to search page
            showPage('search-page');
            document.getElementById('users-tab').classList.add('active');
            document.getElementById('posts-tab').classList.remove('active');
            document.getElementById('search-users-container').style.display = 'block';
            document.getElementById('search-posts-container').style.display = 'none';
            
            // Search users
            database.ref('users').once('value').then(snapshot => {
                const usersContainer = document.getElementById('search-users-container');
                usersContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
                            users.push(user);
                        }
                    });
                    
                    if (users.length > 0) {
                        users.forEach(user => {
                            const userElement = document.createElement('div');
                            userElement.className = 'search-result';
                            userElement.innerHTML = `
                                <img src="${user.headshot}" alt="${user.username}">
                                <span>${user.username}</span>
                                <button class="view-profile" data-id="${user.userId}">View</button>
                            `;
                            usersContainer.appendChild(userElement);
                        });
                    } else {
                        usersContainer.innerHTML = '<p>No users found matching your search</p>';
                    }
                }
            });
            
            // Search posts
            database.ref('posts').once('value').then(snapshot => {
                const postsContainer = document.getElementById('search-posts-container');
                postsContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const posts = [];
                    snapshot.forEach(childSnapshot => {
                        const post = { id: childSnapshot.key, ...childSnapshot.val() };
                        if (post.content.toLowerCase().includes(searchTerm.toLowerCase())) {
                            posts.push(post);
                        }
                    });
                    
                    if (posts.length > 0) {
                        posts.sort((a, b) => b.timestamp - a.timestamp);
                        posts.forEach(post => {
                            database.ref(`users/${post.userId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const currentUserId = localStorage.getItem('robloxUserId');
                                    const isLiked = currentUserId && post.likes && post.likes[currentUserId];
                                    const isReposted = currentUserId && post.reposts && post.reposts[currentUserId];
                                    
                                    const postElement = document.createElement('div');
                                    postElement.className = 'post-container';
                                    postElement.innerHTML = `
                                        <div class="post-header">
                                            <img src="${user.headshot}" width="40" height="40" style="border-radius:50%;margin-right:10px;cursor:pointer" class="view-profile" data-id="${user.userId}">
                                            <div>
                                                <div class="post-user view-profile" data-id="${user.userId}">${user.username}</div>
                                                <div class="post-time">${new Date(post.timestamp).toLocaleString()}</div>
                                            </div>
                                        </div>
                                        <div class="post-content">${post.content}</div>
                                        <div class="post-actions">
                                            <div class="post-action like-post ${isLiked ? 'liked' : ''}" data-id="${post.id}">
                                                ❤️ <span>${post.likes ? formatNumber(Object.keys(post.likes).length) : 0}</span>
                                            </div>
                                            <div class="post-action repost-post ${isReposted ? 'reposted' : ''}" data-id="${post.id}">
                                                🔄 <span>${post.reposts ? formatNumber(Object.keys(post.reposts).length) : 0}</span>
                                            </div>
                                            <div class="post-action">
                                                👁️ <span>${post.views ? formatNumber(post.views) : 0}</span>
                                            </div>
                                        </div>
                                    `;
                                    postsContainer.appendChild(postElement);
                                }
                            });
                        });
                    } else {
                        postsContainer.innerHTML = '<p>No posts found matching your search</p>';
                    }
                }
            });
        }

        // Search tabs
        document.getElementById('users-tab').addEventListener('click', () => {
            document.getElementById('users-tab').classList.add('active');
            document.getElementById('posts-tab').classList.remove('active');
            document.getElementById('search-users-container').style.display = 'block';
            document.getElementById('search-posts-container').style.display = 'none';
        });

        document.getElementById('posts-tab').addEventListener('click', () => {
            document.getElementById('posts-tab').classList.add('active');
            document.getElementById('users-tab').classList.remove('active');
            document.getElementById('search-posts-container').style.display = 'block';
            document.getElementById('search-users-container').style.display = 'none';
        });

        // Follow/unfollow functionality
        function toggleFollow(userId, isFollowing) {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return showNotification('You need to be logged in to follow', 'error');
            
            if (currentUserId === userId) {
                return showNotification("You can't follow yourself!", 'error');
            }
            
            const updates = {};
            updates[`users/${currentUserId}/following/${userId}`] = isFollowing ? null : true;
            updates[`users/${userId}/followers/${currentUserId}`] = isFollowing ? null : true;
            
            database.ref().update(updates)
                .then(() => {
                    showNotification(isFollowing ? 'Unfollowed successfully' : 'Followed successfully', 'success');
                    updateFollowButton(userId, !isFollowing);
                    updateStatsCounters(userId);
                })
                .catch(error => {
                    showNotification(`Error ${isFollowing ? 'unfollowing' : 'following'}`, 'error');
                    console.error('Follow error:', error);
                });
        }

        function updateFollowButton(userId, isFollowing) {
            const followBtn = document.getElementById('follow-btn');
            if (followBtn) {
                followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
                followBtn.style.backgroundColor = isFollowing ? 'var(--accent)' : 'var(--secondary)';
            }
        }

        function updateStatsCounters(userId) {
            database.ref(`users/${userId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
                    const followingCount = userData.following ? Object.keys(userData.following).length : 0;
                    
                    document.getElementById('followers-count').textContent = formatNumber(followersCount);
                    document.getElementById('following-count').textContent = formatNumber(followingCount);
                }
            });
        }

        // Show followers/following lists
        function showFollowersList(userId) {
            database.ref(`users/${userId}/followers`).once('value').then(snapshot => {
                const followersContainer = document.getElementById('followers-container');
                followersContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const followerIds = Object.keys(snapshot.val());
                    if (followerIds.length > 0) {
                        followerIds.forEach(followerId => {
                            database.ref(`users/${followerId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const followerElement = document.createElement('div');
                                    followerElement.className = 'list-item';
                                    followerElement.innerHTML = `
                                        <img src="${user.headshot}" alt="${user.username}">
                                        <span>${user.username}</span>
                                        <button class="view-profile" data-id="${user.userId}">View</button>
                                    `;
                                    followersContainer.appendChild(followerElement);
                                }
                            });
                        });
                    } else {
                        followersContainer.innerHTML = '<p>No followers yet</p>';
                    }
                } else {
                    followersContainer.innerHTML = '<p>No followers yet</p>';
                }
                
                showPage('followers-page');
            });
        }

        function showFollowingList(userId) {
            database.ref(`users/${userId}/following`).once('value').then(snapshot => {
                const followingContainer = document.getElementById('following-container');
                followingContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const followingIds = Object.keys(snapshot.val());
                    if (followingIds.length > 0) {
                        followingIds.forEach(followingId => {
                            database.ref(`users/${followingId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const followingElement = document.createElement('div');
                                    followingElement.className = 'list-item';
                                    followingElement.innerHTML = `
                                        <img src="${user.headshot}" alt="${user.username}">
                                        <span>${user.username}</span>
                                        <button class="view-profile" data-id="${user.userId}">View</button>
                                    `;
                                    followingContainer.appendChild(followingElement);
                                }
                            });
                        });
                    } else {
                        followingContainer.innerHTML = '<p>Not following anyone yet</p>';
                    }
                } else {
                    followingContainer.innerHTML = '<p>Not following anyone yet</p>';
                }
                
                showPage('following-page');
            });
        }

        // Messaging functionality
        let currentChatId = null;

        function showMessagesList() {
            const userId = localStorage.getItem('robloxUserId');
            if (!userId) return showNotification('You need to be logged in to view messages', 'error');
            
            database.ref(`users/${userId}/conversations`).once('value').then(snapshot => {
                const conversationsContainer = document.getElementById('conversations-container');
                conversationsContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const conversations = snapshot.val();
                    Object.keys(conversations).forEach(otherUserId => {
                        database.ref(`users/${otherUserId}`).once('value').then(userSnapshot => {
                            if (userSnapshot.exists()) {
                                const user = userSnapshot.val();
                                const conversationElement = document.createElement('div');
                                conversationElement.className = 'list-item';
                                conversationElement.innerHTML = `
                                    <img src="${user.headshot}" alt="${user.username}">
                                    <span>${user.username}</span>
                                    <button class="start-chat" data-id="${user.userId}">Chat</button>
                                `;
                                conversationsContainer.appendChild(conversationElement);
                            }
                        });
                    });
                } else {
                    conversationsContainer.innerHTML = '<p>No conversations yet</p>';
                }
                
                document.getElementById('chat-container').style.display = 'none';
                showPage('messages-page');
            });
        }

        function showChatWindow(userId) {
            currentChatId = userId;
            database.ref(`users/${userId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const user = snapshot.val();
                    document.getElementById('chat-title').textContent = `Chat with ${user.username}`;
                    loadMessages(userId);
                    document.getElementById('chat-container').style.display = 'block';
                }
            });
        }

        function loadMessages(userId) {
            const currentUserId = localStorage.getItem('robloxUserId');
            const chatId = [currentUserId, userId].sort().join('_');
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            database.ref(`chats/${chatId}/messages`).orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
                messagesContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach(childSnapshot => {
                        messages.push(childSnapshot.val());
                    });
                    
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    messages.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.senderId === currentUserId ? 'sent' : 'received'}`;
                        messageElement.innerHTML = `
                            <div>${message.text}</div>
                            <div style="font-size:10px;text-align:right">${formatTime(message.timestamp)}</div>
                        `;
                        messagesContainer.appendChild(messageElement);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId || !currentChatId) return;
            
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            const chatId = [currentUserId, currentChatId].sort().join('_');
            const message = {
                senderId: currentUserId,
                text: messageText,
                timestamp: Date.now()
            };
            
            database.ref(`chats/${chatId}/messages`).push(message)
                .then(() => {
                    messageInput.value = '';
                    // Update conversation for both users
                    const updates = {};
                    updates[`users/${currentUserId}/conversations/${currentChatId}`] = true;
                    updates[`users/${currentChatId}/conversations/${currentUserId}`] = true;
                    database.ref().update(updates);
                    
                    // Send notification
                    const notification = {
                        message: `New message from ${localStorage.getItem('robloxUsername')}`,
                        timestamp: Date.now()
                    };
                    database.ref(`users/${currentChatId}/notifications`).push(notification);
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showNotification('Error sending message', 'error');
                });
        }

        // Posts functionality
        function loadPosts(userId = null) {
            const postsContainer = userId ? document.getElementById('profile-posts-container') : document.getElementById('posts-container');
            postsContainer.innerHTML = '<p>Loading posts...</p>';
            
            let postsRef = database.ref('posts').orderByChild('timestamp').limitToLast(20);
            if (userId) {
                postsRef = database.ref('posts').orderByChild('userId').equalTo(userId).limitToLast(20);
            }
            
            postsRef.once('value').then(snapshot => {
                postsContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const posts = [];
                    snapshot.forEach(childSnapshot => {
                        posts.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (posts.length === 0) {
                        postsContainer.innerHTML = '<p>No posts yet</p>';
                        return;
                    }
                    
                    posts.forEach(post => {
                        database.ref(`users/${post.userId}`).once('value').then(userSnapshot => {
                            if (userSnapshot.exists()) {
                                const user = userSnapshot.val();
                                const currentUserId = localStorage.getItem('robloxUserId');
                                const isLiked = currentUserId && post.likes && post.likes[currentUserId];
                                const isReposted = currentUserId && post.reposts && post.reposts[currentUserId];
                                
                                const postElement = document.createElement('div');
                                postElement.className = 'post-container';
                                
                                let repostInfo = '';
                                if (post.originalPostId) {
                                    database.ref(`posts/${post.originalPostId}`).once('value').then(originalPostSnapshot => {
                                        if (originalPostSnapshot.exists()) {
                                            const originalPost = originalPostSnapshot.val();
                                            database.ref(`users/${originalPost.userId}`).once('value').then(originalUserSnapshot => {
                                                if (originalUserSnapshot.exists()) {
                                                    const originalUser = originalUserSnapshot.val();
                                                    const repostInfoElement = postElement.querySelector('.repost-info');
                                                    if (repostInfoElement) {
                                                        repostInfoElement.innerHTML = `<i>🔄</i> Reposted from @${originalUser.username}`;
                                                    }
                                                }
                                            });
                                        }
                                    });
                                    repostInfo = `<div class="repost-info"><i>🔄</i> Reposted from @${user.username}</div>`;
                                }
                                
                                postElement.innerHTML = `
                                    ${repostInfo}
                                    <div class="post-header">
                                        <img src="${user.headshot}" width="40" height="40" style="border-radius:50%;margin-right:10px;cursor:pointer" class="view-profile" data-id="${user.userId}">
                                        <div>
                                            <div class="post-user view-profile" data-id="${user.userId}">${user.username}</div>
                                            <div class="post-time">${new Date(post.timestamp).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div class="post-content">${post.content}</div>
                                    <div class="post-actions">
                                        <div class="post-action like-post ${isLiked ? 'liked' : ''}" data-id="${post.id}">
                                            ❤️ <span>${post.likes ? formatNumber(Object.keys(post.likes).length) : 0}</span>
                                        </div>
                                        <div class="post-action repost-post ${isReposted ? 'reposted' : ''}" data-id="${post.id}">
                                            🔄 <span>${post.reposts ? formatNumber(Object.keys(post.reposts).length) : 0}</span>
                                        </div>
                                        <div class="post-action">
                                            👁️ <span>${post.views ? formatNumber(post.views) : 0}</span>
                                        </div>
                                    </div>
                                `;
                                postsContainer.appendChild(postElement);
                                
                                // Track view
                                database.ref(`posts/${post.id}/views`).transaction(views => (views || 0) + 1);
                            }
                        });
                    });
                } else {
                    postsContainer.innerHTML = '<p>No posts yet</p>';
                }
            });
        }

        document.getElementById('post-btn').addEventListener('click', () => {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return showNotification('You need to be logged in to post', 'error');
            
            const postContent = document.getElementById('post-content').value.trim();
            if (!postContent) return showNotification('Post cannot be empty', 'error');
            
            const post = {
                userId: currentUserId,
                content: postContent,
                timestamp: Date.now(),
                likes: {},
                reposts: {},
                views: 0
            };
            
            database.ref('posts').push(post)
                .then(() => {
                    document.getElementById('post-content').value = '';
                    showNotification('Posted successfully!', 'success');
                    loadPosts();
                })
                .catch(error => {
                    console.error('Error posting:', error);
                    showNotification('Error creating post', 'error');
                });
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('like-post') || e.target.closest('.like-post')) {
                const postId = e.target.classList.contains('like-post') ? e.target.dataset.id : e.target.closest('.like-post').dataset.id;
                const currentUserId = localStorage.getItem('robloxUserId');
                if (!currentUserId) return showNotification('You need to be logged in to like posts', 'error');
                
                const actionElement = e.target.classList.contains('like-post') ? e.target : e.target.closest('.like-post');
                
                database.ref(`posts/${postId}/likes/${currentUserId}`).transaction(like => {
                    if (like === null) {
                        // Send notification to post owner
                        database.ref(`posts/${postId}`).once('value').then(postSnapshot => {
                            if (postSnapshot.exists()) {
                                const post = postSnapshot.val();
                                if (post.userId !== currentUserId) {
                                    const notification = {
                                        message: `${localStorage.getItem('robloxUsername')} liked your post`,
                                        timestamp: Date.now()
                                    };
                                    database.ref(`users/${post.userId}/notifications`).push(notification);
                                }
                            }
                        });
                        
                        actionElement.classList.add('liked');
                        return true;
                    } else {
                        actionElement.classList.remove('liked');
                        return null;
                    }
                });
            }
            
            if (e.target.classList.contains('repost-post') || e.target.closest('.repost-post')) {
                const postId = e.target.classList.contains('repost-post') ? e.target.dataset.id : e.target.closest('.repost-post').dataset.id;
                const currentUserId = localStorage.getItem('robloxUserId');
                if (!currentUserId) return showNotification('You need to be logged in to repost', 'error');
                
                const actionElement = e.target.classList.contains('repost-post') ? e.target : e.target.closest('.repost-post');
                
                database.ref(`posts/${postId}/reposts/${currentUserId}`).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        // Already reposted, so remove the repost
                        database.ref(`posts/${postId}/reposts/${currentUserId}`).remove()
                            .then(() => {
                                actionElement.classList.remove('reposted');
                                showNotification('Removed repost', 'success');
                            });
                    } else {
                        // Create a new repost
                        database.ref(`posts/${postId}`).once('value').then(postSnapshot => {
                            if (postSnapshot.exists()) {
                                const originalPost = postSnapshot.val();
                                const repost = {
                                    userId: currentUserId,
                                    content: originalPost.content,
                                    timestamp: Date.now(),
                                    originalPostId: postId,
                                    likes: {},
                                    reposts: {},
                                    views: 0
                                };
                                
                                database.ref('posts').push(repost)
                                    .then(() => {
                                        database.ref(`posts/${postId}/reposts/${currentUserId}`).set(true);
                                        actionElement.classList.add('reposted');
                                        showNotification('Reposted successfully!', 'success');
                                        
                                        // Send notification to post owner
                                        if (originalPost.userId !== currentUserId) {
                                            const notification = {
                                                message: `${localStorage.getItem('robloxUsername')} reposted your post`,
                                                timestamp: Date.now()
                                            };
                                            database.ref(`users/${originalPost.userId}/notifications`).push(notification);
                                        }
                                    });
                            }
                        });
                    }
                });
            }
        });

        // Recommended profiles
        function loadRecommendedProfiles() {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return;
            
            database.ref('users').limitToLast(5).once('value').then(snapshot => {
                const recommendedContainer = document.getElementById('recommended-users');
                recommendedContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        if (user.userId !== currentUserId) {
                            const userElement = document.createElement('div');
                            userElement.className = 'recommended-user';
                            userElement.innerHTML = `
                                <img src="${user.headshot}" alt="${user.username}" data-id="${user.userId}">
                                <span>${user.username}</span>
                            `;
                            recommendedContainer.appendChild(userElement);
                        }
                    });
                }
            });
        }

        // Page management
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Onboarding flow functions
        function updateProgress(step) {
            const progressBar = document.getElementById('progress');
            if (progressBar) progressBar.style.width = step * 33.33 + '%';
        }

        function showStep(stepId, progressStep) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
                updateProgress(progressStep);
            }
        }

        function generateVerificationCode() {
            const codeTextElement = document.getElementById('code-text');
            if (codeTextElement) {
                const code = Math.floor(10000 + 90000 * Math.random());
                codeTextElement.textContent = code;
                localStorage.setItem('verificationCode', code.toString());
                return code;
            }
            return null;
        }

        function showHomeContent() {
            document.getElementById('onboarding').style.display = 'none';
            showPage('home-page');
            
            const userId = localStorage.getItem('robloxUserId');
            if (userId) {
                loadUserData(userId);
                loadPosts();
                loadRecommendedProfiles();
                setupNotificationListener(userId);
            }
            
            const path = window.location.pathname;
            if (path.startsWith('/@')) {
                const username = decodeURIComponent(path.substring(2));
                searchUserByUsername(username);
            }
        }

        async function searchUserByUsername(username) {
            try {
                const snapshot = await database.ref('users').once('value');
                let foundUser = null;
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.username.toLowerCase() === username.toLowerCase()) {
                        foundUser = user;
                    }
                });
                
                if (foundUser) {
                    loadUserData(foundUser.userId, false);
                } else {
                    showNotification('User not found', 'error');
                    window.history.pushState({}, '', '/');
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            } catch (error) {
                console.error('Search error:', error);
                showNotification('Error searching for user', 'error');
            }
        }

        function loadUserData(userId, isCurrentUser = null) {
            if (isCurrentUser === null) {
                isCurrentUser = userId === localStorage.getItem('robloxUserId');
            }
            
            database.ref('users/' + userId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    updateProfileUI(userData, isCurrentUser);
                    
                    if (!isCurrentUser && localStorage.getItem('robloxUserId')) {
                        const currentUserId = localStorage.getItem('robloxUserId');
                        database.ref(`users/${currentUserId}/following/${userId}`).once('value').then(followSnapshot => {
                            updateFollowButton(userId, followSnapshot.exists());
                        });
                    }
                } else if (isCurrentUser) {
                    createNewUser(userId);
                } else {
                    showNotification('Profile not found', 'error');
                    window.history.pushState({}, '', '/');
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            }).catch(error => {
                console.error("Database error:", error);
                showNotification('Error loading profile', 'error');
            });
        }

        function createNewUser(userId) {
            const userData = {
                userId: userId,
                username: localStorage.getItem('robloxUsername') || `User${userId.slice(0, 4)}`,
                headshot: localStorage.getItem('robloxHeadshot') || `https://www.roblox.com/headshot-thumbnail/image?userId=${userId}&width=150&height=150&format=png`,
                description: "",
                followers: {},
                following: {},
                createdAt: Date.now()
            };
            
            database.ref('users/' + userId).set(userData)
                .then(() => {
                    updateProfileUI(userData, true);
                    setupNotificationListener(userId);
                })
                .catch(error => {
                    console.error("Create user error:", error);
                    showNotification('Error creating profile', 'error');
                });
        }

        function updateProfileUI(userData, isCurrentUser) {
            document.getElementById('profile-headshot').src = userData.headshot;
            document.getElementById('profile-username').textContent = userData.username;
            document.getElementById('profile-description').textContent = userData.description || 'No description yet';
            
            const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
            const followingCount = userData.following ? Object.keys(userData.following).length : 0;
            document.getElementById('followers-count').textContent = formatNumber(followersCount);
            document.getElementById('following-count').textContent = formatNumber(followingCount);
            
            document.getElementById('followers-count').onclick = () => showFollowersList(userData.userId);
            document.getElementById('following-count').onclick = () => showFollowingList(userData.userId);
            
            document.getElementById('edit-btn').style.display = isCurrentUser ? 'inline-block' : 'none';
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('follow-btn').style.display = isCurrentUser ? 'none' : 'inline-block';
            document.getElementById('message-btn').style.display = isCurrentUser ? 'none' : 'inline-block';
            document.getElementById('profile-description').contentEditable = false;
            
            if (!isCurrentUser) {
                document.getElementById('follow-btn').onclick = () => {
                    const currentUserId = localStorage.getItem('robloxUserId');
                    if (!currentUserId) return showNotification('You need to be logged in to follow', 'error');
                    
                    database.ref(`users/${currentUserId}/following/${userData.userId}`).once('value').then(snapshot => {
                        toggleFollow(userData.userId, snapshot.exists());
                    });
                };
                
                document.getElementById('message-btn').onclick = () => {
                    showChatWindow(userData.userId);
                };
            }
            
            if (isCurrentUser) {
                document.getElementById('sidebar-headshot').src = userData.headshot;
                document.getElementById('sidebar-username').textContent = userData.username;
                loadPosts(userData.userId);
            } else {
                loadPosts(userData.userId);
            }
            
            showPage('profile-page');
            
            if (isCurrentUser && !window.location.pathname.startsWith('/@')) {
                window.history.pushState({}, '', `/@${encodeURIComponent(userData.username)}`);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation buttons
            document.getElementById('home-btn').addEventListener('click', () => {
                window.history.pushState({}, '', '/');
                showPage('home-page');
                loadPosts();
            });
            
            document.getElementById('messages-btn').addEventListener('click', showMessagesList);
            document.getElementById('notifications-btn').addEventListener('click', () => {
                showPage('notifications-page');
                renderNotifications();
            });
            
            document.getElementById('search-btn-nav').addEventListener('click', () => {
                showPage('search-page');
            });
            
            // Back buttons
            document.getElementById('back-to-home').addEventListener('click', () => {
                showPage('home-page');
            });
            
            document.getElementById('back-to-home-from-messages').addEventListener('click', () => {
                showPage('home-page');
            });
            
            document.getElementById('back-to-home-from-notifications').addEventListener('click', () => {
                showPage('home-page');
            });
            
            document.getElementById('back-to-home-from-search').addEventListener('click', () => {
                showPage('home-page');
            });
            
            document.getElementById('back-to-profile-from-followers').addEventListener('click', () => {
                showPage('profile-page');
            });
            
            document.getElementById('back-to-profile-from-following').addEventListener('click', () => {
                showPage('profile-page');
            });
            
            document.getElementById('back-to-conversations').addEventListener('click', () => {
                document.getElementById('chat-container').style.display = 'none';
            });

            // Confirm ID button
            document.getElementById('confirm-id')?.addEventListener('click', async () => {
                const userId = document.getElementById('roblox-id').value.trim();
                if (!userId) return showNotification('Please enter a Roblox ID', 'error');
                
                try {
                    const userData = await getRobloxUserData(userId);
                    
                    document.getElementById('username').textContent = userData.username;
                    document.getElementById('description').textContent = userData.description || '(No description)';
                    document.getElementById('headshot').src = userData.headshot;
                    
                    localStorage.setItem('tempUserId', userId);
                    localStorage.setItem('tempUsername', userData.username);
                    localStorage.setItem('tempHeadshot', userData.headshot);
                    
                    showStep('step2', 2);
                } catch(error) {
                    showNotification("Couldn't find that user. Please check the ID", 'error');
                }
            });

            // Other buttons
            document.getElementById('yes-btn')?.addEventListener('click', () => {
                generateVerificationCode();
                showStep('step3', 3);
            });

            document.getElementById('no-btn')?.addEventListener('click', () => {
                showStep('step1', 1);
            });

            document.getElementById('back-btn')?.addEventListener('click', () => {
                showStep('step2', 2);
            });

            document.getElementById('verify-btn')?.addEventListener('click', async () => {
                const userId = localStorage.getItem('tempUserId');
                localStorage.setItem('newUser', 'false');
                localStorage.setItem('robloxUserId', userId);
                localStorage.setItem('robloxUsername', localStorage.getItem('tempUsername'));
                localStorage.setItem('robloxHeadshot', localStorage.getItem('tempHeadshot'));
                
                ['tempUserId', 'tempUsername', 'tempHeadshot', 'verificationCode'].forEach(item => {
                    localStorage.removeItem(item);
                });
                
                document.getElementById('verification-status').textContent = 'Verification successful!';
                setTimeout(showHomeContent, 1500);
            });

            // Edit profile
            document.getElementById('edit-btn')?.addEventListener('click', () => {
                const desc = document.getElementById('profile-description');
                desc.contentEditable = true;
                desc.focus();
                document.getElementById('edit-btn').style.display = 'none';
                document.getElementById('save-btn').style.display = 'inline-block';
            });

            document.getElementById('save-btn')?.addEventListener('click', () => {
                const desc = document.getElementById('profile-description');
                const userId = localStorage.getItem('robloxUserId');
                const text = desc.textContent;
                desc.contentEditable = false;
                document.getElementById('edit-btn').style.display = 'inline-block';
                document.getElementById('save-btn').style.display = 'none';
                
                database.ref('users/' + userId).update({ description: text })
                    .then(() => showNotification('Description saved successfully!', 'success'))
                    .catch(error => {
                        console.error("Save error:", error);
                        showNotification('Error saving description', 'error');
                    });
            });

            // Copy verification code
            document.querySelector('.copy-btn')?.addEventListener('click', () => {
                const code = document.getElementById('code-text').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    document.querySelector('.copy-btn').textContent = 'Copied!';
                    setTimeout(() => {
                        document.querySelector('.copy-btn').textContent = 'Copy';
                    }, 2000);
                });
            });

            // Search button
            document.getElementById('search-btn').addEventListener('click', () => {
                const searchTerm = document.getElementById('search-input').value.trim();
                performSearch(searchTerm);
            });

            // Handle back/forward navigation
            window.addEventListener('popstate', () => {
                const path = window.location.pathname;
                if (path === '/') {
                    showPage('home-page');
                    loadPosts();
                } else if (path.startsWith('/@')) {
                    const username = decodeURIComponent(path.substring(2));
                    searchUserByUsername(username);
                }
            });

            // View profile from search results or posts
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-profile') || e.target.closest('.view-profile')) {
                    const userId = e.target.classList.contains('view-profile') ? e.target.dataset.id : 
                                  e.target.closest('.view-profile').dataset.id;
                    if (userId) {
                        window.history.pushState({}, '', `/@${encodeURIComponent(userId)}`);
                        loadUserData(userId);
                    }
                }
                
                // Click on recommended user
                if (e.target.closest('.recommended-user')) {
                    const userId = e.target.closest('.recommended-user').querySelector('img').dataset.id;
                    if (userId) {
                        window.history.pushState({}, '', `/@${encodeURIComponent(userId)}`);
                        loadUserData(userId);
                    }
                }
                
                // Start chat from conversations list
                if (e.target.classList.contains('start-chat')) {
                    const userId = e.target.dataset.id;
                    showChatWindow(userId);
                }
            });

            // Initialize app state
            if (localStorage.getItem('newUser') === 'false') {
                showHomeContent();
            } else {
                localStorage.setItem('newUser', 'true');
                generateVerificationCode();
            }
        });
    </script>
</body>
</html>
