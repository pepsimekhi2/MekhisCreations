<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekhis Creations</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --secondary: #34A853;
            --accent: #EA4335;
            --text: #202124;
            --bg: #F8F9FA;
            --card-bg: #fff;
            --btn-text: #fff;
            --input-bg: #fff;
            --notification-success: #34A853;
            --notification-error: #EA4335;
            --notification-info: #4285F4;
            --theme-dark-text: #F8F9FA;
            --theme-dark-bg: #202124;
            --theme-dark-card: #303134;
            --theme-neon-primary: #00F0FF;
            --theme-neon-secondary: #FF00F0;
            --theme-neon-accent: #F0FF00;
        }
        
        body {
            font-family: 'Fredoka One', cursive;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
        }
        
        /* Rest of the CSS styles remain the same */
        
    </style>
</head>
<body class="default-theme">
    <div class="version">Mekhis Creations v1.1</div>
    <button class="theme-btn" id="theme-btn">Themes</button>
    <div class="theme-menu" id="theme-menu">
        <div class="theme-option selected" data-theme="default">Default</div>
        <div class="theme-option" data-theme="dark">Dark Mode</div>
        <div class="theme-option" data-theme="neon">Neon</div>
    </div>

    <div class="container">
        <div id="main-app" class="step">
            <h1>Welcome to Mekhis Creations</h1>
            <div class="bounce">ðŸŽ‰</div>
            <p>You're all set! Enjoy the platform.</p>
            <button id="go-home-btn" style="margin-top:20px">Go to Home</button>
        </div>
        
        <div id="onboarding">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            
            <div id="step1" class="step active">
                <h1>Welcome to Mekhis Creations!</h1>
                <div class="bounce">ðŸ‘‹</div>
                <p>Let's get you set up!</p>
                <p>First, enter your Roblox User ID below:</p>
                <input type="text" id="roblox-id" placeholder="123456789">
                <button id="confirm-id">Let's Go!</button>
            </div>
            
            <div id="step2" class="step">
                <h2>Is this you?</h2>
                <div id="user-info">
                    <img id="headshot" src="" alt="Roblox avatar">
                    <div id="username"></div>
                    <div id="description"></div>
                </div>
                <button id="yes-btn">Yes, that's me!</button>
                <button id="no-btn">No, try again</button>
            </div>
            
            <div id="step3" class="step">
                <h2>Almost there!</h2>
                <p>Let's verify this is really you:</p>
                <ol style="text-align:left;display:inline-block">
                    <li>Copy this code</li>
                    <li>Paste it in your Roblox profile description</li>
                    <li>Click verify when done</li>
                </ol>
                <div class="code-container">
                    <div id="verification-code">
                        <span id="code-text"></span>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
                <div style="margin-top:15px">
                    <button class="back-btn" id="back-btn">Back</button>
                </div>
                <div id="verification-status"></div>
                <button id="verify-btn" style="margin-top:10px">Verify</button>
            </div>
        </div>
        
        <!-- Home content section -->
        <div id="home-content">
            <div id="player-search">
                <input type="text" id="search-input" placeholder="Search players by username">
                <button id="search-btn">Search</button>
                <div id="search-results"></div>
            </div>
            
            <div id="title-bar">Mekhis Creations</div>
            <div id="divider"></div>
            <div id="profile-container">
                <img id="profile-headshot" src="" alt="Profile picture">
                <div id="profile-username"></div>
                <div id="profile-description">Loading description...</div>
                <div id="profile-stats">
                    <div>
                        <div class="stat-value" id="followers-count">0</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div>
                        <div class="stat-value" id="following-count">0</div>
                        <div class="stat-label">Following</div>
                    </div>
                </div>
                <div>
                    <button id="edit-btn">Edit</button>
                    <button id="save-btn">Save</button>
                </div>
            </div>
            <div id="divider"></div>
        </div>

        <!-- Player search functionality -->
        <script>
            // Player search functionality
            document.getElementById('search-btn').addEventListener('click', () => {
                const searchTerm = document.getElementById('search-input').value.trim();
                if (!searchTerm) {
                    showNotification('Please enter a username to search', 'error');
                    return;
                }
                
                showNotification('Searching for players...', 'info');
                
                database.ref('users').once('value').then(snapshot => {
                    const results = [];
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
                            results.push(user);
                        }
                    });
                    
                    const resultsContainer = document.getElementById('search-results');
                    resultsContainer.innerHTML = '';
                    
                    if (results.length > 0) {
                        results.forEach(user => {
                            const userElement = document.createElement('div');
                            userElement.className = 'search-result';
                            userElement.innerHTML = `
                                <img src="${user.headshot}" width="50" height="50" style="border-radius:50%;margin-right:10px;">
                                <span>${user.username}</span>
                                <button class="view-profile" data-id="${user.userId}">View</button>
                            `;
                            resultsContainer.appendChild(userElement);
                        });
                        resultsContainer.style.display = 'block';
                        showNotification(`Found ${results.length} matching players`, 'success');
                    } else {
                        resultsContainer.innerHTML = '<p>No players found matching your search</p>';
                        resultsContainer.style.display = 'block';
                        showNotification('No players found', 'error');
                    }
                }).catch(error => {
                    showNotification('Search failed', 'error');
                    console.error('Search error:', error);
                });
            });

            // View profile from search results
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-profile')) {
                    const userId = e.target.dataset.id;
                    loadUserData(userId);
                    document.getElementById('search-results').style.display = 'none';
                    showNotification('Loading profile...', 'info');
                }
            });

            // Edit profile functionality
            const editBtn = document.getElementById('edit-btn');
            const saveBtn = document.getElementById('save-btn');
            if (editBtn && saveBtn) {
                editBtn.addEventListener('click', () => {
                    const desc = document.getElementById('profile-description');
                    if (desc) {
                        desc.contentEditable = true;
                        desc.focus();
                        editBtn.style.display = 'none';
                        saveBtn.style.display = 'inline-block';
                        showNotification('Editing description...', 'info');
                    }
                });

                saveBtn.addEventListener('click', () => {
                    const desc = document.getElementById('profile-description');
                    const userId = localStorage.getItem('robloxUserId');
                    
                    if (desc && userId) {
                        const text = desc.textContent;
                        desc.contentEditable = false;
                        editBtn.style.display = 'inline-block';
                        saveBtn.style.display = 'none';
                        
                        database.ref('users/' + userId).update({ description: text })
                            .then(() => {
                                showNotification('Description saved successfully!', 'success');
                            })
                            .catch(error => {
                                console.error("Save error:", error);
                                showNotification('Error saving description', 'error');
                                if (editBtn) editBtn.click();
                            });
                    }
                });
            }

            // Load user data when page loads
            if (localStorage.getItem('newUser') === 'false') {
                const userId = localStorage.getItem('robloxUserId');
                if (userId) {
                    loadUserData(userId);
                }
            }

            // Load user data function
            function loadUserData(userId) {
                database.ref('users/' + userId).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        updateProfileUI(userData);
                        showNotification('Profile loaded successfully', 'success');
                    } else {
                        createNewUser(userId);
                    }
                }).catch(error => {
                    console.error("Database error:", error);
                    loadFromLocalStorage();
                    showNotification('Error loading profile', 'error');
                });
            }

            // Create new user function
            function createNewUser(userId) {
                const userData = {
                    userId: userId,
                    username: localStorage.getItem('robloxUsername'),
                    headshot: localStorage.getItem('robloxHeadshot'),
                    description: "",
                    followers: 0,
                    following: 0,
                    createdAt: Date.now()
                };
                
                database.ref('users/' + userId).set(userData)
                    .then(() => {
                        updateProfileUI(userData);
                        showNotification('New profile created', 'success');
                    })
                    .catch(error => {
                        console.error("Create user error:", error);
                        loadFromLocalStorage();
                        showNotification('Error creating profile', 'error');
                    });
            }

            // Update profile UI function
            function updateProfileUI(userData) {
                const headshot = document.getElementById('profile-headshot');
                const username = document.getElementById('profile-username');
                const description = document.getElementById('profile-description');
                const followers = document.getElementById('followers-count');
                const following = document.getElementById('following-count');
                
                if (headshot) headshot.src = userData.headshot;
                if (username) username.textContent = userData.username;
                if (description) description.textContent = userData.description || 'No description yet';
                if (followers) followers.textContent = userData.followers || 0;
                if (following) following.textContent = userData.following || 0;
            }

            // Load from local storage function
            function loadFromLocalStorage() {
                const headshot = localStorage.getItem('robloxHeadshot');
                const username = localStorage.getItem('robloxUsername');
                const profileHeadshot = document.getElementById('profile-headshot');
                const profileUsername = document.getElementById('profile-username');
                const profileDescription = document.getElementById('profile-description');
                
                if (headshot && profileHeadshot) profileHeadshot.src = headshot;
                if (username && profileUsername) profileUsername.textContent = username;
                if (profileDescription) profileDescription.textContent = 'No description yet';
            }
        </script>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            databaseURL: "https://cloud-fbd6b-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // CORS proxy function
        async function fetchRobloxData(url) {
            try {
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + url;
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Access-Control-Allow-Origin': '*',
                    },
                    mode: 'cors'
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching Roblox data:', error);
                throw error;
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Theme management
        function applyTheme(theme) {
            document.body.className = theme + '-theme';
            localStorage.setItem('selectedTheme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.theme === theme) {
                    opt.classList.add('selected');
                }
            });
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('selectedTheme') || 'default';
        applyTheme(savedTheme);

        // Theme button event
        document.getElementById('theme-btn').addEventListener('click', () => {
            document.getElementById('theme-menu').classList.toggle('active');
        });

        // Theme selection
        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(option.dataset.theme);
                document.getElementById('theme-menu').classList.remove('active');
            });
        });

        // Initialize event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Confirm ID button
            const confirmIdBtn = document.getElementById('confirm-id');
            if (confirmIdBtn) {
                confirmIdBtn.addEventListener('click', async () => {
                    const userIdInput = document.getElementById('roblox-id');
                    if (!userIdInput) return;
                    
                    const userId = userIdInput.value.trim();
                    if (!userId) {
                        showNotification('Please enter a Roblox ID', 'error');
                        return;
                    }
                    
                    try {
                        showNotification('Loading Roblox profile...', 'info');
                        const [userData, headshotData] = await Promise.all([
                            fetchRobloxData(`https://users.roblox.com/v1/users/${userId}`),
                            fetchRobloxData(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png`)
                        ]);
                        
                        if (userData.errors || headshotData.errors) throw new Error('User not found');
                        
                        const usernameElement = document.getElementById('username');
                        const descriptionElement = document.getElementById('description');
                        const headshotElement = document.getElementById('headshot');
                        
                        if (usernameElement) usernameElement.textContent = userData.name;
                        if (descriptionElement) descriptionElement.textContent = userData.description || '(No description)';
                        if (headshotElement) headshotElement.src = headshotData.data[0].imageUrl;
                        
                        localStorage.setItem('tempUserId', userId);
                        localStorage.setItem('tempUsername', userData.name);
                        localStorage.setItem('tempHeadshot', headshotData.data[0].imageUrl);
                        
                        showStep('step2', 2);
                        showNotification('Profile found! Is this you?', 'success');
                    } catch(error) {
                        showNotification("Couldn't find that user. Please check the ID", 'error');
                    }
                });
            }

            // Other buttons
            const yesBtn = document.getElementById('yes-btn');
            if (yesBtn) yesBtn.addEventListener('click', () => {
                generateVerificationCode();
                showStep('step3', 3);
                showNotification('Verification code generated', 'info');
            });

            const noBtn = document.getElementById('no-btn');
            if (noBtn) noBtn.addEventListener('click', () => {
                showStep('step1', 1);
                showNotification('Please enter the correct Roblox ID', 'info');
            });

            const backBtn = document.getElementById('back-btn');
            if (backBtn) backBtn.addEventListener('click', () => {
                showStep('step2', 2);
            });

            const verifyBtn = document.getElementById('verify-btn');
            if (verifyBtn) verifyBtn.addEventListener('click', async () => {
                const userId = localStorage.getItem('tempUserId');
                const verificationCode = localStorage.getItem('verificationCode');
                
                try {
                    showNotification('Verifying your profile...', 'info');
                    const userData = await fetchRobloxData(`https://users.roblox.com/v1/users/${userId}`);
                    
                    if (userData.description && userData.description.includes(verificationCode)) {
                        localStorage.setItem('newUser', 'false');
                        localStorage.setItem('robloxUserId', userId);
                        localStorage.setItem('robloxUsername', localStorage.getItem('tempUsername'));
                        localStorage.setItem('robloxHeadshot', localStorage.getItem('tempHeadshot'));
                        
                        // Clear temp data
                        ['tempUserId', 'tempUsername', 'tempHeadshot', 'verificationCode'].forEach(item => {
                            localStorage.removeItem(item);
                        });
                        
                        const statusElement = document.getElementById('verification-status');
                        if (statusElement) statusElement.textContent = 'Verification successful!';
                        showNotification('Verification successful!', 'success');
                        setTimeout(() => {
                            showHomeContent();
                        }, 1500);
                    } else {
                        const statusElement = document.getElementById('verification-status');
                        if (statusElement) statusElement.textContent = 'Code not found in description. Please try again.';
                        showNotification('Verification failed - code not found', 'error');
                    }
                } catch(error) {
                    const statusElement = document.getElementById('verification-status');
                    if (statusElement) statusElement.textContent = 'Error verifying. Please try again.';
                    showNotification('Error during verification', 'error');
                }
            });

            // Initialize app state
            if (localStorage.getItem('newUser') === 'false') {
                showHomeContent();
            } else {
                localStorage.setItem('newUser', 'true');
                generateVerificationCode();
            }
        });

        // Progress bar update function
        function updateProgress(step) {
            const progressBar = document.getElementById('progress');
            if (progressBar) {
                progressBar.style.width = step * 33.33 + '%';
            }
        }

        // Step navigation function
        function showStep(stepId, progressStep) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
                updateProgress(progressStep);
            }
        }

        // Verification code generator
        function generateVerificationCode() {
            const codeTextElement = document.getElementById('code-text');
            if (codeTextElement) {
                const code = Math.floor(10000 + 90000 * Math.random());
                codeTextElement.textContent = code;
                localStorage.setItem('verificationCode', code.toString());
                return code;
            }
            return null;
        }

        // Show home content
        function showHomeContent() {
            const onboarding = document.getElementById('onboarding');
            const mainApp = document.getElementById('main-app');
            const homeContent = document.getElementById('home-content');
            
            if (onboarding) onboarding.style.display = 'none';
            if (mainApp) mainApp.style.display = 'none';
            if (homeContent) homeContent.style.display = 'block';
            
            const userId = localStorage.getItem('robloxUserId');
            if (userId) {
                loadUserData(userId);
            }
        }

        // Copy code functionality
        const copyBtn = document.querySelector('.copy-btn');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => {
                const codeTextElement = document.getElementById('code-text');
                if (codeTextElement) {
                    const code = codeTextElement.textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        copyBtn.textContent = 'Copied!';
                        showNotification('Code copied to clipboard', 'success');
                        setTimeout(() => {
                            copyBtn.textContent = 'Copy';
                        }, 2000);
                    });
                }
            });
        }
    </script>
</body>
</html>
