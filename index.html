// Initialize Firebase
const firebaseConfig = {
    databaseURL: "https://cloud-fbd6b-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Notification queue to avoid overlap
let notificationQueue = [], notificationActive = false;
function showNotification(message, type = 'info') {
    notificationQueue.push({message, type});
    if (!notificationActive) displayNextNotification();
}
function displayNextNotification() {
    if (notificationQueue.length === 0) { notificationActive = false; return; }
    notificationActive = true;
    const {message, type} = notificationQueue.shift();
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
        displayNextNotification();
    }, 2300);
}

// Theme management
function applyTheme(theme) {
    document.body.className = theme + '-theme';
    localStorage.setItem('selectedTheme', theme);
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.theme === theme) {
            opt.classList.add('selected');
        }
    });
}

// Helper function to safely get elements
function getElementByIdSafe(id) {
    return document.getElementById(id);
}

// Helper function to safely add event listeners
function addSafeEventListener(elementId, eventType, callback) {
    const element = getElementByIdSafe(elementId);
    if (element) {
        element.addEventListener(eventType, callback);
    }
}

// Progress bar update function
function updateProgress(step) {
    const progressBar = getElementByIdSafe('progress');
    if (progressBar) {
        progressBar.style.width = step * 33.33 + '%';
    }
}

// Step navigation function
function showStep(stepId, progressStep) {
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });
    const stepElement = getElementByIdSafe(stepId);
    if (stepElement) {
        stepElement.classList.add('active');
        updateProgress(progressStep);
    }
}

// Verification code generator
function generateVerificationCode() {
    const codeTextElement = getElementByIdSafe('code-text');
    if (codeTextElement) {
        const code = Math.floor(10000 + 90000 * Math.random());
        codeTextElement.textContent = code;
        localStorage.setItem('verificationCode', code.toString());
        return code;
    }
    return null;
}

// Home content display function
function showHomeContent() {
    const onboarding = getElementByIdSafe('onboarding');
    const mainApp = getElementByIdSafe('main-app');
    const homeContent = getElementByIdSafe('home-content');
    
    if (onboarding) onboarding.style.display = 'none';
    if (mainApp) mainApp.style.display = 'none';
    if (homeContent) homeContent.style.display = 'block';
    
    const userId = localStorage.getItem('robloxUserId');
    if (userId) {
        loadUserData(userId);
    }
}

// User data loading function
function loadUserData(userId) {
    database.ref('users/' + userId).once('value').then(snapshot => {
        if (snapshot.exists()) {
            const userData = snapshot.val();
            updateProfileUI(userData);
            showNotification('Profile loaded successfully', 'success');
        } else {
            createNewUser(userId);
        }
    }).catch(error => {
        console.error("Database error:", error);
        loadFromLocalStorage();
        showNotification('Error loading profile', 'error');
    });
}

// New user creation function
function createNewUser(userId) {
    const userData = {
        userId: userId,
        username: localStorage.getItem('robloxUsername'),
        headshot: localStorage.getItem('robloxHeadshot'),
        description: "",
        followers: 0,
        following: 0,
        createdAt: Date.now()
    };
    
    database.ref('users/' + userId).set(userData)
        .then(() => {
            updateProfileUI(userData);
            showNotification('New profile created', 'success');
        })
        .catch(error => {
            console.error("Create user error:", error);
            loadFromLocalStorage();
            showNotification('Error creating profile', 'error');
        });
}

// Profile UI update function
function updateProfileUI(userData) {
    const headshot = getElementByIdSafe('profile-headshot');
    const username = getElementByIdSafe('profile-username');
    const description = getElementByIdSafe('profile-description');
    const followers = getElementByIdSafe('followers-count');
    const following = getElementByIdSafe('following-count');
    
    if (headshot) headshot.src = userData.headshot;
    if (username) username.textContent = userData.username;
    if (description) description.textContent = userData.description || 'No description yet';
    if (followers) followers.textContent = userData.followers || 0;
    if (following) following.textContent = userData.following || 0;
}

// Local storage fallback function
function loadFromLocalStorage() {
    const headshot = localStorage.getItem('robloxHeadshot');
    const username = localStorage.getItem('robloxUsername');
    const profileHeadshot = getElementByIdSafe('profile-headshot');
    const profileUsername = getElementByIdSafe('profile-username');
    const profileDescription = getElementByIdSafe('profile-description');
    
    if (headshot && profileHeadshot) profileHeadshot.src = headshot;
    if (username && profileUsername) profileUsername.textContent = username;
    if (profileDescription) profileDescription.textContent = 'No description yet';
}

// CORS proxy function with retry mechanism
async function fetchRobloxData(url) {
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + url;
    try {
        const response = await fetch(proxyUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            mode: 'cors',
            retry: 3
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        showNotification('Data loaded successfully', 'success');
        return data;
    } catch (error) {
        console.error('Error fetching Roblox data:', error);
        showNotification('Failed to load data. Retrying...', 'error');
        
        // Retry mechanism
        await new Promise(resolve => setTimeout(resolve, 2000));
        return fetchRobloxData(url); // Retry
    }
}

// Initialize event listeners after DOM loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme
    const savedTheme = localStorage.getItem('selectedTheme') || 'default';
    applyTheme(savedTheme);

    // Theme button event
    document.getElementById('theme-btn')?.addEventListener('click', () => {
        document.getElementById('theme-menu').classList.toggle('active');
    });

    // Theme selection
    document.querySelectorAll('.theme-option')?.forEach(option => {
        option.addEventListener('click', () => {
            applyTheme(option.dataset.theme);
            document.getElementById('theme-menu').classList.remove('active');
        });
    });

    // Player search functionality
    document.getElementById('search-btn')?.addEventListener('click', () => {
        const searchTerm = document.getElementById('search-input').value.trim();
        if (!searchTerm) return showNotification('Please enter a username to search', 'error');
        showNotification('Searching for players...', 'info');
        database.ref('users').once('value').then(snapshot => {
            const results = [];
            snapshot.forEach(childSnapshot => {
                const user = childSnapshot.val();
                if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) results.push(user);
            });
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            if (results.length > 0) {
                results.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'search-result';
                    userElement.innerHTML = `
                        <img src="${user.headshot}" width="50" height="50" style="border-radius:50%;margin-right:10px;">
                        <span>${user.username}</span>
                        <button class="view-profile" data-id="${user.userId}">View</button>
                    `;
                    resultsContainer.appendChild(userElement);
                });
                resultsContainer.style.display = 'block';
                showNotification(`Found ${results.length} matching players`, 'success');
            } else {
                resultsContainer.innerHTML = '<p>No players found matching your search</p>';
                resultsContainer.style.display = 'block';
                showNotification('No players found', 'error');
            }
        }).catch(error => {
            showNotification('Search failed', 'error');
            console.error('Search error:', error);
        });
    });

    // Profile view from search results or URL
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-profile')) {
            const userId = e.target.dataset.id;
            window.history.pushState({}, '', `/@${userId}`);
            showProfileOnly(userId);
            document.getElementById('search-results').style.display = 'none';
            showNotification('Loading profile...', 'info');
        }
    });

    // Handle direct /@username or /@userid in URL
    if (window.location.pathname.startsWith('/@')) {
        let userId = decodeURIComponent(window.location.pathname.slice(2));
        // If user is registered and visiting their own profile, redirect to root
        const myId = localStorage.getItem('robloxUserId');
        if (myId && (userId === myId || userId === localStorage.getItem('robloxUsername'))) {
            window.history.replaceState({}, '', '/');
            showHomeContent();
        } else {
            showProfileOnly(userId);
        }
    }

    // Helper: show profile without registering/logging in
    window.showProfileOnly = function(userId) {
        database.ref('users/' + userId).once('value').then(snapshot => {
            if (snapshot.exists()) {
                updateProfileUI(snapshot.val());
                document.getElementById('home-content').style.display = 'block';
            } else {
                showNotification('User not found', 'error');
            }
        });
    };

    // View profile from search results
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-profile')) {
            const userId = e.target.dataset.id;
            loadUserData(userId);
            document.getElementById('search-results').style.display = 'none';
            showNotification('Loading profile...', 'info');
        }
    });

    // Initialize app state
    if (localStorage.getItem('newUser') === 'false') {
        showHomeContent();
    } else {
        localStorage.setItem('newUser', 'true');
        generateVerificationCode();
    }
});

// --- Messaging UI: Separate Send Button ---
function setupMessageSendButton() {
    const input = document.getElementById('message-input');
    let sendBtn = document.getElementById('send-message-btn');
    if (!sendBtn && input) {
        sendBtn = document.createElement('button');
        sendBtn.id = 'send-message-btn';
        sendBtn.textContent = 'Send';
        sendBtn.style.marginLeft = '10px';
        input.parentNode.parentNode.appendChild(sendBtn); // place outside input container
    }
    if (sendBtn) {
        sendBtn.onclick = () => {
            const txt = input.value.trim();
            if (!txt) return;
            const senderId = localStorage.getItem('robloxUserId');
            const receiverId = window.currentChatUserId;
            if (senderId && receiverId) sendMessage(senderId, receiverId, txt);
        };
    }
}

// --- Messaging: always clear previous chat and reset input ---
function openMessages(userId) {
    window.currentChatUserId = userId;
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) messagesContainer.innerHTML = '';
    const input = document.getElementById('message-input');
    if (input) input.value = '';
    document.getElementById('messages-list').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
    loadMessages(localStorage.getItem('robloxUserId'), userId);
    setupMessageSendButton();
}

// --- Notification system ---
let notifications = [], unreadNotifications = 0;
function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    if (!badge) return;
    const newCount = notifications.filter(n => !n.read).length;
    badge.textContent = newCount;
    badge.style.display = newCount > 0 ? 'flex' : 'none';
}
function addNotification(message, type = 'info', timestamp = Date.now()) {
    const notification = { id: Date.now(), message, type, timestamp, read: false };
    notifications.unshift(notification);
    updateNotificationBadge();
    renderNotifications();
    showNotification(message, type);
}
function renderNotifications() {
    const notificationList = document.getElementById('notification-list');
    if (!notificationList) return;
    notificationList.innerHTML = '';
    if (notifications.length === 0) {
        notificationList.innerHTML = '<div style="padding:15px;text-align:center;color:gray">No notifications yet</div>';
        return;
    }
    notifications.forEach(notification => {
        const notificationElement = document.createElement('div');
        notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
        notificationElement.innerHTML = `
            <div>${notification.message}</div>
            <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
        `;
        notificationElement.addEventListener('click', () => {
            if (!notification.read) {
                notification.read = true;
                updateNotificationBadge();
                notificationElement.classList.remove('unread');
            }
            // Open chat if notification is about a message
            const msgMatch = notification.message.match(/New message from (.+?)!/);
            if (msgMatch) {
                const username = msgMatch[1];
                // Find user by username and open chat
                database.ref('users').orderByChild('username').equalTo(username).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const userId = Object.keys(snapshot.val())[0];
                        openMessages(userId);
                    }
                });
            }
        });
        notificationList.appendChild(notificationElement);
    });
}
document.getElementById('notification-bell')?.addEventListener('click', (e) => {
    e.stopPropagation();
    const panel = document.getElementById('notification-panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    // Mark all as read when opening
    if (panel.style.display === 'block') {
        notifications.forEach(n => n.read = true);
        updateNotificationBadge();
        renderNotifications();
    }
});
document.addEventListener('click', (e) => {
    if (!e.target.closest('#notification-center')) {
        const panel = document.getElementById('notification-panel');
        if (panel) panel.style.display = 'none';
    }
});

// --- Style notification bell as square ---
// --- Style notification bell as square ---
(function squareBell(){
    const bell = document.getElementById('notification-bell');
    if(bell) {
        bell.style.borderRadius = '8px';
        bell.style.width = '40px';
        bell.style.height = '40px';
        bell.style.aspectRatio = '1/1';
        bell.style.padding = '0';
    }
})();

// --- END PATCHES ---
// Initialize all event listeners safely
addSafeEventListener('confirm-id', 'click', async () => {
    const userIdInput = getElementByIdSafe('roblox-id');
    if (!userIdInput) return;
    
    const userId = userIdInput.value.trim();
    if (!userId) {
        showNotification('Please enter a Roblox ID', 'error');
        return;
    }
    
    try {
        showNotification('Loading Roblox profile...', 'info');
        const [userData, headshotData] = await Promise.all([
            fetchRobloxData(`https://users.roblox.com/v1/users/${userId}`),
            fetchRobloxData(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png`)
        ]);
        
        if (userData.errors || headshotData.errors) throw new Error('User not found');
        
        const usernameElement = getElementByIdSafe('username');
        const descriptionElement = getElementByIdSafe('description');
        const headshotElement = getElementByIdSafe('headshot');
        
        if (usernameElement) usernameElement.textContent = userData.name;
        if (descriptionElement) descriptionElement.textContent = userData.description || '(No description)';
        if (headshotElement) headshotElement.src = headshotData.data[0].imageUrl;
        
        localStorage.setItem('tempUserId', userId);
        localStorage.setItem('tempUsername', userData.name);
        localStorage.setItem('tempHeadshot', headshotData.data[0].imageUrl);
        
        showStep('step2', 2);
        showNotification('Profile found! Is this you?', 'success');
    } catch(error) {
        showNotification("Couldn't find that user. Please check the ID", 'error');
    }
});

addSafeEventListener('yes-btn', 'click', () => {
    generateVerificationCode();
    showStep('step3', 3);
    showNotification('Verification code generated', 'info');
});

addSafeEventListener('no-btn', 'click', () => {
    showStep('step1', 1);
    showNotification('Please enter the correct Roblox ID', 'info');
});

addSafeEventListener('back-btn', 'click', () => {
    showStep('step2', 2);
});

addSafeEventListener('verify-btn', 'click', async () => {
    const userId = localStorage.getItem('tempUserId');
    const verificationCode = localStorage.getItem('verificationCode');
    
    try {
        showNotification('Verifying your profile...', 'info');
        const userData = await fetchRobloxData(`https://users.roblox.com/v1/users/${userId}`);
        
        if (userData.description && userData.description.includes(verificationCode)) {
            localStorage.setItem('newUser', 'false');
            localStorage.setItem('robloxUserId', userId);
            localStorage.setItem('robloxUsername', localStorage.getItem('tempUsername'));
            localStorage.setItem('robloxHeadshot', localStorage.getItem('tempHeadshot'));
            
            // Clear temp data
            ['tempUserId', 'tempUsername', 'tempHeadshot', 'verificationCode'].forEach(item => {
                localStorage.removeItem(item);
            });
            
            const statusElement = getElementByIdSafe('verification-status');
            if (statusElement) statusElement.textContent = 'Verification successful!';
            showNotification('Verification successful!', 'success');
            setTimeout(() => {
                showHomeContent();
            }, 1500);
        } else {
            const statusElement = getElementByIdSafe('verification-status');
            if (statusElement) statusElement.textContent = 'Code not found in description. Please try again.';
            showNotification('Verification failed - code not found', 'error');
        }
    } catch(error) {
        const statusElement = getElementByIdSafe('verification-status');
        if (statusElement) statusElement.textContent = 'Error verifying. Please try again.';
        showNotification('Error during verification', 'error');
    }
});

addSafeEventListener('go-home-btn', 'click', () => {
    showHomeContent();
});

addSafeEventListener('edit-btn', 'click', () => {
    const desc = getElementByIdSafe('profile-description');
    if (desc) {
        desc.contentEditable = true;
        desc.focus();
        getElementByIdSafe('edit-btn').style.display = 'none';
        getElementByIdSafe('save-btn').style.display = 'inline-block';
        showNotification('Editing description...', 'info');
    }
});

addSafeEventListener('save-btn', 'click', () => {
    const desc = getElementByIdSafe('profile-description');
    const userId = localStorage.getItem('robloxUserId');
    
    if (desc && userId) {
        const text = desc.textContent;
        desc.contentEditable = false;
        getElementByIdSafe('edit-btn').style.display = 'inline-block';
        getElementByIdSafe('save-btn').style.display = 'none';
        
        database.ref('users/' + userId).update({ description: text })
            .then(() => {
                showNotification('Description saved successfully!', 'success');
            })
            .catch(error => {
                console.error("Save error:", error);
                showNotification('Error saving description', 'error');
                if (getElementByIdSafe('edit-btn')) getElementByIdSafe('edit-btn').click();
            });
    }
});

addSafeEventListener('.copy-btn', 'click', () => {
    const codeTextElement = getElementByIdSafe('code-text');
    if (codeTextElement) {
        const code = codeTextElement.textContent;
        navigator.clipboard.writeText(code).then(() => {
            const copyBtn = document.querySelector('.copy-btn');
            if (copyBtn) {
                copyBtn.textContent = 'Copied!';
                showNotification('Code copied to clipboard', 'success');
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                }, 2000);
            }
        });
    }
});
