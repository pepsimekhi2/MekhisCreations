<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekhis Creations</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root{--primary:#4285F4;--secondary:#34A853;--accent:#EA4335;--text:#202124;--bg:#F8F9FA;--card-bg:#fff;--btn-text:#fff;--input-bg:#fff;--notification-success:#34A853;--notification-error:#EA4335;--notification-info:#4285F4;--theme-dark-text:#F8F9FA;--theme-dark-bg:#202124;--theme-dark-card:#303134;--crimson:#DC143C;--neon-primary:#00F0FF;--neon-secondary:#FF00F0;--neon-accent:#F0FF00;--gold:#FFD700;--silver:#C0C0C0;--bronze:#CD7F32}
        body{font-family:'Fredoka One',cursive;color:var(--text);margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;transition:all 0.3s;background:var(--bg)}
        .container{max-width:500px;width:100%;padding:20px;text-align:center;position:relative}
        .step{display:none}.active{display:block;animation:fadeIn 0.5s}
        .progress-bar{height:10px;background:rgba(0,0,0,0.1);border-radius:5px;margin:20px 0;overflow:hidden}
        .progress{height:100%;background:var(--secondary);width:0%;transition:width 0.5s}
        h1,h2{color:var(--primary);text-shadow:2px 2px 0 rgba(0,0,0,0.1)}
        button{font-family:'Fredoka One',cursive;background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:12px 24px;margin:5px;cursor:pointer;font-size:16px;transition:all 0.2s;box-shadow:0 4px 0 rgba(0,0,0,0.1);min-width:120px}
        button:hover{transform:translateY(-2px);box-shadow:0 6px 0 rgba(0,0,0,0.1)}
        button:active{transform:translateY(1px);box-shadow:0 2px 0 rgba(0,0,0,0.1)}
        #no-btn{background:var(--accent)}#yes-btn,#verify-btn{background:var(--secondary)}
        .back-btn{background:transparent;color:var(--accent);box-shadow:none;text-decoration:underline;padding:8px;min-width:auto}
        input{font-family:'Fredoka One',cursive;padding:12px;border:3px solid var(--primary);border-radius:50px;width:80%;text-align:center;font-size:16px;margin:15px 0;background:var(--input-bg)}
        #user-info{background:var(--card-bg);border-radius:20px;padding:20px;margin:20px 0;box-shadow:0 5px 15px rgba(0,0,0,0.05)}
        #headshot{width:150px;height:150px;border-radius:50%;object-fit:cover;border:5px solid var(--primary)}
        #username{font-size:24px;margin:10px 0;color:var(--primary)}#description{background:var(--bg);padding:15px;border-radius:10px;margin:10px 0}
        .code-container{display:flex;justify-content:center;gap:10px;margin:20px 0}
        #verification-code{font-size:32px;letter-spacing:5px;color:var(--secondary);background:var(--card-bg);padding:15px 20px;border-radius:10px;display:flex;align-items:center}
        .copy-btn{background:var(--primary);color:var(--btn-text);border:none;border-radius:50px;padding:5px 10px;font-size:12px;cursor:pointer;margin-left:10px}
        #verification-status{min-height:24px;color:var(--accent);margin-top:10px}
        .bounce{animation:bounce 0.5s infinite alternate}
        #home-content{display:none;text-align:center}
        #title-bar{font-size:28px;margin-bottom:10px}
        #divider{height:3px;background:var(--primary);border-radius:3px;width:80%;margin:0 auto 20px}
        #profile-container{background:var(--card-bg);border-radius:20px;padding:20px;margin:20px auto;max-width:400px;box-shadow:0 5px 15px rgba(0,0,0,0.05)}
        #profile-headshot{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--primary);margin-bottom:15px}
        #profile-username{font-size:22px;color:var(--primary);margin-bottom:15px}
        #profile-description{background:var(--bg);padding:15px;border-radius:10px;margin:15px 0;min-height:60px}
        #profile-stats{display:flex;justify-content:space-around;margin:15px 0}
        .stat-value{font-size:20px;font-weight:bold;color:var(--primary);cursor:pointer;transition:all 0.2s}
        .stat-value:hover{transform:scale(1.05);text-decoration:underline}
        .stat-label{font-size:14px;color:var(--text)}
        #edit-btn{background:var(--primary);margin-right:10px}#save-btn{background:var(--secondary);display:none}
        #follow-btn{background:var(--accent);display:none}
        #back-to-profile{background:var(--primary);display:none;margin-top:10px}
        .version{position:fixed;bottom:10px;left:10px;font-size:12px;opacity:0.7}
        .theme-btn{position:fixed;bottom:10px;right:10px;font-size:12px;padding:8px 12px}
        .theme-menu{position:fixed;bottom:40px;right:10px;background:var(--card-bg);border-radius:10px;padding:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:100;width:200px;display:none}
        .theme-menu.active{display:block}
        .theme-section{margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(0,0,0,0.1)}
        .theme-section-title{font-weight:bold;margin-bottom:5px;font-size:14px}
        .theme-option{padding:5px 10px;cursor:pointer;border-radius:5px;margin:2px 0;font-size:12px;text-align:center}
        .theme-option:hover{background:rgba(0,0,0,0.1)}.theme-option.selected{background:var(--primary);color:var(--btn-text)}
        #player-search{margin-top:20px;margin-bottom:20px}#search-input{width:60%;margin-right:10px}
        #search-results{display:none;margin-top:10px;background:var(--card-bg);border-radius:10px;padding:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .search-result{display:flex;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .search-result:hover{background:rgba(0,0,0,0.05)}
        .search-result:last-child{border-bottom:none}
        .search-result img{width:40px;height:40px;border-radius:50%;margin-right:10px;border:2px solid var(--primary)}
        .search-result button{margin-left:auto;padding:5px 10px;font-size:12px;min-width:auto}
        .notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:50px;color:white;font-weight:bold;box-shadow:0 3px 10px rgba(0,0,0,0.2);z-index:1000;animation:slideIn 0.3s,fadeOut 0.5s 2.5s forwards}
        .notification.success{background-color:var(--notification-success)}.notification.error{background-color:var(--notification-error)}.notification.info{background-color:var(--notification-info)}
        .followers-list, .following-list {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card-bg);border-radius:20px;padding:20px;width:80%;max-width:400px;max-height:80vh;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1000}
        .close-list{position:absolute;top:5px;right:5px;background:var(--accent);color:white;border:none;width:20px;height:20px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.2);border-radius:3px}
        .close-list:hover{transform:scale(1.1);background:#d32f2f}
        .list-title{margin-bottom:15px;color:var(--primary)}
        .list-item{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .list-item:hover{background:rgba(0,0,0,0.05)}
        .list-item:last-child{border-bottom:none}
        .list-item img{width:40px;height:40px;border-radius:50%;margin-right:10px}
        .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999}
        #notification-center{position:fixed;top:20px;right:20px;z-index:1000}
        #notification-bell{position:relative;background:var(--primary);color:white;border:none;width:40px;height:40px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);border-radius:3px}
        #notification-badge{position:absolute;top:-5px;right:-5px;background:var(--accent);color:white;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;border-radius:3px}
        #notification-panel{display:none;position:absolute;top:50px;right:0;background:var(--card-bg);border-radius:10px;width:300px;max-height:400px;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:1001}
        .notification-item{padding:12px;border-bottom:1px solid rgba(0,0,0,0.1);cursor:pointer}
        .notification-item:last-child{border-bottom:none}
        .notification-item:hover{background:rgba(0,0,0,0.05)}
        .notification-item.unread{background:rgba(66,133,244,0.1)}
        .notification-time{font-size:10px;color:gray;margin-top:5px}
        @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-5px)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{opacity:0;transform:translate(-50%,-30px)}to{opacity:1;transform:translate(-50%,0)}}
        @keyframes fadeOut{from{opacity:1}to{opacity:0}}
        body.default-theme{--primary:#4285F4;--secondary:#34A853;--accent:#EA4335;--text:#202124;--bg:#F8F9FA;--card-bg:#fff;--btn-text:#fff;--input-bg:#fff;--notification-success:#34A853;--notification-error:#EA4335;--notification-info:#4285F4}
        body.default-theme.dark-mode{--text:#F8F9FA;--bg:#202124;--card-bg:#303134}
        body.crimson-theme{--primary:#DC143C;--secondary:#8B0000;--accent:#FF6347;--notification-success:#2E8B57;--notification-error:#B22222;--notification-info:#4682B4}
        body.crimson-theme.dark-mode{--text:#F8F9FA;--bg:#1A1A1A;--card-bg:#2D2D2D}
        body.neon-theme{--primary:#00F0FF;--secondary:#FF00F0;--accent:#F0FF00;--notification-success:#00FF7F;--notification-error:#FF1493;--notification-info:#9370DB}
        body.neon-theme.dark-mode{--text:#FFFFFF;--bg:#0A0A0A;--card-bg:#1A1A1A}
        body.gold-theme{--primary:#FFD700;--secondary:#DAA520;--accent:#B8860B;--notification-success:#32CD32;--notification-error:#FF4500;--notification-info:#1E90FF}
        body.gold-theme.dark-mode{--text:#FFFAF0;--bg:#121212;--card-bg:#222222}
        body.silver-theme{--primary:#C0C0C0;--secondary:#A9A9A9;--accent:#808080;--notification-success:#20B2AA;--notification-error:#CD5C5C;--notification-info:#6495ED}
        body.silver-theme.dark-mode{--text:#F5F5F5;--bg:#181818;--card-bg:#282828}
        body.bronze-theme{--primary:#CD7F32;--secondary:#A0522D;--accent:#8B4513;--notification-success:#228B22;--notification-error:#8B0000;--notification-info:#4169E1}
        body.bronze-theme.dark-mode{--text:#FFF8DC;--bg:#1E1E1E;--card-bg:#2E2E2E}
    </style>
</head>
<body class="default-theme">
    <div class="version">Mekhis Creations v1.3</div>
    <button class="theme-btn" id="theme-btn">Themes</button>
    <div class="theme-menu" id="theme-menu">
        <div class="theme-section">
            <div class="theme-section-title">Color Themes</div>
            <div class="theme-option selected" data-theme="default">Default</div>
            <div class="theme-option" data-theme="crimson">Crimson</div>
            <div class="theme-option" data-theme="neon">Neon</div>
            <div class="theme-option" data-theme="gold">Gold</div>
            <div class="theme-option" data-theme="silver">Silver</div>
            <div class="theme-option" data-theme="bronze">Bronze</div>
        </div>
        <div class="theme-section">
            <div class="theme-section-title">Appearance</div>
            <div class="theme-option" data-mode="light">Light Mode</div>
            <div class="theme-option" data-mode="dark">Dark Mode</div>
        </div>
    </div>

    <!-- Notification Center -->
    <div id="notification-center">
        <button id="notification-bell">ðŸ””
            <div id="notification-badge" style="display:none">0</div>
        </button>
        <div id="notification-panel">
            <div class="notification-header" style="padding:10px;border-bottom:1px solid rgba(0,0,0,0.1);font-weight:bold">Notifications</div>
            <div id="notification-list" style="max-height:350px;overflow-y:auto"></div>
        </div>
    </div>

    <div class="container">
        <div id="main-app" class="step">
            <h1>Welcome to Mekhis Creations</h1>
            <div class="bounce">ðŸŽ‰</div>
            <p>You're all set! Enjoy the platform.</p>
            <button id="go-home-btn" style="margin-top:20px">Go to Home</button>
        </div>
        
        <div id="onboarding">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            
            <div id="step1" class="step active">
                <h1>Welcome to Mekhis Creations!</h1>
                <div class="bounce">ðŸ‘‹</div>
                <p>Let's get you set up!</p>
                <p>First, enter your Roblox User ID below:</p>
                <input type="text" id="roblox-id" placeholder="123456789">
                <button id="confirm-id">Let's Go!</button>
            </div>
            
            <div id="step2" class="step">
                <h2>Is this you?</h2>
                <div id="user-info">
                    <img id="headshot" src="" alt="Roblox avatar">
                    <div id="username"></div>
                    <div id="description"></div>
                </div>
                <button id="yes-btn">Yes, that's me!</button>
                <button id="no-btn">No, try again</button>
            </div>
            
            <div id="step3" class="step">
                <h2>Almost there!</h2>
                <p>Let's verify this is really you:</p>
                <ol style="text-align:left;display:inline-block">
                    <li>Copy this code</li>
                    <li>Paste it in your Roblox profile description</li>
                    <li>Click verify when done</li>
                </ol>
                <div class="code-container">
                    <div id="verification-code">
                        <span id="code-text"></span>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
                <div style="margin-top:15px">
                    <button id="verify-btn">Verify</button>
                    <button class="back-btn" id="back-btn">Back</button>
                </div>
                <div id="verification-status"></div>
            </div>
        </div>
        
        <div id="home-content">
            <div id="title-bar">Mekhis Creations</div>
            <div id="divider"></div>
            
            <div id="player-search">
                <input type="text" id="search-input" placeholder="Search players by username">
                <button id="search-btn">Search</button>
                <div id="search-results"></div>
            </div>
            
            <div id="profile-container">
                <img id="profile-headshot" src="" alt="Profile picture">
                <div id="profile-username"></div>
                <div id="profile-description">Loading description...</div>
                <div id="profile-stats">
                    <div>
                        <div class="stat-value" id="followers-count">0</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div>
                        <div class="stat-value" id="following-count">0</div>
                        <div class="stat-label">Following</div>
                    </div>
                </div>
                <div id="profile-actions">
                    <button id="edit-btn">Edit</button>
                    <button id="save-btn">Save</button>
                    <button id="follow-btn">Follow</button>
                </div>
                <button id="back-to-profile">Back to My Profile</button>
            </div>
            <div id="divider"></div>
        </div>
    </div>

    <!-- Followers/Following Lists -->
    <div class="overlay" id="overlay"></div>
    <div class="followers-list" id="followers-list">
        <button class="close-list" id="close-followers">Ã—</button>
        <h3 class="list-title">Followers</h3>
        <div id="followers-container"></div>
    </div>
    <div class="following-list" id="following-list">
        <button class="close-list" id="close-following">Ã—</button>
        <h3 class="list-title">Following</h3>
        <div id="following-container"></div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = { databaseURL: "https://cloud-fbd6b-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Helper functions
        const formatNumber = num => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        async function getRobloxUserData(userId) {
            try {
                showNotification('Fetching Roblox user data...', 'info');
                const corsProxy = 'https://corsproxy.io/?';
                const [userResponse, headshotResponse] = await Promise.all([
                    fetch(`${corsProxy}https://users.roblox.com/v1/users/${userId}`),
                    fetch(`${corsProxy}https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png`)
                ]);
                
                if (userResponse.ok && headshotResponse.ok) {
                    const [userData, headshotData] = await Promise.all([userResponse.json(), headshotResponse.json()]);
                    return {
                        username: userData.name || `User${userId}`,
                        description: userData.description || 'No description available',
                        headshot: headshotData.data[0]?.imageUrl
                    };
                }
            } catch (error) {
                console.log('API request failed, using fallback');
            }
            
            return {
                username: `User${userId}`,
                description: 'Verified Mekhis Creations user',
                headshot: `https://tr.rbxcdn.com/${userId}/150/150/AvatarHeadshot/Png`
            };
        }

        // Theme management
        function applyTheme(theme, mode) {
            document.body.classList.remove('default-theme', 'crimson-theme', 'neon-theme', 'gold-theme', 'silver-theme', 'bronze-theme', 'dark-mode');
            document.body.classList.add(`${theme}-theme`);
            if (mode === 'dark') document.body.classList.add('dark-mode');
            localStorage.setItem('selectedTheme', theme);
            localStorage.setItem('selectedMode', mode);
            updateThemeMenuSelection(theme, mode);
        }

        function updateThemeMenuSelection(theme, mode) {
            document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
                option.classList.toggle('selected', option.dataset.theme === theme);
            });
            document.querySelectorAll('.theme-option[data-mode]').forEach(option => {
                option.classList.toggle('selected', option.dataset.mode === mode);
            });
        }

        // Initialize theme
        applyTheme(localStorage.getItem('selectedTheme') || 'default', localStorage.getItem('selectedMode') || 'light');

        // Theme button events
        document.getElementById('theme-btn').addEventListener('click', () => {
            document.getElementById('theme-menu').classList.toggle('active');
        });

        document.querySelectorAll('.theme-option[data-theme]').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(option.dataset.theme, localStorage.getItem('selectedMode') || 'light');
            });
        });

        document.querySelectorAll('.theme-option[data-mode]').forEach(option => {
            option.addEventListener('click', () => {
                applyTheme(localStorage.getItem('selectedTheme') || 'default', option.dataset.mode);
            });
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.theme-btn') && !e.target.closest('.theme-menu')) {
                document.getElementById('theme-menu').classList.remove('active');
            }
        });

        // Notification Center
        let notifications = [];
        let unreadNotifications = 0;

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (unreadNotifications > 0) {
                badge.textContent = unreadNotifications;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function addNotification(message, type = 'info', timestamp = Date.now()) {
            const notification = {
                id: Date.now(),
                message,
                type,
                timestamp,
                read: false
            };
            notifications.unshift(notification);
            unreadNotifications++;
            updateNotificationBadge();
            renderNotifications();
            
            // Show popup notification
            showNotification(message, type);
        }

        function renderNotifications() {
            const notificationList = document.getElementById('notification-list');
            notificationList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div style="padding:15px;text-align:center;color:gray">No notifications yet</div>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationElement.innerHTML = `
                    <div>${notification.message}</div>
                    <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
                `;
                notificationElement.addEventListener('click', () => {
                    if (!notification.read) {
                        notification.read = true;
                        unreadNotifications--;
                        updateNotificationBadge();
                        notificationElement.classList.remove('unread');
                    }
                });
                notificationList.appendChild(notificationElement);
            });
        }

        // Notification center toggle
        document.getElementById('notification-bell').addEventListener('click', (e) => {
            e.stopPropagation();
            const panel = document.getElementById('notification-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#notification-center')) {
                document.getElementById('notification-panel').style.display = 'none';
            }
        });

        // Listen for new followers
        function setupNotificationListener(userId) {
            database.ref(`users/${userId}/followers`).on('child_added', (snapshot) => {
                const followerId = snapshot.key;
                database.ref(`users/${followerId}`).once('value').then(userSnapshot => {
                    if (userSnapshot.exists()) {
                        const user = userSnapshot.val();
                        addNotification(`${user.username} started following you!`, 'success');
                    }
                });
            });
        }

        // Player search functionality
        document.getElementById('search-btn').addEventListener('click', () => {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) return showNotification('Please enter a username to search', 'error');
            
            showNotification('Searching for players...', 'info');
            database.ref('users').once('value').then(snapshot => {
                const results = [];
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
                        results.push(user);
                    }
                });
                
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = '';
                
                if (results.length > 0) {
                    results.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'search-result';
                        userElement.innerHTML = `
                            <img src="${user.headshot}" width="50" height="50" style="border-radius:50%;margin-right:10px;">
                            <span>${user.username}</span>
                            <button class="view-profile" data-id="${user.userId}">View</button>
                        `;
                        resultsContainer.appendChild(userElement);
                    });
                    resultsContainer.style.display = 'block';
                    showNotification(`Found ${results.length} matching players`, 'success');
                } else {
                    resultsContainer.innerHTML = '<p>No players found matching your search</p>';
                    resultsContainer.style.display = 'block';
                    showNotification('No players found', 'error');
                }
            }).catch(error => {
                showNotification('Search failed', 'error');
                console.error('Search error:', error);
            });
        });

        // View profile from search results
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-profile') || e.target.closest('.list-item')) {
                const userId = e.target.classList.contains('view-profile') ? e.target.dataset.id : 
                              e.target.closest('.list-item').querySelector('button')?.dataset.id;
                if (userId) {
                    window.history.pushState({}, '', `/@${encodeURIComponent(userId)}`);
                    loadUserData(userId);
                    document.getElementById('search-results').style.display = 'none';
                    document.getElementById('overlay').style.display = 'none';
                    document.getElementById('followers-list').style.display = 'none';
                    document.getElementById('following-list').style.display = 'none';
                    showNotification('Loading profile...', 'info');
                }
            }
        });

        // Follow/unfollow functionality
        function toggleFollow(userId, isFollowing) {
            const currentUserId = localStorage.getItem('robloxUserId');
            if (!currentUserId) return showNotification('You need to be logged in to follow', 'error');
            
            // Prevent users from following themselves
            if (currentUserId === userId) {
                return showNotification("You can't follow yourself!", 'error');
            }
            
            const updates = {};
            updates[`users/${currentUserId}/following/${userId}`] = isFollowing ? null : true;
            updates[`users/${userId}/followers/${currentUserId}`] = isFollowing ? null : true;
            
            database.ref().update(updates)
                .then(() => {
                    showNotification(isFollowing ? 'Unfollowed successfully' : 'Followed successfully', 'success');
                    updateFollowButton(userId, !isFollowing);
                    updateStatsCounters(userId);
                })
                .catch(error => {
                    showNotification(`Error ${isFollowing ? 'unfollowing' : 'following'}`, 'error');
                    console.error('Follow error:', error);
                });
        }

        function updateFollowButton(userId, isFollowing) {
            const followBtn = document.getElementById('follow-btn');
            if (followBtn) {
                followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
                followBtn.style.backgroundColor = isFollowing ? 'var(--accent)' : 'var(--secondary)';
            }
        }

        function updateStatsCounters(userId) {
            database.ref(`users/${userId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
                    const followingCount = userData.following ? Object.keys(userData.following).length : 0;
                    
                    document.getElementById('followers-count').textContent = formatNumber(followersCount);
                    document.getElementById('following-count').textContent = formatNumber(followingCount);
                }
            });
        }

        // Show followers/following lists
        function showFollowersList(userId) {
            database.ref(`users/${userId}/followers`).once('value').then(snapshot => {
                const followersContainer = document.getElementById('followers-container');
                followersContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const followerIds = Object.keys(snapshot.val());
                    if (followerIds.length > 0) {
                        followerIds.forEach(followerId => {
                            database.ref(`users/${followerId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const followerElement = document.createElement('div');
                                    followerElement.className = 'list-item';
                                    followerElement.innerHTML = `
                                        <img src="${user.headshot}" alt="${user.username}">
                                        <span>${user.username}</span>
                                        <button class="view-profile" data-id="${user.userId}">View</button>
                                    `;
                                    followersContainer.appendChild(followerElement);
                                }
                            });
                        });
                    } else {
                        followersContainer.innerHTML = '<p>No followers yet</p>';
                    }
                } else {
                    followersContainer.innerHTML = '<p>No followers yet</p>';
                }
                
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('followers-list').style.display = 'block';
            });
        }

        function showFollowingList(userId) {
            database.ref(`users/${userId}/following`).once('value').then(snapshot => {
                const followingContainer = document.getElementById('following-container');
                followingContainer.innerHTML = '';
                
                if (snapshot.exists() && snapshot.val()) {
                    const followingIds = Object.keys(snapshot.val());
                    if (followingIds.length > 0) {
                        followingIds.forEach(followingId => {
                            database.ref(`users/${followingId}`).once('value').then(userSnapshot => {
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    const followingElement = document.createElement('div');
                                    followingElement.className = 'list-item';
                                    followingElement.innerHTML = `
                                        <img src="${user.headshot}" alt="${user.username}">
                                        <span>${user.username}</span>
                                        <button class="view-profile" data-id="${user.userId}">View</button>
                                    `;
                                    followingContainer.appendChild(followingElement);
                                }
                            });
                        });
                    } else {
                        followingContainer.innerHTML = '<p>Not following anyone yet</p>';
                    }
                } else {
                    followingContainer.innerHTML = '<p>Not following anyone yet</p>';
                }
                
                document.getElementById('overlay').style.display = 'block';
                document.getElementById('following-list').style.display = 'block';
            });
        }

        // Close list modals
        document.getElementById('close-followers').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('followers-list').style.display = 'none';
        });

        document.getElementById('close-following').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('following-list').style.display = 'none';
        });

        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('followers-list').style.display = 'none';
            document.getElementById('following-list').style.display = 'none';
        });

        // Back to profile button
        document.getElementById('back-to-profile').addEventListener('click', () => {
            const userId = localStorage.getItem('robloxUserId');
            if (userId) {
                window.history.pushState({}, '', '/');
                loadUserData(userId);
            }
        });

        // Onboarding flow functions
        function updateProgress(step) {
            const progressBar = document.getElementById('progress');
            if (progressBar) progressBar.style.width = step * 33.33 + '%';
        }

        function showStep(stepId, progressStep) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
                updateProgress(progressStep);
            }
        }

        function generateVerificationCode() {
            const codeTextElement = document.getElementById('code-text');
            if (codeTextElement) {
                const code = Math.floor(10000 + 90000 * Math.random());
                codeTextElement.textContent = code;
                localStorage.setItem('verificationCode', code.toString());
                return code;
            }
            return null;
        }

        function showHomeContent() {
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('home-content').style.display = 'block';
            
            const path = window.location.pathname;
            if (path.startsWith('/@')) {
                const username = decodeURIComponent(path.substring(2));
                searchUserByUsername(username);
            } else {
                const userId = localStorage.getItem('robloxUserId');
                if (userId) loadUserData(userId);
            }
        }

        async function searchUserByUsername(username) {
            try {
                const snapshot = await database.ref('users').once('value');
                let foundUser = null;
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    if (user.username.toLowerCase() === username.toLowerCase()) {
                        foundUser = user;
                    }
                });
                
                if (foundUser) {
                    loadUserData(foundUser.userId, false);
                } else {
                    showNotification('User not found', 'error');
                    window.history.pushState({}, '', '/');
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            } catch (error) {
                console.error('Search error:', error);
                showNotification('Error searching for user', 'error');
            }
        }

        function loadUserData(userId, isCurrentUser = null) {
            if (isCurrentUser === null) {
                isCurrentUser = userId === localStorage.getItem('robloxUserId');
            }
            
            database.ref('users/' + userId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    updateProfileUI(userData, isCurrentUser);
                    showNotification('Profile loaded successfully', 'success');
                    
                    if (!isCurrentUser && localStorage.getItem('robloxUserId')) {
                        const currentUserId = localStorage.getItem('robloxUserId');
                        database.ref(`users/${currentUserId}/following/${userId}`).once('value').then(followSnapshot => {
                            updateFollowButton(userId, followSnapshot.exists());
                        });
                    }
                } else if (isCurrentUser) {
                    createNewUser(userId);
                } else {
                    showNotification('Profile not found', 'error');
                    window.history.pushState({}, '', '/');
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            }).catch(error => {
                console.error("Database error:", error);
                showNotification('Error loading profile', 'error');
            });
        }

        function createNewUser(userId) {
            const userData = {
                userId: userId,
                username: localStorage.getItem('robloxUsername') || `User${userId.slice(0, 4)}`,
                headshot: localStorage.getItem('robloxHeadshot') || `https://www.roblox.com/headshot-thumbnail/image?userId=${userId}&width=150&height=150&format=png`,
                description: "",
                followers: {},
                following: {},
                createdAt: Date.now()
            };
            
            database.ref('users/' + userId).set(userData)
                .then(() => {
                    updateProfileUI(userData, true);
                    setupNotificationListener(userId);
                })
                .catch(error => {
                    console.error("Create user error:", error);
                    showNotification('Error creating profile', 'error');
                });
        }

        function updateProfileUI(userData, isCurrentUser) {
            document.getElementById('profile-headshot').src = userData.headshot;
            document.getElementById('profile-username').textContent = userData.username;
            document.getElementById('profile-description').textContent = userData.description || 'No description yet';
            
            const followersCount = userData.followers ? Object.keys(userData.followers).length : 0;
            const followingCount = userData.following ? Object.keys(userData.following).length : 0;
            document.getElementById('followers-count').textContent = formatNumber(followersCount);
            document.getElementById('following-count').textContent = formatNumber(followingCount);
            
            document.getElementById('followers-count').onclick = () => showFollowersList(userData.userId);
            document.getElementById('following-count').onclick = () => showFollowingList(userData.userId);
            
            document.getElementById('edit-btn').style.display = isCurrentUser ? 'inline-block' : 'none';
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('follow-btn').style.display = isCurrentUser ? 'none' : 'inline-block';
            document.getElementById('back-to-profile').style.display = isCurrentUser ? 'none' : 'block';
            document.getElementById('profile-description').contentEditable = false;
            
            if (!isCurrentUser) {
                document.getElementById('follow-btn').onclick = () => {
                    const currentUserId = localStorage.getItem('robloxUserId');
                    if (!currentUserId) return showNotification('You need to be logged in to follow', 'error');
                    
                    database.ref(`users/${currentUserId}/following/${userData.userId}`).once('value').then(snapshot => {
                        toggleFollow(userData.userId, snapshot.exists());
                    });
                };
            }
            
            if (isCurrentUser && !window.location.pathname.startsWith('/@')) {
                window.history.pushState({}, '', `/@${encodeURIComponent(userData.username)}`);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Confirm ID button
            document.getElementById('confirm-id')?.addEventListener('click', async () => {
                const userId = document.getElementById('roblox-id').value.trim();
                if (!userId) return showNotification('Please enter a Roblox ID', 'error');
                
                try {
                    showNotification('Loading Roblox profile...', 'info');
                    const userData = await getRobloxUserData(userId);
                    
                    document.getElementById('username').textContent = userData.username;
                    document.getElementById('description').textContent = userData.description || '(No description)';
                    document.getElementById('headshot').src = userData.headshot;
                    
                    localStorage.setItem('tempUserId', userId);
                    localStorage.setItem('tempUsername', userData.username);
                    localStorage.setItem('tempHeadshot', userData.headshot);
                    
                    showStep('step2', 2);
                    showNotification('Profile found! Is this you?', 'success');
                } catch(error) {
                    showNotification("Couldn't find that user. Please check the ID", 'error');
                }
            });

            // Other buttons
            document.getElementById('yes-btn')?.addEventListener('click', () => {
                generateVerificationCode();
                showStep('step3', 3);
                showNotification('Verification code generated', 'info');
            });

            document.getElementById('no-btn')?.addEventListener('click', () => {
                showStep('step1', 1);
                showNotification('Please enter the correct Roblox ID', 'info');
            });

            document.getElementById('back-btn')?.addEventListener('click', () => {
                showStep('step2', 2);
            });

            document.getElementById('verify-btn')?.addEventListener('click', async () => {
                const userId = localStorage.getItem('tempUserId');
                localStorage.setItem('newUser', 'false');
                localStorage.setItem('robloxUserId', userId);
                localStorage.setItem('robloxUsername', localStorage.getItem('tempUsername'));
                localStorage.setItem('robloxHeadshot', localStorage.getItem('tempHeadshot'));
                
                ['tempUserId', 'tempUsername', 'tempHeadshot', 'verificationCode'].forEach(item => {
                    localStorage.removeItem(item);
                });
                
                document.getElementById('verification-status').textContent = 'Verification successful!';
                showNotification('Verification successful!', 'success');
                setTimeout(showHomeContent, 1500);
            });

            document.getElementById('go-home-btn')?.addEventListener('click', showHomeContent);

            // Edit profile
            document.getElementById('edit-btn')?.addEventListener('click', () => {
                const desc = document.getElementById('profile-description');
                desc.contentEditable = true;
                desc.focus();
                document.getElementById('edit-btn').style.display = 'none';
                document.getElementById('save-btn').style.display = 'inline-block';
                showNotification('Editing description...', 'info');
            });

            document.getElementById('save-btn')?.addEventListener('click', () => {
                const desc = document.getElementById('profile-description');
                const userId = localStorage.getItem('robloxUserId');
                const text = desc.textContent;
                desc.contentEditable = false;
                document.getElementById('edit-btn').style.display = 'inline-block';
                document.getElementById('save-btn').style.display = 'none';
                
                database.ref('users/' + userId).update({ description: text })
                    .then(() => showNotification('Description saved successfully!', 'success'))
                    .catch(error => {
                        console.error("Save error:", error);
                        showNotification('Error saving description', 'error');
                    });
            });

            // Copy verification code
            document.querySelector('.copy-btn')?.addEventListener('click', () => {
                const code = document.getElementById('code-text').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    document.querySelector('.copy-btn').textContent = 'Copied!';
                    showNotification('Code copied to clipboard', 'success');
                    setTimeout(() => {
                        document.querySelector('.copy-btn').textContent = 'Copy';
                    }, 2000);
                });
            });

            // Handle back/forward navigation
            window.addEventListener('popstate', () => {
                const path = window.location.pathname;
                if (path.startsWith('/@')) {
                    const username = decodeURIComponent(path.substring(2));
                    searchUserByUsername(username);
                } else {
                    loadUserData(localStorage.getItem('robloxUserId'));
                }
            });

            // Initialize app state
            if (localStorage.getItem('newUser') === 'false') {
                showHomeContent();
                const userId = localStorage.getItem('robloxUserId');
                if (userId) setupNotificationListener(userId);
            } else {
                localStorage.setItem('newUser', 'true');
                generateVerificationCode();
            }
        });
    </script>
</body>
</html>
