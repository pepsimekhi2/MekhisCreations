<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Analytics - Mekhis Creations</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --blue: #3b82f6;
            --blue-dark: #2563eb;
            --blue-glow: rgba(59, 130, 246, 0.4);
            --bg: #07090f;
            --card: rgba(59, 130, 246, 0.07);
            --card-border: rgba(59, 130, 246, 0.18);
            --text: #e8eaf0;
            --text-muted: rgba(232, 234, 240, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* Animated grid background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(59,130,246,0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59,130,246,0.04) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
            pointer-events: none;
        }

        /* Glow orbs */
        body::after {
            content: '';
            position: fixed;
            top: -200px;
            left: -200px;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(59,130,246,0.12) 0%, transparent 70%);
            z-index: 0;
            pointer-events: none;
            animation: orbFloat 8s ease-in-out infinite;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(80px, 60px); }
        }

        header {
            position: relative;
            z-index: 10;
            padding: 32px 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--card-border);
            background: rgba(7, 9, 15, 0.8);
            backdrop-filter: blur(20px);
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--blue);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 0 20px var(--blue-glow);
        }

        h1 {
            font-family: 'Fredoka One', sans-serif;
            font-size: 1.9em;
            color: white;
            letter-spacing: 0.5px;
        }

        .tagline {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85em;
            color: #10b981;
            font-weight: 700;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 0 8px #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        main {
            position: relative;
            z-index: 5;
            padding: 48px;
            max-width: 1500px;
            margin: 0 auto;
        }

        /* Top stats row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 28px 24px;
            backdrop-filter: blur(10px);
            transition: border-color 0.3s, transform 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--blue), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover { transform: translateY(-3px); border-color: rgba(59,130,246,0.4); }
        .stat-card:hover::before { opacity: 1; }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Fredoka One', sans-serif;
            font-size: 2.6em;
            color: white;
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-value.blue { color: var(--blue); }

        .stat-sub {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Main grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 36px;
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-family: 'Fredoka One', sans-serif;
            font-size: 1.4em;
            color: white;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title-icon {
            width: 32px;
            height: 32px;
            background: rgba(59,130,246,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
        }

        .chart-wrap {
            position: relative;
            height: 380px;
        }

        /* Top 10 list */
        .rank-list { display: flex; flex-direction: column; gap: 10px; }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: rgba(59,130,246,0.06);
            border: 1px solid rgba(59,130,246,0.12);
            border-radius: 12px;
            transition: all 0.25s;
            cursor: default;
        }

        .rank-item:hover {
            background: rgba(59,130,246,0.12);
            border-color: rgba(59,130,246,0.3);
            transform: translateX(4px);
        }

        .rank-num {
            font-family: 'Fredoka One', sans-serif;
            font-size: 1.1em;
            min-width: 36px;
            text-align: center;
            color: var(--text-muted);
        }

        .rank-1 .rank-num { color: #ffd700; }
        .rank-2 .rank-num { color: #c0c0c0; }
        .rank-3 .rank-num { color: #cd7f32; }

        .rank-info { flex: 1; }
        .rank-name { color: white; font-weight: 700; font-size: 0.95em; }
        .rank-pct { font-size: 0.78em; color: var(--text-muted); margin-top: 2px; }

        .rank-bar-wrap {
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .rank-count {
            font-family: 'Fredoka One', sans-serif;
            font-size: 1em;
            color: var(--blue);
        }

        .rank-mini-bar {
            width: 100%;
            height: 4px;
            background: rgba(59,130,246,0.15);
            border-radius: 2px;
            overflow: hidden;
        }

        .rank-mini-fill {
            height: 100%;
            background: var(--blue);
            border-radius: 2px;
            transition: width 0.8s ease;
        }

        /* Block grid */
        .blocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .block-card {
            background: rgba(59,130,246,0.06);
            border: 1px solid rgba(59,130,246,0.15);
            border-radius: 14px;
            padding: 22px 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .block-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: var(--blue);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s;
        }

        .block-card:hover {
            transform: translateY(-4px);
            border-color: rgba(59,130,246,0.35);
            box-shadow: 0 8px 30px rgba(59,130,246,0.15);
        }

        .block-card:hover::after { transform: scaleX(1); }

        .block-rank {
            position: absolute;
            top: 12px;
            right: 14px;
            font-size: 0.7em;
            color: var(--text-muted);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .block-name {
            font-weight: 700;
            color: white;
            font-size: 1em;
            margin-bottom: 10px;
            padding-right: 30px;
        }

        .block-count {
            font-family: 'Fredoka One', sans-serif;
            font-size: 2.2em;
            color: var(--blue);
            line-height: 1;
            margin-bottom: 6px;
        }

        .block-pct {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 14px;
        }

        .block-bar {
            width: 100%;
            height: 6px;
            background: rgba(59,130,246,0.12);
            border-radius: 3px;
            overflow: hidden;
        }

        .block-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        /* Loading / empty states */
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            font-size: 1em;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59,130,246,0.2);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 1100px) {
            .main-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            header { padding: 20px 24px; }
            main { padding: 24px; }
            .stats-row { grid-template-columns: 1fr 1fr; gap: 12px; }
            h1 { font-size: 1.4em; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-area">
            <div class="logo-icon">üß±</div>
            <div>
                <h1>Block Analytics</h1>
                <div class="tagline">Mekhis Creations ¬∑ Real-time Stats</div>
            </div>
        </div>
        <div class="live-badge">
            <div class="live-dot"></div>
            LIVE
        </div>
    </header>

    <main>
        <!-- Summary stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Total Spawns</div>
                <div class="stat-value" id="totalSpawns">‚Äî</div>
                <div class="stat-sub">all time</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unique Blocks</div>
                <div class="stat-value blue" id="uniqueBlocks">‚Äî</div>
                <div class="stat-sub">block types</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Per Type</div>
                <div class="stat-value" id="avgSpawns">‚Äî</div>
                <div class="stat-sub">spawns per block</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Top Block</div>
                <div class="stat-value blue" id="topBlockName" style="font-size:1.2em; margin-top:6px;">‚Äî</div>
                <div class="stat-sub" id="topBlockCount"></div>
            </div>
        </div>

        <!-- Chart + Top 10 -->
        <div class="main-grid">
            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">ü•ß</div>
                    Block Distribution
                </div>
                <div class="chart-wrap">
                    <canvas id="blockChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <div class="card-title-icon">üèÜ</div>
                    Top 10 Blocks
                </div>
                <div class="rank-list" id="rankList">
                    <div class="empty"><div class="spinner"></div>Loading...</div>
                </div>
            </div>
        </div>

        <!-- Full block breakdown -->
        <div class="card">
            <div class="card-title">
                <div class="card-title-icon">üì¶</div>
                All Blocks
            </div>
            <div class="blocks-grid" id="blocksGrid">
                <div class="empty"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
    </main>

    <script>
        const FIREBASE_URL = 'https://block-cl-f30cf-default-rtdb.firebaseio.com';
        let blockData = {};
        let blockChart = null;

        const COLORS = [
            '#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981',
            '#06b6d4','#f97316','#6366f1','#14b8a6','#d946ef',
            '#eab308','#64748b','#0891b2','#7c3aed','#dc2626',
            '#84cc16','#f43f5e','#a78bfa','#34d399','#fb923c'
        ];

        async function fetchBlockData() {
            try {
                const response = await fetch(`${FIREBASE_URL}/blocks.json`);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (!data) { showEmpty(); return; }

                // ‚úÖ FIX: data is an object of { uniqueId: { blockName, blockValue } }
                // We iterate over each entry's value and tally by blockName
                blockData = {};
                Object.values(data).forEach(entry => {
                    if (entry && entry.blockName) {
                        const name = entry.blockName;
                        blockData[name] = (blockData[name] || 0) + 1;
                    }
                });

                render();
            } catch (err) {
                console.error('Firebase fetch error:', err);
                document.getElementById('blocksGrid').innerHTML =
                    `<div class="empty">‚ö†Ô∏è Failed to load data.<br><small>${err.message}</small></div>`;
            }
        }

        function render() {
            const sorted = Object.entries(blockData).sort((a, b) => b[1] - a[1]);
            const total  = sorted.reduce((s, [,c]) => s + c, 0);
            const unique = sorted.length;

            // Summary cards
            animateNumber('totalSpawns', total);
            document.getElementById('uniqueBlocks').textContent = unique;
            document.getElementById('avgSpawns').textContent = unique ? Math.round(total / unique).toLocaleString() : '0';
            if (sorted.length) {
                document.getElementById('topBlockName').textContent = sorted[0][0];
                document.getElementById('topBlockCount').textContent = sorted[0][1].toLocaleString() + ' spawns';
            }

            renderChart(sorted, total);
            renderRankList(sorted, total);
            renderBlocksGrid(sorted, total);
        }

        function renderChart(sorted, total) {
            const top = sorted.slice(0, 14);
            const labels = top.map(d => d[0]);
            const counts = top.map(d => d[1]);
            const colors = top.map((_, i) => COLORS[i % COLORS.length]);

            if (blockChart) blockChart.destroy();

            blockChart = new Chart(document.getElementById('blockChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: '#07090f',
                        borderWidth: 3,
                        hoverBorderColor: 'rgba(255,255,255,0.3)',
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '62%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(232,234,240,0.7)',
                                font: { family: "'Nunito', sans-serif", size: 11, weight: '700' },
                                padding: 14,
                                usePointStyle: true,
                                pointStyleWidth: 8
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                    return `  ${ctx.label}: ${ctx.parsed.toLocaleString()} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderRankList(sorted, total) {
            const top10 = sorted.slice(0, 10);
            const maxCount = top10[0]?.[1] || 1;
            const medals = ['ü•á','ü•à','ü•â'];

            const html = top10.map(([name, count], i) => {
                const pct = ((count / total) * 100).toFixed(1);
                const barW = ((count / maxCount) * 100).toFixed(1);
                const label = i < 3 ? medals[i] : `#${i+1}`;
                return `
                    <div class="rank-item rank-${i+1}">
                        <div class="rank-num">${label}</div>
                        <div class="rank-info">
                            <div class="rank-name">${name}</div>
                            <div class="rank-pct">${pct}% of total</div>
                        </div>
                        <div class="rank-bar-wrap">
                            <div class="rank-count">${count.toLocaleString()}</div>
                            <div class="rank-mini-bar">
                                <div class="rank-mini-fill" style="width:${barW}%"></div>
                            </div>
                        </div>
                    </div>`;
            }).join('');

            document.getElementById('rankList').innerHTML = html || '<div class="empty">No data yet</div>';
        }

        function renderBlocksGrid(sorted, total) {
            if (!sorted.length) {
                document.getElementById('blocksGrid').innerHTML = '<div class="empty">No block data found</div>';
                return;
            }

            const maxCount = sorted[0][1];

            const html = sorted.map(([name, count], i) => {
                const pct = ((count / total) * 100).toFixed(1);
                const barW = ((count / maxCount) * 100).toFixed(1);
                const color = COLORS[i % COLORS.length];
                return `
                    <div class="block-card">
                        <div class="block-rank">#${i+1}</div>
                        <div class="block-name">${name}</div>
                        <div class="block-count">${count.toLocaleString()}</div>
                        <div class="block-pct">${pct}% of spawns</div>
                        <div class="block-bar">
                            <div class="block-bar-fill" style="width:${barW}%; background:${color}"></div>
                        </div>
                    </div>`;
            }).join('');

            document.getElementById('blocksGrid').innerHTML = html;
        }

        function animateNumber(id, target) {
            const el = document.getElementById(id);
            const duration = 1200;
            const steps = 60;
            const step = target / steps;
            let current = 0;
            const interval = setInterval(() => {
                current = Math.min(current + step, target);
                el.textContent = Math.round(current).toLocaleString();
                if (current >= target) clearInterval(interval);
            }, duration / steps);
        }

        function showEmpty() {
            document.getElementById('blocksGrid').innerHTML = '<div class="empty">No data in Firebase yet</div>';
            document.getElementById('rankList').innerHTML = '<div class="empty">No data yet</div>';
        }

        // Fetch on load, refresh every 30 seconds
        fetchBlockData();
        setInterval(fetchBlockData, 30000);
    </script>
</body>
</html>
